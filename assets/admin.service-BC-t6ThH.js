import{s as p,a as _}from"./index-gWDCgl8b.js";import"./charts-CKULyBNE.js";import"./vendor-C1760L19.js";import"./pdf-IUycIs1B.js";const c=p||_;async function C(){try{const[e,t,r,s]=await Promise.all([c.from("profiles").select("id",{count:"exact",head:!0}).eq("role","parent"),c.from("children").select("id",{count:"exact",head:!0}),c.from("purchases").select("amount, status"),c.from("progress").select("id",{count:"exact",head:!0})]),a=r.data||[],n=a.filter(u=>u.status==="completed"||u.status==="success").reduce((u,o)=>u+(Number(o.amount)||0),0),i=a.filter(u=>u.status==="failed").length;return{data:{totalFamilies:e.count||0,totalChildren:t.count||0,totalRevenue:n,totalPurchases:a.length,failedPayments:i,chaptersCompleted:s.count||0},error:null}}catch(e){return{data:null,error:e}}}async function x(e=7){try{const t=new Date(Date.now()-e*864e5).toISOString(),{data:r,error:s}=await c.from("purchases").select("amount, created_at").in("status",["completed","success"]).gte("created_at",t);if(s)return{data:null,error:s};const a={};return(r||[]).forEach(n=>{const i=n.created_at.slice(0,10);a[i]=(a[i]||0)+(Number(n.amount)||0)}),{data:a,error:null}}catch(t){return{data:null,error:t}}}async function q(e=7){try{const t=new Date(Date.now()-e*864e5).toISOString(),{data:r,error:s}=await c.from("purchases").select("created_at").in("status",["completed","success"]).gte("created_at",t);if(s)return{data:null,error:s};const a={};return(r||[]).forEach(n=>{const i=n.created_at.slice(0,10);a[i]=(a[i]||0)+1}),{data:a,error:null}}catch(t){return{data:null,error:t}}}async function b(){try{const[e,t]=await Promise.all([c.from("courses").select("id, title, chapter_count"),c.from("progress").select("course_id, child_id, chapter_index")]);if(e.error)return{data:null,error:e.error};const r={},s={};return(t.data||[]).forEach(n=>{r[n.course_id]||(r[n.course_id]=new Set),r[n.course_id].add(n.child_id),s[n.course_id]=(s[n.course_id]||0)+1}),{data:(e.data||[]).map(n=>{const i=r[n.id]?.size||0,u=s[n.id]||0,o=i*(n.chapter_count||8);return{courseId:n.id,title:n.title,students:i,completionPct:o>0?Math.round(u/o*100):0}}),error:null}}catch(e){return{data:null,error:e}}}async function k({page:e=1,pageSize:t=20,search:r="",status:s=""}={}){try{let a=c.from("profiles").select("id, name, email, created_at, active, children(id, name, age)",{count:"exact"}).eq("role","parent").order("created_at",{ascending:!1}).range((e-1)*t,e*t-1);r&&(a=a.or(`name.ilike.%${r}%,email.ilike.%${r}%`)),s==="active"?a=a.eq("active",!0):s==="inactive"&&(a=a.eq("active",!1));const{data:n,error:i,count:u}=await a;return{data:n,error:i,count:u}}catch(a){return{data:null,error:a,count:0}}}async function P({page:e=1,pageSize:t=20,search:r="",status:s=""}={}){try{let a=c.from("purchases").select("*, profiles!purchases_user_id_fkey(name, email)",{count:"exact"}).order("created_at",{ascending:!1}).range((e-1)*t,e*t-1);s&&(a=a.eq("status",s)),r&&(a=a.or(`profiles.name.ilike.%${r}%,profiles.email.ilike.%${r}%`));const{data:n,error:i,count:u}=await a;return{data:n,error:i,count:u}}catch(a){return{data:null,error:a,count:0}}}async function S({page:e=1,pageSize:t=20,search:r=""}={}){try{let s=c.from("children").select("*, profiles!children_parent_id_fkey(name, email), progress(course_id, chapter_index, completed_at)",{count:"exact"}).order("created_at",{ascending:!1}).range((e-1)*t,e*t-1);r&&(s=s.ilike("name",`%${r}%`));const{data:a,error:n,count:i}=await s;return{data:a,error:n,count:i}}catch(s){return{data:null,error:s,count:0}}}async function E({page:e=1,pageSize:t=20,search:r="",role:s=""}={}){try{let a=c.from("profiles").select("*, children:children!parent_id(id, name, age)",{count:"exact"}).order("created_at",{ascending:!1}).range((e-1)*t,e*t-1);r&&(a=a.or(`name.ilike.%${r}%,email.ilike.%${r}%`)),s&&(a=a.eq("role",s));const{data:n,error:i,count:u}=await a;return{data:n,error:i,count:u}}catch(a){return{data:null,error:a,count:0}}}async function A(){try{const[e,t,r]=await Promise.all([c.from("courses").select("*"),c.from("purchases").select("course_id, amount, status"),c.from("progress").select("course_id, child_id, chapter_index")]);return{data:(e.data||[]).map(a=>{const n=(t.data||[]).filter(l=>l.course_id===a.id&&(l.status==="completed"||l.status==="success")),i=(r.data||[]).filter(l=>l.course_id===a.id),u=new Set(i.map(l=>l.child_id)),o=u.size*(a.chapter_count||8);return{...a,students:u.size,revenue:n.reduce((l,f)=>l+(Number(f.amount)||0),0),chaptersDone:i.length,completionPct:o>0?Math.round(i.length/o*100):0}}),error:null}}catch(e){return{data:null,error:e}}}async function D(e,t,r=""){try{const{data:s}=await _.auth.getUser(),{data:a,error:n}=await c.from("course_access").insert({user_id:e,course_id:t,granted_by:s?.user?.id||null,reason:r,active:!0}).select().single();return n||await c.from("admin_events").insert({event_type:"course_access_granted",data:{userId:e,courseId:t,reason:r}}),{data:a,error:n}}catch(s){return{data:null,error:s}}}async function O(e){try{const{data:t,error:r}=await c.from("course_access").update({active:!1,revoked_at:new Date().toISOString()}).eq("id",e).select().single();return{data:t,error:r}}catch(t){return{data:null,error:t}}}async function j(e){try{let t=c.from("course_access").select("*, profiles!course_access_user_id_fkey(name, email)").order("granted_at",{ascending:!1});e&&(t=t.eq("course_id",e));const{data:r,error:s}=await t;return{data:r,error:s}}catch(t){return{data:null,error:t}}}async function $(e){try{if(!["profiles","children","purchases","progress","course_access","coupons"].includes(e))return{data:null,error:new Error("Invalid table")};const{data:r,error:s}=await c.from(e).select("*");if(s)return{data:null,error:s};if(!r||r.length===0)return{data:"",error:null};const a=Object.keys(r[0]),n=r.map(i=>a.map(u=>{const o=i[u],l=o===null?"":typeof o=="object"?JSON.stringify(o):String(o);return l.includes(",")||l.includes('"')?`"${l.replace(/"/g,'""')}"`:l}).join(","));return{data:[a.join(","),...n].join(`
`),error:null}}catch(t){return{data:null,error:t}}}async function I(e){try{const{data:t,error:r}=await c.from("profiles").insert({name:e.name,email:e.email,role:e.role||"parent",active:!0}).select().single();return r||await c.from("admin_events").insert({event_type:"user_created",data:{userId:t.id,email:e.email}}),{data:t,error:r}}catch(t){return{data:null,error:t}}}async function U(e,t){try{const{data:r,error:s}=await c.from("profiles").update(t).eq("id",e).select().single();return{data:r,error:s}}catch(r){return{data:null,error:r}}}async function M(e){try{await c.from("children").delete().eq("parent_id",e);const{error:t}=await c.from("profiles").delete().eq("id",e);return t||await c.from("admin_events").insert({event_type:"user_deleted",data:{userId:e}}),{data:!t,error:t}}catch(t){return{data:null,error:t}}}async function N(){try{const[e,t,r]=await Promise.all([c.from("progress").select("course_id, child_id, chapter_index"),c.from("purchases").select("course_id, status, created_at"),c.from("courses").select("id, title, chapter_count")]),s=Object.fromEntries((r.data||[]).map(o=>[o.id,o])),a=e.data||[],n={};a.forEach(o=>{n[o.course_id]||(n[o.course_id]=new Set),n[o.course_id].add(o.child_id)});const i=Object.entries(n).map(([o,l])=>({courseId:o,title:s[o]?.title,students:l.size})).sort((o,l)=>l.students-o.students),u=(r.data||[]).map(o=>{const l=a.filter(d=>d.course_id===o.id),f=new Set(l.map(d=>d.child_id)).size,m={};l.forEach(d=>{m[d.child_id]=Math.max(m[d.child_id]||0,d.chapter_index)});const h=Object.values(m).filter(d=>d>=(o.chapter_count||8)-1).length;return{courseId:o.id,title:o.title,started:f,completed:h}});return{data:{popularCourses:i,completionFunnel:u},error:null}}catch(e){return{data:null,error:e}}}async function B(e,t={}){try{const{data:r,error:s}=await c.from("admin_events").insert({event_type:e,data:t}).select().single();return{data:r,error:s}}catch(r){return{data:null,error:r}}}async function R(){try{const{data:e,error:t}=await c.from("children").select("*, profiles!children_parent_id_fkey(name, email), progress(course_id, chapter_index, completed_at)").order("created_at",{ascending:!1});return{data:e,error:t}}catch(e){return{data:null,error:e}}}export{I as createUser,M as deleteUser,$ as exportCSV,j as getAccessLog,C as getAdminStats,N as getAnalytics,j as getCourseAccessLog,b as getCourseCompletion,A as getCourseOverview,A as getCourses,q as getEnrollmentChart,k as getEnrollments,q as getEnrollmentsByDay,P as getPayments,x as getRevenueByDay,x as getRevenueChart,C as getStats,R as getStudentProgress,S as getStudents,E as getUsers,D as grantAccess,D as grantCourseAccess,B as logEvent,O as revokeAccess,O as revokeCourseAccess,U as updateUser};
