import{s as o}from"./index-QdcRCwwA.js";import"./charts-BoanjVzx.js";import"./vendor-BeqUCTS1.js";import"./pdf-S5HbmSVd.js";async function w(){try{const[e,t,r,a]=await Promise.all([o.from("profiles").select("id",{count:"exact",head:!0}).eq("role","parent"),o.from("children").select("id",{count:"exact",head:!0}),o.from("purchases").select("amount, status"),o.from("progress").select("id",{count:"exact",head:!0})]),c=r.data||[],s=c.filter(i=>i.status==="completed").reduce((i,n)=>i+(Number(n.amount)||0),0),u=c.filter(i=>i.status==="failed").length;return{data:{totalFamilies:e.count||0,totalChildren:t.count||0,totalRevenue:s,totalPurchases:c.length,failedPayments:u,chaptersCompleted:a.count||0},error:null}}catch(e){return{data:null,error:e}}}async function x(e=7){try{const t=new Date(Date.now()-e*864e5).toISOString(),{data:r,error:a}=await o.from("purchases").select("amount, created_at").eq("status","completed").gte("created_at",t);if(a)return{data:null,error:a};const c={};return(r||[]).forEach(s=>{const u=s.created_at.slice(0,10);c[u]=(c[u]||0)+(Number(s.amount)||0)}),{data:c,error:null}}catch(t){return{data:null,error:t}}}async function C(e=7){try{const t=new Date(Date.now()-e*864e5).toISOString(),{data:r,error:a}=await o.from("purchases").select("created_at").eq("status","completed").gte("created_at",t);if(a)return{data:null,error:a};const c={};return(r||[]).forEach(s=>{const u=s.created_at.slice(0,10);c[u]=(c[u]||0)+1}),{data:c,error:null}}catch(t){return{data:null,error:t}}}async function P(){try{const[e,t]=await Promise.all([o.from("courses").select("id, title, chapter_count"),o.from("progress").select("course_id, child_id, chapter_index")]);if(e.error)return{data:null,error:e.error};const r={},a={};return(t.data||[]).forEach(s=>{r[s.course_id]||(r[s.course_id]=new Set),r[s.course_id].add(s.child_id),a[s.course_id]=(a[s.course_id]||0)+1}),{data:(e.data||[]).map(s=>{const u=r[s.id]?.size||0,i=a[s.id]||0,n=u*(s.chapter_count||8);return{courseId:s.id,title:s.title,students:u,completionPct:n>0?Math.round(i/n*100):0}}),error:null}}catch(e){return{data:null,error:e}}}async function v({page:e=1,pageSize:t=20,search:r=""}={}){try{let a=o.from("profiles").select("id, name, email, created_at, children(id, name, age)",{count:"exact"}).eq("role","parent").order("created_at",{ascending:!1}).range((e-1)*t,e*t-1);r&&(a=a.or(`name.ilike.%${r}%,email.ilike.%${r}%`));const{data:c,error:s,count:u}=await a;return{data:c,error:s,count:u}}catch(a){return{data:null,error:a,count:0}}}async function D({page:e=1,pageSize:t=20,status:r=""}={}){try{let a=o.from("purchases").select("*, profiles(name, email)",{count:"exact"}).order("created_at",{ascending:!1}).range((e-1)*t,e*t-1);r&&(a=a.eq("status",r));const{data:c,error:s,count:u}=await a;return{data:c,error:s,count:u}}catch(a){return{data:null,error:a,count:0}}}async function b(){try{const[e,t,r]=await Promise.all([o.from("courses").select("*"),o.from("purchases").select("course_id, amount, status"),o.from("progress").select("course_id, child_id, chapter_index")]);return{data:(e.data||[]).map(c=>{const s=(t.data||[]).filter(l=>l.course_id===c.id&&l.status==="completed"),u=(r.data||[]).filter(l=>l.course_id===c.id),i=new Set(u.map(l=>l.child_id)),n=i.size*(c.chapter_count||8);return{...c,students:i.size,revenue:s.reduce((l,m)=>l+(Number(m.amount)||0),0),chaptersDone:u.length,completionPct:n>0?Math.round(u.length/n*100):0}}),error:null}}catch(e){return{data:null,error:e}}}async function S(){try{const{data:e,error:t}=await o.from("children").select("*, profiles(name, email), progress(course_id, chapter_index, completed_at)").order("created_at",{ascending:!1});return{data:e,error:t}}catch(e){return{data:null,error:e}}}async function E(e,t,r=""){try{const{data:a,error:c}=await o.from("course_access").insert({user_id:e,course_id:t,granted_by:(await o.auth.getUser()).data.user?.id,reason:r}).select().single();return{data:a,error:c}}catch(a){return{data:null,error:a}}}async function q(e){try{const{data:t,error:r}=await o.from("course_access").update({active:!1,revoked_at:new Date().toISOString()}).eq("id",e).select().single();return{data:t,error:r}}catch(t){return{data:null,error:t}}}async function I({page:e=1,pageSize:t=20}={}){try{const{data:r,error:a,count:c}=await o.from("course_access").select("*, profiles!course_access_user_id_fkey(name, email)",{count:"exact"}).order("granted_at",{ascending:!1}).range((e-1)*t,e*t-1);return{data:r,error:a,count:c}}catch(r){return{data:null,error:r,count:0}}}async function O(){try{const[e,t,r]=await Promise.all([o.from("progress").select("course_id, child_id, chapter_index"),o.from("purchases").select("course_id, status, created_at"),o.from("courses").select("id, title, chapter_count")]),a=Object.fromEntries((r.data||[]).map(n=>[n.id,n])),c=e.data||[],s={};c.forEach(n=>{s[n.course_id]||(s[n.course_id]=new Set),s[n.course_id].add(n.child_id)});const u=Object.entries(s).map(([n,l])=>({courseId:n,title:a[n]?.title,students:l.size})).sort((n,l)=>l.students-n.students),i=(r.data||[]).map(n=>{const l=c.filter(d=>d.course_id===n.id),m=new Set(l.map(d=>d.child_id)).size,f={};l.forEach(d=>{f[d.child_id]=Math.max(f[d.child_id]||0,d.chapter_index)});const h=Object.values(f).filter(d=>d>=(n.chapter_count||8)-1).length;return{courseId:n.id,title:n.title,started:m,completed:h}});return{data:{popularCourses:u,completionFunnel:i},error:null}}catch(e){return{data:null,error:e}}}async function k(e){try{if(!["profiles","children","purchases","progress","course_access","coupons"].includes(e))return{data:null,error:new Error("Invalid table")};const{data:r,error:a}=await o.from(e).select("*");return{data:r,error:a}}catch(t){return{data:null,error:t}}}async function A(e,t={}){try{const{data:r,error:a}=await o.from("admin_events").insert({event_type:e,data:t}).select().single();return{data:r,error:a}}catch(r){return{data:null,error:r}}}export{k as exportCSV,O as getAnalytics,I as getCourseAccessLog,P as getCourseCompletion,b as getCourseOverview,v as getEnrollments,C as getEnrollmentsByDay,D as getPayments,x as getRevenueByDay,w as getStats,S as getStudentProgress,E as grantCourseAccess,A as logEvent,q as revokeCourseAccess};
