import{s as u}from"./index-QdcRCwwA.js";import"./charts-BoanjVzx.js";import"./vendor-BeqUCTS1.js";import"./pdf-S5HbmSVd.js";async function g({page:t=1,pageSize:r=20,search:e="",status:o=""}={}){try{let n=u.from("coupons").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range((t-1)*r,t*r-1);e&&(n=n.ilike("code",`%${e}%`)),o==="active"?n=n.eq("active",!0).gt("expires_at",new Date().toISOString()):o==="expired"?n=n.lt("expires_at",new Date().toISOString()):o==="depleted"&&(n=n.filter("current_uses","gte","max_uses"));const{data:c,error:a,count:s}=await n;return{data:c,error:a,count:s}}catch(n){return{data:null,error:n,count:0}}}async function v({code:t,courseId:r,type:e,value:o,maxUses:n=1,expiresAt:c}){try{const a=(await u.auth.getUser()).data.user,{data:s,error:i}=await u.from("coupons").insert({code:t.toUpperCase(),course_id:r||null,type:e,value:o,max_uses:n,expires_at:c||null,created_by:a?.id}).select().single();return{data:s,error:i}}catch(a){return{data:null,error:a}}}async function y({prefix:t,count:r,courseId:e,type:o,value:n,maxUses:c=1,expiresAt:a}){try{const s=(await u.auth.getUser()).data.user,i=Array.from({length:r},()=>({code:`${t.toUpperCase()}-${Math.random().toString(36).substring(2,8).toUpperCase()}`,course_id:e||null,type:o,value:n,max_uses:c,expires_at:a||null,created_by:s?.id})),{data:l,error:d}=await u.from("coupons").insert(i).select();return{data:l,error:d}}catch(s){return{data:null,error:s}}}async function w(t){try{const{data:r,error:e}=await u.from("coupons").update({active:!1}).eq("id",t).select().single();return{data:r,error:e}}catch(r){return{data:null,error:r}}}async function x(t,r=null){try{const{data:e,error:o}=await u.from("coupons").select("*").eq("code",t.toUpperCase()).single();return o||!e?{valid:!1,coupon:null,discount:0,error:"Coupon not found"}:e.active?e.expires_at&&new Date(e.expires_at)<new Date?{valid:!1,coupon:e,discount:0,error:"Coupon has expired"}:e.current_uses>=e.max_uses?{valid:!1,coupon:e,discount:0,error:"Coupon usage limit reached"}:e.course_id&&r&&e.course_id!==r?{valid:!1,coupon:e,discount:0,error:"Coupon not valid for this course"}:{valid:!0,coupon:e,discount:e.value,error:null}:{valid:!1,coupon:e,discount:0,error:"Coupon is inactive"}}catch(e){return{valid:!1,coupon:null,discount:0,error:e.message}}}async function C(t){try{const{data:r}=await u.from("coupons").select("current_uses").eq("id",t).single(),{data:e,error:o}=await u.from("coupons").update({current_uses:(r?.current_uses||0)+1}).eq("id",t).select().single();return{data:e,error:o}}catch(r){return{data:null,error:r}}}async function h(){try{const{data:t,error:r}=await u.from("coupons").select("*");if(r)return{data:null,error:r};const e=new Date,o=t.filter(a=>a.active&&(!a.expires_at||new Date(a.expires_at)>e)&&a.current_uses<a.max_uses).length,n=t.reduce((a,s)=>a+(s.current_uses||0),0),c=t.reduce((a,s)=>a+(s.current_uses||0)*(Number(s.value)||0),0);return{data:{active:o,totalRedeemed:n,revenueImpact:c},error:null}}catch(t){return{data:null,error:t}}}export{C as applyCoupon,v as createCoupon,w as deactivateCoupon,y as generateBulkCoupons,h as getCouponStats,g as getCoupons,x as validateCoupon};
