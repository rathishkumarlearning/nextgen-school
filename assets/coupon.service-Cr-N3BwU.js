import{s as f,a as l}from"./index-gWDCgl8b.js";import"./charts-CKULyBNE.js";import"./vendor-C1760L19.js";import"./pdf-IUycIs1B.js";const c=f||l;async function g(){try{const{data:t,error:n}=await c.from("coupons").select("*");if(n)return{data:null,error:n};const e=new Date,a=t.filter(o=>o.active&&(!o.expires_at||new Date(o.expires_at)>e)&&o.current_uses<o.max_uses).length,r=t.reduce((o,s)=>o+(s.current_uses||0),0),u=t.reduce((o,s)=>o+(s.current_uses||0)*(Number(s.value)||0),0);return{data:{active:a,totalRedeemed:r,revenueImpact:u,totalCoupons:t.length},error:null}}catch(t){return{data:null,error:t}}}async function h({page:t=1,pageSize:n=20,search:e="",status:a=""}={}){try{let r=c.from("coupons").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range((t-1)*n,t*n-1);e&&(r=r.ilike("code",`%${e}%`)),a==="active"?r=r.eq("active",!0):a==="inactive"?r=r.eq("active",!1):a==="expired"?r=r.lt("expires_at",new Date().toISOString()):a==="depleted"&&(r=r.filter("current_uses","gte","max_uses"));const{data:u,error:o,count:s}=await r;return{data:u,error:o,count:s}}catch(r){return{data:null,error:r,count:0}}}async function x({code:t,courseId:n,type:e,value:a,maxUses:r=1,expiresAt:u}){try{const{data:o}=await l.auth.getUser(),{data:s,error:i}=await c.from("coupons").insert({code:t.toUpperCase(),course_id:n||null,type:e,value:a,max_uses:r,current_uses:0,active:!0,expires_at:u||null,created_by:o?.user?.id||null}).select().single();return{data:s,error:i}}catch(o){return{data:null,error:o}}}async function q({prefix:t,count:n,courseId:e,type:a,value:r,maxUses:u=1,expiresAt:o}){try{const{data:s}=await l.auth.getUser(),i=Array.from({length:n},()=>({code:`${t.toUpperCase()}-${Math.random().toString(36).substring(2,8).toUpperCase()}`,course_id:e||null,type:a,value:r,max_uses:u,current_uses:0,active:!0,expires_at:o||null,created_by:s?.user?.id||null})),{data:d,error:p}=await c.from("coupons").insert(i).select();return{data:d,error:p}}catch(s){return{data:null,error:s}}}async function m(t,n){try{const{data:e,error:a}=await c.from("coupons").update(n).eq("id",t).select().single();return{data:e,error:a}}catch(e){return{data:null,error:e}}}async function b(t){return m(t,{active:!1})}async function U(t){try{const{error:n}=await c.from("coupons").delete().eq("id",t);return{data:!n,error:n}}catch(n){return{data:null,error:n}}}async function _(t,n=null){try{const{data:e,error:a}=await c.from("coupons").select("*").eq("code",t.toUpperCase()).single();return a||!e?{valid:!1,coupon:null,discount:0,error:"Coupon not found"}:e.active?e.expires_at&&new Date(e.expires_at)<new Date?{valid:!1,coupon:e,discount:0,error:"Coupon has expired"}:e.current_uses>=e.max_uses?{valid:!1,coupon:e,discount:0,error:"Coupon usage limit reached"}:e.course_id&&n&&!e.course_id.split(",").map(u=>u.trim()).includes(n)?{valid:!1,coupon:e,discount:0,error:"Coupon not valid for this course"}:{valid:!0,coupon:e,discount:e.value,error:null}:{valid:!1,coupon:e,discount:0,error:"Coupon is inactive"}}catch(e){return{valid:!1,coupon:null,discount:0,error:e.message}}}async function D(t,n,e){try{const a=await _(t,e);if(!a.valid)return{data:null,error:a.error};const r=a.coupon,{error:u}=await c.from("coupons").update({current_uses:(r.current_uses||0)+1}).eq("id",r.id);return u?{data:null,error:u}:(await c.from("admin_events").insert({event_type:"coupon_redeemed",data:{couponId:r.id,code:r.code,userId:n,courseId:e,discount:r.value}}),{data:{coupon:r,discount:r.value},error:null})}catch(a){return{data:null,error:a}}}async function k(t){try{const{data:n}=await c.from("coupons").select("current_uses").eq("id",t).single(),{data:e,error:a}=await c.from("coupons").update({current_uses:(n?.current_uses||0)+1}).eq("id",t).select().single();return{data:e,error:a}}catch(n){return{data:null,error:n}}}export{k as applyCoupon,q as bulkGenerateCoupons,x as createCoupon,b as deactivateCoupon,U as deleteCoupon,q as generateBulkCoupons,g as getCouponStats,h as getCoupons,D as redeemCoupon,m as updateCoupon,_ as validateCoupon};
