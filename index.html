<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NextGen School ‚Äî Mind Over Machines: AI Literacy for Kids</title>
<meta name="description" content="A futuristic school raising children for the AI age. Critical thinking, robotics, space exploration ‚Äî for ages 9-13.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#050510;--bg2:#0a0a2e;--bg3:#0f0f3a;
--red:#ef4444;--gold:#fbbf24;--cyan:#06b6d4;--purple:#8b5cf6;--green:#22c55e;--blue:#3b82f6;--pink:#ec4899;--orange:#f97316;
--text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;
--glass:rgba(255,255,255,0.05);--glass2:rgba(255,255,255,0.08);--glass-border:rgba(255,255,255,0.1);
}
html{scroll-behavior:smooth}
body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;line-height:1.6;min-height:100vh}
h1,h2,h3,h4,h5{font-family:'Fredoka',sans-serif;font-weight:600}
canvas#starfield{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}
.container{max-width:1200px;margin:0 auto;padding:0 20px;position:relative;z-index:1}

/* Glass cards */
.glass{background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:8px;padding:14px 32px;border-radius:50px;font-family:'Fredoka',sans-serif;font-size:1.05rem;font-weight:600;border:none;cursor:pointer;transition:all .3s;text-decoration:none;color:#fff}
.btn-primary{background:linear-gradient(135deg,var(--cyan),var(--purple));box-shadow:0 4px 20px rgba(6,182,212,0.3)}
.btn-primary:hover{transform:translateY(-2px) scale(1.02);box-shadow:0 8px 30px rgba(6,182,212,0.5)}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--orange));color:#000;box-shadow:0 4px 20px rgba(251,191,36,0.3)}
.btn-back{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);padding:10px 20px;font-size:.9rem;border-radius:12px}
.btn-back:hover{background:rgba(255,255,255,0.15)}

/* ===== HERO SECTION ===== */
#hero{min-height:100vh;display:flex;align-items:center;justify-content:center;text-align:center;padding:40px 20px;position:relative;z-index:1}
.hero-content h1{font-size:clamp(2.2rem,6vw,4.5rem);background:linear-gradient(135deg,var(--cyan),var(--purple),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:16px;line-height:1.15}
.hero-content p{font-size:clamp(1rem,2.5vw,1.3rem);color:var(--text2);max-width:650px;margin:0 auto 30px}
.hero-badges{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-bottom:30px}
.hero-badge{background:var(--glass);border:1px solid var(--glass-border);border-radius:50px;padding:8px 18px;font-size:.85rem;color:var(--text2)}
.hero-badge span{margin-right:4px}

/* ===== COURSE SELECTION ===== */
#courses{padding:60px 0 80px;position:relative;z-index:1}
#courses h2{text-align:center;font-size:clamp(1.8rem,4vw,2.8rem);margin-bottom:12px;color:var(--text)}
#courses .subtitle{text-align:center;color:var(--text2);margin-bottom:50px;font-size:1.1rem}
.courses-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;max-width:1000px;margin:0 auto}
.course-card{padding:36px 28px;text-align:center;cursor:pointer;transition:all .4s;position:relative;overflow:hidden}
.course-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;border-radius:20px 20px 0 0}
.course-card[data-course="ai"]::before{background:linear-gradient(90deg,var(--cyan),var(--blue))}
.course-card[data-course="space"]::before{background:linear-gradient(90deg,var(--purple),var(--pink))}
.course-card[data-course="robotics"]::before{background:linear-gradient(90deg,var(--green),var(--cyan))}
.course-card:hover{transform:translateY(-8px) scale(1.02);border-color:rgba(255,255,255,0.2);box-shadow:0 20px 60px rgba(0,0,0,0.4)}
.course-card .emoji{font-size:4rem;margin-bottom:16px;display:block}
.course-card h3{font-size:1.5rem;margin-bottom:8px}
.course-card p{color:var(--text2);font-size:.95rem;margin-bottom:16px}
.course-card .chapters-count{font-size:.85rem;color:var(--text3);background:rgba(255,255,255,0.05);padding:6px 14px;border-radius:20px;display:inline-block}

/* ===== PRINCIPLES ===== */
#principles{padding:60px 0;position:relative;z-index:1}
#principles h2{text-align:center;font-size:clamp(1.6rem,3.5vw,2.4rem);margin-bottom:40px}
.principles-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;max-width:900px;margin:0 auto}
.principle-card{padding:28px 20px;text-align:center}
.principle-card .emoji{font-size:2.5rem;margin-bottom:12px;display:block}
.principle-card h4{font-size:1.1rem;margin-bottom:6px}
.principle-card p{color:var(--text2);font-size:.85rem}

/* ===== COURSE VIEW ===== */
#course-view{display:none;min-height:100vh;position:relative;z-index:1}
.course-header{padding:20px;display:flex;align-items:center;gap:16px;border-bottom:1px solid var(--glass-border);background:rgba(5,5,16,0.9);backdrop-filter:blur(10px);position:sticky;top:0;z-index:100}
.course-header h2{font-size:1.2rem;flex:1}
.progress-bar{height:6px;background:rgba(255,255,255,0.1);border-radius:10px;flex:1;max-width:200px;overflow:hidden}
.progress-fill{height:100%;border-radius:10px;transition:width .5s;background:linear-gradient(90deg,var(--cyan),var(--purple))}
.progress-text{font-size:.8rem;color:var(--text2);min-width:40px;text-align:right}
.points-display{background:linear-gradient(135deg,var(--gold),var(--orange));color:#000;font-weight:700;padding:4px 14px;border-radius:20px;font-size:.85rem;font-family:'Fredoka',sans-serif}

.course-body{display:flex;min-height:calc(100vh - 70px)}

/* Sidebar */
.chapter-sidebar{width:280px;min-width:280px;background:rgba(10,10,46,0.95);border-right:1px solid var(--glass-border);padding:20px 12px;overflow-y:auto;height:calc(100vh - 70px);position:sticky;top:70px}
.chapter-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;cursor:pointer;transition:all .2s;margin-bottom:4px;font-size:.9rem}
.chapter-item:hover{background:rgba(255,255,255,0.06)}
.chapter-item.active{background:rgba(6,182,212,0.15);border:1px solid rgba(6,182,212,0.3)}
.chapter-item.completed{opacity:.7}
.chapter-item .ch-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;background:rgba(255,255,255,0.1);flex-shrink:0}
.chapter-item.completed .ch-num{background:var(--green);color:#000}
.chapter-item.active .ch-num{background:var(--cyan);color:#000}
.chapter-item .ch-title{flex:1;line-height:1.3}

/* Lesson Area */
.lesson-area{flex:1;padding:40px;overflow-y:auto;max-width:900px}
.lesson-area h2{font-size:clamp(1.5rem,3vw,2.2rem);margin-bottom:8px}
.lesson-area .lesson-desc{color:var(--text2);font-size:1.05rem;margin-bottom:30px;line-height:1.7}

/* Interactive Activity Container */
.activity{margin:30px 0;padding:30px;border-radius:20px;background:rgba(255,255,255,0.03);border:1px solid var(--glass-border)}
.activity h3{font-size:1.2rem;margin-bottom:6px;color:var(--cyan)}
.activity .instructions{color:var(--text2);margin-bottom:20px;font-size:.95rem}

/* Drag and Drop */
.drag-zone{display:flex;flex-wrap:wrap;gap:10px;min-height:60px;padding:16px;border-radius:14px;border:2px dashed rgba(255,255,255,0.15);margin:10px 0;transition:all .3s;justify-content:center}
.drag-zone.over{border-color:var(--cyan);background:rgba(6,182,212,0.08)}
.drag-zone.correct{border-color:var(--green);background:rgba(34,197,94,0.08)}
.drag-zone.wrong{border-color:var(--red);background:rgba(239,68,68,0.08)}
.drag-zone-label{width:100%;text-align:center;font-size:.85rem;color:var(--text3);margin-bottom:4px;font-weight:600;pointer-events:none}

.drag-item{padding:10px 18px;border-radius:12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);cursor:grab;transition:all .2s;font-size:.9rem;user-select:none;touch-action:none;position:relative}
.drag-item:active{cursor:grabbing;transform:scale(1.05);z-index:999}
.drag-item.correct-item{background:rgba(34,197,94,0.2);border-color:var(--green)}
.drag-item.wrong-item{background:rgba(239,68,68,0.2);border-color:var(--red);animation:shake .4s}
.drag-item.placed{opacity:.5;pointer-events:none}

@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}

/* Drop Buckets */
.buckets{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:20px 0}
.bucket{min-height:120px;padding:16px;border-radius:16px;border:2px dashed rgba(255,255,255,0.12);text-align:center;transition:all .3s}
.bucket.over{transform:scale(1.02)}
.bucket h4{font-size:1rem;margin-bottom:10px;pointer-events:none}
.bucket-items{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;min-height:40px}

/* Sequence Builder */
.sequence-slots{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:16px 0}
.sequence-slot{width:140px;height:50px;border:2px dashed rgba(255,255,255,0.15);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:.8rem;color:var(--text3);transition:all .3s;position:relative}
.sequence-slot::after{content:'‚Üí';position:absolute;right:-14px;color:var(--text3);font-size:1.2rem}
.sequence-slot:last-child::after{display:none}
.sequence-slot.over{border-color:var(--cyan);background:rgba(6,182,212,0.1)}
.sequence-slot.filled{border-style:solid;border-color:var(--cyan);background:rgba(6,182,212,0.1)}

/* Interactive Scene */
.scene-container{position:relative;width:100%;aspect-ratio:16/10;background:rgba(0,0,0,0.3);border-radius:16px;overflow:hidden;margin:16px 0}
.scene-item{position:absolute;cursor:pointer;font-size:2.2rem;transition:all .3s;filter:drop-shadow(0 0 8px rgba(6,182,212,0.3))}
.scene-item:hover{transform:scale(1.2);filter:drop-shadow(0 0 16px rgba(6,182,212,0.6))}
.scene-item.discovered{filter:drop-shadow(0 0 16px rgba(34,197,94,0.6))}
.scene-popup{position:absolute;background:rgba(10,10,46,0.95);backdrop-filter:blur(10px);border:1px solid var(--cyan);border-radius:12px;padding:16px;max-width:250px;font-size:.85rem;z-index:10;opacity:0;pointer-events:none;transition:opacity .3s}
.scene-popup.show{opacity:1;pointer-events:auto}
.scene-popup h5{color:var(--cyan);margin-bottom:4px}

/* Flowchart / Block Builder */
.block-palette{display:flex;flex-wrap:wrap;gap:8px;padding:16px;background:rgba(0,0,0,0.2);border-radius:12px;margin:10px 0}
.block{padding:10px 16px;border-radius:10px;cursor:grab;font-size:.85rem;font-weight:600;user-select:none;touch-action:none;display:inline-flex;align-items:center;gap:6px}
.block-if{background:rgba(251,191,36,0.2);border:2px solid var(--gold);color:var(--gold)}
.block-then{background:rgba(34,197,94,0.2);border:2px solid var(--green);color:var(--green)}
.block-else{background:rgba(239,68,68,0.2);border:2px solid var(--red);color:var(--red)}
.block-action{background:rgba(6,182,212,0.2);border:2px solid var(--cyan);color:var(--cyan)}
.block-sensor{background:rgba(139,92,246,0.2);border:2px solid var(--purple);color:var(--purple)}

.flowchart-area{min-height:150px;padding:20px;border:2px dashed rgba(255,255,255,0.12);border-radius:14px;margin:10px 0;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center}
.flowchart-area .arrow{color:var(--text3);font-size:1.5rem}

/* Cards */
.card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin:16px 0}
.flip-card{perspective:1000px;height:200px;cursor:pointer}
.flip-card-inner{position:relative;width:100%;height:100%;transition:transform .6s;transform-style:preserve-3d}
.flip-card.flipped .flip-card-inner{transform:rotateY(180deg)}
.flip-card-front,.flip-card-back{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;text-align:center}
.flip-card-front{background:var(--glass2);border:1px solid var(--glass-border)}
.flip-card-back{background:rgba(6,182,212,0.1);border:1px solid var(--cyan);transform:rotateY(180deg)}
.flip-card-front .emoji{font-size:3rem;margin-bottom:8px}
.flip-card-front h4{font-size:.95rem}
.flip-card-back p{font-size:.8rem;color:var(--text2)}
.flip-card-back h5{color:var(--cyan);margin-bottom:6px;font-size:.9rem}

/* Choice Cards */
.choice-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:16px 0}
.choice-card{padding:20px;border-radius:14px;background:var(--glass);border:2px solid var(--glass-border);cursor:pointer;text-align:center;transition:all .3s}
.choice-card:hover{border-color:var(--cyan);transform:translateY(-3px)}
.choice-card.selected{border-color:var(--cyan);background:rgba(6,182,212,0.1)}
.choice-card.correct{border-color:var(--green);background:rgba(34,197,94,0.1)}
.choice-card.wrong{border-color:var(--red);background:rgba(239,68,68,0.1)}
.choice-card .emoji{font-size:2rem;margin-bottom:8px;display:block}

/* Grid / Maze */
.maze-grid{display:grid;gap:2px;margin:16px auto;width:fit-content}
.maze-cell{width:40px;height:40px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;transition:all .2s}
.maze-wall{background:rgba(255,255,255,0.15)}
.maze-path{background:rgba(255,255,255,0.03)}
.maze-robot{background:rgba(6,182,212,0.3);border:1px solid var(--cyan)}
.maze-goal{background:rgba(34,197,94,0.2);border:1px solid var(--green)}
.command-builder{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0;justify-content:center}
.cmd-block{padding:10px 14px;border-radius:10px;background:rgba(139,92,246,0.2);border:2px solid var(--purple);cursor:pointer;font-size:1.2rem;transition:all .2s;user-select:none}
.cmd-block:hover{transform:scale(1.1)}
.cmd-block:active{transform:scale(.95)}
.command-sequence{display:flex;flex-wrap:wrap;gap:6px;padding:14px;min-height:50px;border:2px dashed rgba(255,255,255,0.12);border-radius:12px;margin:10px 0;align-items:center;justify-content:center}
.cmd-placed{padding:6px 10px;border-radius:8px;background:rgba(139,92,246,0.15);border:1px solid var(--purple);font-size:1rem;cursor:pointer}

/* Mission Planner / Weight */
.cargo-bay{padding:20px;border:2px solid var(--glass-border);border-radius:16px;min-height:120px;margin:10px 0;background:rgba(0,0,0,0.2)}
.weight-bar{height:12px;background:rgba(255,255,255,0.1);border-radius:10px;margin:10px 0;overflow:hidden;position:relative}
.weight-fill{height:100%;border-radius:10px;transition:width .4s}
.weight-label{display:flex;justify-content:space-between;font-size:.85rem;color:var(--text2)}

/* Rocket Builder */
.rocket-frame{width:120px;margin:20px auto;position:relative;min-height:300px}
.rocket-slot{width:100%;min-height:50px;border:2px dashed rgba(255,255,255,0.15);border-radius:8px;margin:4px 0;display:flex;align-items:center;justify-content:center;font-size:.8rem;color:var(--text3);transition:all .3s}
.rocket-slot.filled{border-style:solid;border-color:var(--cyan);background:rgba(6,182,212,0.1)}

/* Slider controls */
.slider-control{margin:12px 0}
.slider-control label{display:block;font-size:.9rem;margin-bottom:6px;color:var(--text2)}
.slider-control input[type=range]{width:100%;accent-color:var(--cyan)}

/* Feedback */
.feedback{padding:16px 20px;border-radius:12px;margin:16px 0;font-size:.95rem;display:none}
.feedback.show{display:block;animation:feedbackPop .4s ease-out}
@keyframes feedbackPop{0%{opacity:0;transform:scale(0.9) translateY(10px)}100%{opacity:1;transform:scale(1) translateY(0)}}
.feedback.success{background:linear-gradient(135deg,rgba(34,197,94,0.15),rgba(6,182,212,0.1));border:1px solid var(--green);color:var(--green);font-size:1rem;line-height:1.7;padding:24px;border-radius:16px}
.feedback.error{background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(139,92,246,0.1));border:1px solid rgba(251,191,36,0.3);color:var(--gold);font-size:1rem;line-height:1.7;padding:24px;border-radius:16px}
.feedback.error::before{content:'üåü ';font-size:1.2rem}
.encouragement{font-size:.85rem;color:var(--cyan);margin-top:8px;font-style:italic}
.feedback.info{background:rgba(6,182,212,0.15);border:1px solid var(--cyan);color:var(--cyan)}

@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* Points popup */
.points-popup{position:fixed;z-index:9999;font-family:'Fredoka',sans-serif;font-size:1.5rem;font-weight:700;color:var(--gold);pointer-events:none;text-shadow:0 0 10px rgba(251,191,36,0.5)}

/* Check / Complete button */
.btn-check{background:linear-gradient(135deg,var(--green),#16a34a);padding:12px 28px;border-radius:14px;border:none;color:#fff;font-family:'Fredoka',sans-serif;font-size:1rem;font-weight:600;cursor:pointer;margin:16px 0;transition:all .3s;display:inline-flex;align-items:center;gap:8px}
.btn-check:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(34,197,94,0.3)}
.btn-check:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-next{background:linear-gradient(135deg,var(--cyan),var(--purple));padding:12px 28px;border-radius:14px;border:none;color:#fff;font-family:'Fredoka',sans-serif;font-size:1rem;font-weight:600;cursor:pointer;margin:16px 0;transition:all .3s;display:none;align-items:center;gap:8px}
.btn-next:hover{transform:translateY(-2px)}

/* Badge Gallery */
#badge-gallery{display:none;padding:40px 20px;position:relative;z-index:1}
.badges-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:16px;margin:30px 0}
.badge{text-align:center;padding:20px 12px;border-radius:16px;background:var(--glass);border:1px solid var(--glass-border);transition:all .3s}
.badge.earned{border-color:var(--gold);box-shadow:0 0 20px rgba(251,191,36,0.15)}
.badge.locked{opacity:.4;filter:grayscale(1)}
.badge .emoji{font-size:2.5rem;display:block;margin-bottom:8px}
.badge .name{font-size:.8rem;color:var(--text2)}
.badge.earned .name{color:var(--gold)}

/* Onboarding Wizard */
#onboarding{display:none;position:fixed;inset:0;z-index:10000;background:rgba(5,5,16,0.95);backdrop-filter:blur(20px);display:none;align-items:center;justify-content:center;padding:20px}
#onboarding.show{display:flex}
.wizard-card{max-width:500px;width:100%;padding:40px;text-align:center}
.wizard-card h2{font-size:1.8rem;margin-bottom:12px}
.wizard-card p{color:var(--text2);margin-bottom:24px}
.wizard-input{width:100%;padding:14px 20px;border-radius:12px;background:rgba(255,255,255,0.08);border:1px solid var(--glass-border);color:var(--text);font-size:1rem;font-family:'Nunito',sans-serif;margin-bottom:16px}
.wizard-input:focus{outline:none;border-color:var(--cyan)}
.wizard-dots{display:flex;gap:8px;justify-content:center;margin:20px 0}
.wizard-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.2)}
.wizard-dot.active{background:var(--cyan)}

/* Level Display */
.level-display{text-align:center;padding:16px;margin-bottom:16px;border-bottom:1px solid var(--glass-border)}
.level-display .level-icon{font-size:2rem;display:block;margin-bottom:4px}
.level-display .level-name{font-size:.9rem;color:var(--gold);font-weight:700}
.level-display .level-xp{font-size:.75rem;color:var(--text3)}

/* Solar system */
.solar-system{position:relative;width:100%;height:400px;background:radial-gradient(circle at center,rgba(251,191,36,0.1),transparent 30%);border-radius:16px;overflow:hidden;margin:16px 0}
.planet{position:absolute;cursor:pointer;transition:all .3s;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem}
.planet:hover{transform:scale(1.3);filter:brightness(1.3)}

/* Complete chapter overlay */
.chapter-complete{display:none;text-align:center;padding:40px;animation:fadeIn .5s}
.chapter-complete.show{display:block}
.chapter-complete .emoji{font-size:4rem;display:block;margin-bottom:12px}
.chapter-complete h3{font-size:1.6rem;margin-bottom:8px}
.chapter-complete p{color:var(--text2);margin-bottom:20px}

/* Mobile */
@media(max-width:768px){
  .course-body{flex-direction:column}
  .chapter-sidebar{width:100%;min-width:100%;height:auto;position:relative;top:0;display:flex;overflow-x:auto;padding:10px;gap:6px;border-right:none;border-bottom:1px solid var(--glass-border)}
  .chapter-item{min-width:fit-content;white-space:nowrap;padding:8px 12px;font-size:.8rem}
  .chapter-item .ch-title{max-width:120px;overflow:hidden;text-overflow:ellipsis}
  .lesson-area{padding:20px 16px}
  .buckets{grid-template-columns:1fr}
  .sequence-slots{flex-direction:column;align-items:center}
  .sequence-slot::after{content:'‚Üì';position:static;margin:0}
  .courses-grid{grid-template-columns:1fr}
  .card-grid{grid-template-columns:repeat(2,1fr)}
  .flip-card{height:160px}
  .maze-cell{width:30px;height:30px}
  .solar-system{height:300px}
}
@media(max-width:480px){
  .card-grid{grid-template-columns:1fr}
  .choice-cards{grid-template-columns:1fr}
}

/* Tap counter game */
.tap-area{width:200px;height:200px;border-radius:50%;background:linear-gradient(135deg,var(--cyan),var(--purple));display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:700;cursor:pointer;margin:20px auto;transition:all .1s;user-select:none}
.tap-area:active{transform:scale(.95);background:linear-gradient(135deg,var(--purple),var(--pink))}
.tap-counter{text-align:center;font-size:2rem;font-weight:700;color:var(--gold);font-family:'Fredoka',sans-serif}
.timer-bar{height:8px;background:rgba(255,255,255,0.1);border-radius:10px;margin:10px 0;overflow:hidden}
.timer-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--cyan));border-radius:10px;transition:width .1s linear}

/* Robot builder */
.robot-preview{width:200px;height:260px;margin:20px auto;background:rgba(0,0,0,0.3);border-radius:16px;border:1px solid var(--glass-border);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:1.8rem;position:relative}

/* Orbit simulation */
.orbit-sim{position:relative;width:100%;height:300px;background:radial-gradient(circle at center,rgba(251,191,36,0.15),transparent 40%);border-radius:16px;margin:16px 0;overflow:hidden}
.sun-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3rem}
.orbiting-planet{position:absolute;font-size:1.5rem;transition:none}

/* ===== NOTIFICATION CENTER ===== */
.notif-bell{position:relative;cursor:pointer;font-size:1.3rem;padding:4px 8px;transition:all .3s}
.notif-bell:hover{transform:scale(1.1)}
.notif-bell .notif-count{position:absolute;top:-4px;right:-4px;background:var(--red);color:#fff;font-size:.6rem;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-family:'Fredoka',sans-serif}
.notif-panel{position:absolute;top:60px;right:20px;width:340px;max-height:400px;overflow-y:auto;border-radius:16px;background:rgba(10,10,46,0.98);backdrop-filter:blur(20px);border:1px solid var(--glass-border);z-index:1000;display:none;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
.notif-panel.show{display:block;animation:fadeIn .3s}
.notif-panel h4{padding:16px;border-bottom:1px solid var(--glass-border);font-size:.95rem}
.notif-item{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:.85rem;color:var(--text2);display:flex;gap:10px;align-items:flex-start}
.notif-item .notif-icon{font-size:1.2rem;flex-shrink:0}
.notif-item .notif-text{flex:1}
.notif-item .notif-time{font-size:.7rem;color:var(--text3);white-space:nowrap}
.notif-empty{padding:30px;text-align:center;color:var(--text3);font-size:.9rem}

/* ===== METRICS SECTION ===== */
#metrics{padding:40px 0 20px;position:relative;z-index:1}
.metrics-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;max-width:700px;margin:0 auto}
.metric-card{text-align:center;padding:28px 16px;border-radius:16px;background:var(--glass);border:1px solid var(--glass-border)}
.metric-card .metric-num{font-size:clamp(2rem,5vw,3rem);font-weight:700;font-family:'Fredoka',sans-serif;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.metric-card .metric-label{font-size:.85rem;color:var(--text2);margin-top:4px}
@media(max-width:600px){.metrics-grid{grid-template-columns:1fr}}

/* ===== PRICING SECTION ===== */
#pricing{padding:60px 0 80px;position:relative;z-index:1}
#pricing h2{text-align:center;font-size:clamp(1.8rem,4vw,2.8rem);margin-bottom:8px}
#pricing .subtitle{text-align:center;color:var(--text2);margin-bottom:40px;font-size:1.05rem}
.pricing-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;max-width:1050px;margin:0 auto}
.pricing-card{padding:32px 24px;text-align:center;border-radius:20px;background:var(--glass);border:1px solid var(--glass-border);position:relative;transition:all .4s}
.pricing-card:hover{transform:translateY(-6px);border-color:rgba(255,255,255,0.2);box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.pricing-card.popular{border-color:var(--cyan);box-shadow:0 0 30px rgba(6,182,212,0.15)}
.pricing-card.popular::before{content:'‚≠ê BEST VALUE';position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--cyan),var(--purple));padding:4px 16px;border-radius:20px;font-size:.75rem;font-weight:700;font-family:'Fredoka',sans-serif;white-space:nowrap}
.pricing-card .price{font-size:2.5rem;font-weight:700;font-family:'Fredoka',sans-serif;margin:12px 0 4px}
.pricing-card .price-sub{font-size:.8rem;color:var(--text3);margin-bottom:16px}
.pricing-card ul{list-style:none;text-align:left;margin:16px 0;font-size:.9rem;color:var(--text2)}
.pricing-card ul li{padding:6px 0;display:flex;align-items:center;gap:8px}
.pricing-card ul li::before{content:'‚úÖ';font-size:.8rem}
.pricing-card .btn{width:100%;justify-content:center;margin-top:16px}
.pricing-card .price-free{color:var(--green)}
.pricing-card .price-paid{background:linear-gradient(135deg,var(--gold),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

/* ===== LOCK OVERLAY ===== */
.chapter-item.locked{opacity:.5}
.chapter-item.locked .ch-num{background:rgba(255,255,255,0.05)}
.chapter-lock{font-size:.7rem;color:var(--text3)}
.unlock-banner{text-align:center;padding:40px 20px;margin:20px 0;border-radius:20px;background:linear-gradient(135deg,rgba(6,182,212,0.1),rgba(139,92,246,0.1));border:1px solid var(--glass-border)}
.unlock-banner h3{font-size:1.4rem;margin-bottom:8px}
.unlock-banner p{color:var(--text2);margin-bottom:16px;font-size:.95rem}

/* ===== PARENT DASHBOARD ===== */
#parent-dashboard{display:none;min-height:100vh;position:relative;z-index:1;padding:20px}
.pd-header{display:flex;align-items:center;gap:16px;margin-bottom:30px}
.pd-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:30px}
.pd-stat{padding:24px;border-radius:16px;background:var(--glass);border:1px solid var(--glass-border);text-align:center}
.pd-stat .stat-value{font-size:2rem;font-weight:700;font-family:'Fredoka',sans-serif;color:var(--cyan)}
.pd-stat .stat-label{font-size:.85rem;color:var(--text2);margin-top:4px}
.pd-progress-ring{width:120px;height:120px;margin:0 auto 12px}
.pd-progress-ring circle{fill:none;stroke-width:8;stroke-linecap:round}
.pd-course-card{padding:20px;border-radius:16px;background:var(--glass);border:1px solid var(--glass-border);margin-bottom:16px}
.pd-course-card h4{margin-bottom:12px;font-size:1.1rem}
.pd-streak-cal{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;max-width:280px;margin:16px auto}
.pd-streak-day{width:100%;aspect-ratio:1;border-radius:4px;background:rgba(255,255,255,0.05)}
.pd-streak-day.active{background:var(--green)}
.pd-streak-day.today{border:1px solid var(--cyan)}
.pd-conversation{padding:20px;border-radius:16px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.3);margin-top:16px}
.pd-conversation h4{color:var(--purple);margin-bottom:8px}
.pd-conversation p{color:var(--text2);font-size:.9rem;line-height:1.6}

/* ===== CERTIFICATE BUTTON ===== */
.cert-btn{background:linear-gradient(135deg,var(--gold),var(--orange));color:#000;padding:12px 24px;border:none;border-radius:14px;font-family:'Fredoka',sans-serif;font-size:1rem;font-weight:600;cursor:pointer;margin:8px;transition:all .3s;display:inline-flex;align-items:center;gap:8px}
.cert-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(251,191,36,0.3)}

/* ===== ENGAGEMENT SUMMARY POPUP ===== */
.engagement-popup{position:fixed;inset:0;z-index:10001;background:rgba(5,5,16,0.9);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;padding:20px}
.engagement-popup.show{display:flex}
.engagement-card{max-width:420px;width:100%;padding:36px;text-align:center;border-radius:24px;background:rgba(10,10,46,0.98);border:1px solid var(--glass-border);box-shadow:0 20px 60px rgba(0,0,0,0.5)}
.engagement-card h3{font-size:1.5rem;margin-bottom:16px}
.engagement-stats{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:20px 0}
.engagement-stat{padding:16px;border-radius:12px;background:rgba(255,255,255,0.05)}
.engagement-stat .es-value{font-size:1.8rem;font-weight:700;font-family:'Fredoka',sans-serif;color:var(--cyan)}
.engagement-stat .es-label{font-size:.8rem;color:var(--text2)}

/* ===== AUTH MODALS ===== */
.auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px}
.auth-overlay.show{display:flex}
.auth-modal{background:var(--bg2);border:1px solid var(--glass-border);border-radius:24px;padding:40px;max-width:440px;width:100%;position:relative;animation:modalIn .3s ease}
@keyframes modalIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.auth-modal h2{text-align:center;margin-bottom:8px}
.auth-modal p{text-align:center;color:var(--text2);margin-bottom:24px;font-size:.95rem}
.auth-modal .close-btn{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--text2);font-size:1.5rem;cursor:pointer}
.auth-input{width:100%;padding:14px 16px;background:rgba(255,255,255,0.05);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-family:'Nunito',sans-serif;font-size:1rem;margin-bottom:12px;outline:none;transition:border .2s}
.auth-input:focus{border-color:var(--cyan)}
.auth-input::placeholder{color:var(--text3)}
.auth-error{color:var(--red);font-size:.85rem;margin-bottom:12px;display:none}
.auth-switch{text-align:center;margin-top:16px;font-size:.9rem;color:var(--text2)}
.auth-switch a{color:var(--cyan);cursor:pointer;text-decoration:none}
.auth-tabs{display:flex;gap:8px;margin-bottom:20px}
.auth-tab{flex:1;padding:10px;border-radius:10px;border:1px solid var(--glass-border);background:transparent;color:var(--text2);cursor:pointer;font-family:'Fredoka',sans-serif;transition:all .2s}
.auth-tab.active{background:var(--cyan);color:#000;border-color:var(--cyan)}
.child-pin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:240px;margin:16px auto}
.child-pin-btn{padding:16px;font-size:1.4rem;font-family:'Fredoka',sans-serif;border-radius:12px;border:1px solid var(--glass-border);background:var(--glass);color:var(--text);cursor:pointer;transition:all .2s}
.child-pin-btn:hover{background:var(--cyan);color:#000}
.pin-dots{display:flex;gap:8px;justify-content:center;margin:16px 0}
.pin-dot{width:16px;height:16px;border-radius:50%;border:2px solid var(--glass-border);transition:all .2s}
.pin-dot.filled{background:var(--cyan);border-color:var(--cyan)}
.demo-badge{display:inline-block;padding:4px 12px;border-radius:20px;background:var(--green);color:#000;font-size:.75rem;font-weight:700;margin-left:8px}
.user-menu{position:relative;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
.user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--cyan),var(--purple));display:flex;align-items:center;justify-content:center;font-size:1rem}
.user-dropdown{position:absolute;top:100%;right:0;margin-top:8px;background:var(--bg2);border:1px solid var(--glass-border);border-radius:12px;min-width:200px;padding:8px;display:none;z-index:100}
.user-dropdown.show{display:block}
.user-dropdown a{display:block;padding:10px 14px;border-radius:8px;color:var(--text);text-decoration:none;font-size:.9rem;transition:background .2s}
.user-dropdown a:hover{background:var(--glass2)}

/* ===== ADMIN PANEL ===== */
#admin-panel{display:none;min-height:100vh;position:relative;z-index:1;padding:20px}
.admin-header{display:flex;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap}
.admin-header h2{flex:1;font-size:1.6rem}
.admin-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:24px}
.admin-tab{padding:10px 18px;border-radius:10px;border:1px solid var(--glass-border);background:transparent;color:var(--text2);cursor:pointer;font-family:'Fredoka',sans-serif;font-size:.9rem;transition:all .2s}
.admin-tab.active{background:linear-gradient(135deg,var(--cyan),var(--purple));color:#fff;border-color:transparent}
.admin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.admin-stat{padding:20px;border-radius:16px;background:var(--glass);border:1px solid var(--glass-border)}
.admin-stat .as-value{font-size:2rem;font-weight:700;font-family:'Fredoka',sans-serif}
.admin-stat .as-label{font-size:.85rem;color:var(--text2)}
.admin-table{width:100%;border-collapse:collapse;font-size:.9rem}
.admin-table th{text-align:left;padding:12px;border-bottom:1px solid var(--glass-border);color:var(--text2);font-weight:600}
.admin-table td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.03)}
.admin-table tr:hover td{background:rgba(255,255,255,0.02)}
.admin-search{padding:10px 16px;background:var(--glass);border:1px solid var(--glass-border);border-radius:10px;color:var(--text);font-size:.9rem;width:100%;max-width:300px;margin-bottom:16px;outline:none}
.admin-search::placeholder{color:var(--text3)}
.admin-chart-wrap{background:var(--glass);border:1px solid var(--glass-border);border-radius:16px;padding:20px;margin-bottom:24px}
.status-badge{display:inline-block;padding:2px 10px;border-radius:20px;font-size:.8rem;font-weight:600}
.status-success{background:rgba(34,197,94,0.2);color:var(--green)}
.status-failed{background:rgba(239,68,68,0.2);color:var(--red)}
.status-demo{background:rgba(251,191,36,0.2);color:var(--gold)}
.admin-settings label{display:block;margin-bottom:4px;font-size:.9rem;color:var(--text2)}
.admin-settings input{margin-bottom:16px}
.admin-password{display:flex;flex-direction:column;align-items:center;gap:16px;padding:60px 20px;text-align:center}
</style>
</head>
<body>
<canvas id="starfield"></canvas>

<!-- ===== LANDING PAGE ===== -->
<div id="landing">
<!-- Hero -->
<section id="hero">
<div class="hero-content">
  <div class="hero-badges">
    <span class="hero-badge"><span>üéØ</span> Ages 9-13</span>
    <span class="hero-badge"><span>üß†</span> Visual Learning</span>
    <span class="hero-badge"><span>üéÆ</span> Interactive</span>
  </div>
  <h1>Mind Over Machines</h1>
  <p>The futuristic school where kids master AI, explore space, and build robots ‚Äî all through drag-and-drop adventures. No coding required!</p>
  <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
    <button class="btn btn-primary" onclick="showCourses()">üöÄ Start Learning</button>
    <button class="btn btn-gold" onclick="showBadges()">üèÜ My Badges</button>
    <button class="btn btn-back" onclick="showParentDashboard()" style="border-color:var(--purple)">üë®‚Äçüë©‚Äçüëß Parent Portal</button>
    <button class="btn btn-back" onclick="showAdmin()" style="border-color:var(--cyan);font-size:.8rem">üîê Admin</button>
  </div>
</div>
</section>

<!-- Metrics -->
<section id="metrics">
<div class="container">
  <div class="metrics-grid">
    <div class="metric-card"><div class="metric-num" id="metric-students">0</div><div class="metric-label">Students Learning</div></div>
    <div class="metric-card"><div class="metric-num" id="metric-chapters">0</div><div class="metric-label">Chapters Completed</div></div>
    <div class="metric-card"><div class="metric-num" id="metric-badges">0</div><div class="metric-label">Badges Earned</div></div>
  </div>
</div>
</section>

<!-- Principles -->
<section id="principles">
<div class="container">
  <h2>üåü Our Core Principles</h2>
  <div class="principles-grid">
    <div class="principle-card glass">
      <span class="emoji">üß†</span>
      <h4>Think Critically</h4>
      <p>Question everything, including AI. Be the boss, not the follower.</p>
    </div>
    <div class="principle-card glass">
      <span class="emoji">üé®</span>
      <h4>Create & Build</h4>
      <p>Hands-on, visual, drag-and-drop. Learn by doing, not memorizing.</p>
    </div>
    <div class="principle-card glass">
      <span class="emoji">ü§ù</span>
      <h4>Ethics First</h4>
      <p>Technology should be fair, kind, and helpful for everyone.</p>
    </div>
    <div class="principle-card glass">
      <span class="emoji">üöÄ</span>
      <h4>Dream Big</h4>
      <p>From AI to space to robots ‚Äî the future belongs to curious kids.</p>
    </div>
  </div>
</div>
</section>

<!-- Courses -->
<section id="courses">
<div class="container">
  <h2>Choose Your Adventure</h2>
  <p class="subtitle">3 courses ‚Ä¢ 24 chapters ‚Ä¢ Hundreds of interactive activities</p>
  <div class="courses-grid">
    <div class="course-card glass" data-course="ai" onclick="openCourse('ai')">
      <span class="emoji">ü§ñ</span>
      <h3>AI Adventures</h3>
      <p>Discover how artificial intelligence works ‚Äî visually! Drag, drop, and explore the world of smart machines.</p>
      <span class="chapters-count">8 Chapters ‚Ä¢ 50+ Activities</span>
    </div>
    <div class="course-card glass" data-course="space" onclick="openCourse('space')">
      <span class="emoji">üöÄ</span>
      <h3>Space Explorers</h3>
      <p>Launch rockets, plan missions to Mars, explore the solar system. Become a space scientist through interactive adventures!</p>
      <span class="chapters-count">8 Chapters ‚Ä¢ 50+ Activities</span>
    </div>
    <div class="course-card glass" data-course="robotics" onclick="openCourse('robotics')">
      <span class="emoji">üîß</span>
      <h3>Robotics Lab</h3>
      <p>Build robots with visual blocks, navigate mazes, add sensors and AI. Design your own robot from scratch!</p>
      <span class="chapters-count">8 Chapters ‚Ä¢ 50+ Activities</span>
    </div>
  </div>
</div>
</section>

<!-- Pricing -->
<section id="pricing">
<div class="container">
  <h2>üíé Choose Your Plan</h2>
  <p class="subtitle">Start free ‚Äî upgrade anytime. Chapter 1 of every course is always free!</p>
  <div class="pricing-grid">
    <div class="pricing-card">
      <h3>üÜì Free Trial</h3>
      <div class="price price-free">$0</div>
      <div class="price-sub">Forever free</div>
      <ul>
        <li>Chapter 1 of all 3 courses</li>
        <li>3 interactive activities</li>
        <li>Basic badge collection</li>
      </ul>
      <button class="btn btn-primary" onclick="showCourses()">Start Free ‚Üí</button>
    </div>
    <div class="pricing-card">
      <h3>üìò Single Course</h3>
      <div class="price price-paid">$19</div>
      <div class="price-sub">per course</div>
      <ul>
        <li>All 8 chapters in one course</li>
        <li>50+ interactive activities</li>
        <li>Course certificate</li>
        <li>Badge collection</li>
      </ul>
      <button class="btn btn-primary" onclick="handlePayment('singleCourse')">Unlock Course ‚Üí</button>
    </div>
    <div class="pricing-card popular">
      <h3>üöÄ Full Access</h3>
      <div class="price price-paid">$39</div>
      <div class="price-sub">all courses</div>
      <ul>
        <li>All 3 courses (24 chapters)</li>
        <li>150+ interactive activities</li>
        <li>All certificates</li>
        <li>Priority support</li>
      </ul>
      <button class="btn btn-gold" onclick="handlePayment('fullAccess')">Best Value ‚Üí</button>
    </div>
    <div class="pricing-card">
      <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Plan</h3>
      <div class="price price-paid">$59</div>
      <div class="price-sub">up to 3 kids</div>
      <ul>
        <li>Everything in Full Access</li>
        <li>Up to 3 child profiles</li>
        <li>Parent dashboard</li>
        <li>Progress reports</li>
      </ul>
      <button class="btn btn-primary" onclick="handlePayment('familyPlan')">Get Family Plan ‚Üí</button>
    </div>
  </div>
  <p style="text-align:center;margin-top:20px;font-size:.85rem;color:var(--text3)">üáÆüá≥ Indian parents: Razorpay also available. <a href="mailto:hello@nextgenschool.aiupskills.com" style="color:var(--cyan)">Contact us</a></p>
</div>
</section>
</div>

<!-- ===== BADGE GALLERY ===== -->
<div id="badge-gallery">
<div class="container">
  <button class="btn btn-back" onclick="showLanding()">‚Üê Back Home</button>
  <h2 style="text-align:center;margin:20px 0;font-size:2rem">üèÜ Badge Gallery</h2>
  <p style="text-align:center;color:var(--text2);margin-bottom:8px">Complete chapters to earn badges!</p>
  <div id="badges-container" class="badges-grid"></div>
</div>
</div>

<!-- ===== COURSE VIEW ===== -->
<div id="course-view">
<div class="course-header">
  <button class="btn btn-back" onclick="showLanding()">‚Üê Courses</button>
  <h2 id="course-title"></h2>
  <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
  <span class="progress-text" id="progress-text">0%</span>
  <span class="points-display" id="points-display">‚≠ê 0</span>
  <div class="notif-bell" onclick="toggleNotifPanel()">üîî<span class="notif-count" id="notif-count" style="display:none">0</span></div>
</div>
<div class="notif-panel" id="notif-panel">
  <h4>üîî Notifications</h4>
  <div id="notif-list"><div class="notif-empty">No notifications yet!</div></div>
</div>
<div class="course-body">
  <div class="chapter-sidebar" id="chapter-sidebar"></div>
  <div class="lesson-area" id="lesson-area"></div>
</div>
</div>

<!-- ===== PARENT DASHBOARD ===== -->
<div id="parent-dashboard">
<div class="container">
  <div class="pd-header">
    <button class="btn btn-back" onclick="showLanding()">‚Üê Back Home</button>
    <h2 style="flex:1;font-size:1.4rem">üë®‚Äçüë©‚Äçüëß Parent Dashboard</h2>
  </div>
  <div id="pd-login" style="text-align:center;padding:60px 20px">
    <span style="font-size:4rem;display:block;margin-bottom:16px">üîê</span>
    <h3 style="margin-bottom:12px">Parent Portal</h3>
    <p style="color:var(--text2);margin-bottom:20px">Enter the email you provided during signup</p>
    <input class="wizard-input" id="pd-email" placeholder="parent@email.com" type="email" style="max-width:400px;margin:0 auto 16px">
    <br><button class="btn btn-primary" onclick="parentLogin()">Access Dashboard ‚Üí</button>
  </div>
  <div id="pd-content" style="display:none">
    <div class="pd-stats" id="pd-stats"></div>
    <div id="pd-courses"></div>
    <div id="pd-streak-section" style="text-align:center;margin:30px 0">
      <h3 style="margin-bottom:12px">üìÖ Learning Streak</h3>
      <div class="pd-streak-cal" id="pd-streak-cal"></div>
    </div>
    <div id="pd-conversation-section"></div>
    <div id="pd-certificates" style="margin-top:20px"></div>
  </div>
</div>
</div>

<!-- ===== ENGAGEMENT SUMMARY ===== -->
<div class="engagement-popup" id="engagement-popup">
<div class="engagement-card glass">
  <span style="font-size:3rem;display:block;margin-bottom:8px">üìä</span>
  <h3>Your Weekly Summary</h3>
  <div class="engagement-stats" id="engagement-stats"></div>
  <button class="btn btn-primary" onclick="closeEngagementPopup()" style="margin-top:16px">Awesome! üéâ</button>
</div>
</div>

<!-- ===== AUTH MODALS ===== -->
<div class="auth-overlay" id="auth-signup-modal">
<div class="auth-modal">
  <button class="close-btn" onclick="closeAuthModal('signup')">&times;</button>
  <span style="font-size:3rem;display:block;text-align:center;margin-bottom:8px">üë®‚Äçüë©‚Äçüëß</span>
  <h2>Create Parent Account</h2>
  <p>Set up your family's learning journey</p>
  <div class="auth-error" id="signup-error"></div>
  <input class="auth-input" id="signup-name" placeholder="Your full name" maxlength="50">
  <input class="auth-input" id="signup-email" placeholder="Email address" type="email">
  <input class="auth-input" id="signup-password" placeholder="Password (min 6 chars)" type="password">
  <input class="auth-input" id="signup-child-name" placeholder="Child's name">
  <input class="auth-input" id="signup-child-age" placeholder="Child's age (9-13)" type="number" min="9" max="13">
  <input class="auth-input" id="signup-child-pin" placeholder="Child's 4-digit PIN (for child login)" type="password" maxlength="4">
  <button class="btn btn-primary" onclick="doSignup()" style="width:100%">Create Account üöÄ</button>
  <div class="auth-switch">Already have an account? <a onclick="openAuthModal('login')">Log in</a></div>
</div>
</div>

<div class="auth-overlay" id="auth-login-modal">
<div class="auth-modal">
  <button class="close-btn" onclick="closeAuthModal('login')">&times;</button>
  <span style="font-size:3rem;display:block;text-align:center;margin-bottom:8px">üîê</span>
  <h2>Welcome Back</h2>
  <p>Log in to your account</p>
  <div class="auth-tabs">
    <button class="auth-tab active" onclick="switchLoginTab('parent')">üë®‚Äçüë©‚Äçüëß Parent</button>
    <button class="auth-tab" onclick="switchLoginTab('child')">üßí Child PIN</button>
  </div>
  <div class="auth-error" id="login-error"></div>
  <div id="login-parent-form">
    <input class="auth-input" id="login-email" placeholder="Email address" type="email">
    <input class="auth-input" id="login-password" placeholder="Password" type="password">
    <button class="btn btn-primary" onclick="doLogin()" style="width:100%">Log In ‚Üí</button>
  </div>
  <div id="login-child-form" style="display:none">
    <p style="text-align:center;color:var(--text2);font-size:.9rem;margin-bottom:8px">Enter your 4-digit PIN</p>
    <div class="pin-dots" id="pin-dots"><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div></div>
    <div class="child-pin-grid">
      <button class="child-pin-btn" onclick="enterPin(1)">1</button>
      <button class="child-pin-btn" onclick="enterPin(2)">2</button>
      <button class="child-pin-btn" onclick="enterPin(3)">3</button>
      <button class="child-pin-btn" onclick="enterPin(4)">4</button>
      <button class="child-pin-btn" onclick="enterPin(5)">5</button>
      <button class="child-pin-btn" onclick="enterPin(6)">6</button>
      <button class="child-pin-btn" onclick="enterPin(7)">7</button>
      <button class="child-pin-btn" onclick="enterPin(8)">8</button>
      <button class="child-pin-btn" onclick="enterPin(9)">9</button>
      <button class="child-pin-btn" onclick="clearPin()">‚å´</button>
      <button class="child-pin-btn" onclick="enterPin(0)">0</button>
      <button class="child-pin-btn" onclick="submitPin()">‚úì</button>
    </div>
  </div>
  <div class="auth-switch">Don't have an account? <a onclick="openAuthModal('signup')">Sign up</a></div>
</div>
</div>

<!-- ===== ADMIN PANEL ===== -->
<div id="admin-panel">
<div class="container">
  <div class="admin-header">
    <button class="btn btn-back" onclick="showLanding();document.getElementById('admin-panel').style.display='none'">‚Üê Back</button>
    <h2>üõ°Ô∏è Admin Dashboard</h2>
    <button class="btn btn-back" onclick="adminExportCSV()">üì• Export CSV</button>
  </div>
  <div class="admin-password" id="admin-password-gate">
    <span style="font-size:4rem">üîê</span>
    <h3>Admin Access Required</h3>
    <input class="auth-input" id="admin-pw-input" placeholder="Enter admin password" type="password" style="max-width:300px">
    <button class="btn btn-primary" onclick="adminPasswordCheck()">Access ‚Üí</button>
  </div>
  <div id="admin-content" style="display:none">
    <div class="admin-tabs" id="admin-tabs">
      <button class="admin-tab active" onclick="showAdminTab('dashboard')">üìä Dashboard</button>
      <button class="admin-tab" onclick="showAdminTab('enrollments')">üë®‚Äçüë©‚Äçüëß Enrollments</button>
      <button class="admin-tab" onclick="showAdminTab('payments')">üí≥ Payments</button>
      <button class="admin-tab" onclick="showAdminTab('analytics')">üìà Analytics</button>
      <button class="admin-tab" onclick="showAdminTab('students')">üßí Students</button>
      <button class="admin-tab" onclick="showAdminTab('settings')">‚öôÔ∏è Settings</button>
    </div>
    <div id="admin-tab-content"></div>
  </div>
</div>
</div>

<!-- ===== ONBOARDING ===== -->
<div id="onboarding">
<div class="wizard-card glass">
  <div id="wizard-step-1">
    <span style="font-size:4rem;display:block;margin-bottom:16px">üëã</span>
    <h2>Welcome to NextGen School!</h2>
    <p>Ready to explore AI, space, and robotics? Let's set up your profile!</p>
    <input class="wizard-input" id="wizard-name" placeholder="What's your name, explorer?" maxlength="20">
    <div class="wizard-dots"><span class="wizard-dot active"></span><span class="wizard-dot"></span></div>
    <button class="btn btn-primary" onclick="wizardNext()" style="width:100%">Next ‚Üí</button>
  </div>
  <div id="wizard-step-2" style="display:none">
    <span style="font-size:4rem;display:block;margin-bottom:16px">üìß</span>
    <h2>Parent's Email (Optional)</h2>
    <p>We'll send progress reports and certificates to your parent!</p>
    <input class="wizard-input" id="wizard-email" placeholder="parent@email.com" type="email">
    <div class="wizard-dots"><span class="wizard-dot"></span><span class="wizard-dot active"></span></div>
    <button class="btn btn-primary" onclick="finishOnboarding()" style="width:100%">Let's Go! üöÄ</button>
    <button class="btn btn-back" onclick="wizardBack()" style="width:100%;margin-top:8px">‚Üê Back</button>
  </div>
</div>
</div>

<script>
// ===== CONFIG (Fill in your keys) =====
const EMAIL_CONFIG = {
  serviceId: 'YOUR_EMAILJS_SERVICE_ID',
  templateWelcome: 'YOUR_WELCOME_TEMPLATE_ID',
  templateProgress: 'YOUR_PROGRESS_TEMPLATE_ID',
  templateCertificate: 'YOUR_CERTIFICATE_TEMPLATE_ID',
  publicKey: 'YOUR_EMAILJS_PUBLIC_KEY'
};

const PAYMENT_CONFIG = {
  stripePublicKey: 'YOUR_STRIPE_PUBLIC_KEY',
  razorpayKeyId: 'YOUR_RAZORPAY_KEY_ID',
  prices: {
    singleCourse: 'YOUR_STRIPE_PRICE_ID_SINGLE',
    fullAccess: 'YOUR_STRIPE_PRICE_ID_BUNDLE',
    familyPlan: 'YOUR_STRIPE_PRICE_ID_FAMILY'
  }
};

// ===== CORE STATE =====
const STATE = {
  name: localStorage.getItem('ngs_name') || '',
  points: parseInt(localStorage.getItem('ngs_points')) || 0,
  completed: JSON.parse(localStorage.getItem('ngs_completed') || '{}'),
  parentEmail: localStorage.getItem('ngs_parent_email') || '',
  notifications: JSON.parse(localStorage.getItem('ngs_notifications') || '[]'),
  purchases: JSON.parse(localStorage.getItem('ngs_purchases') || '{}'),
  activeDays: JSON.parse(localStorage.getItem('ngs_active_days') || '[]'),
  sessionStart: Date.now(),
  timeSpent: parseInt(localStorage.getItem('ngs_time_spent')) || 0,
  currentCourse: null,
  currentChapter: 0
};

function save() {
  localStorage.setItem('ngs_name', STATE.name);
  localStorage.setItem('ngs_points', STATE.points);
  localStorage.setItem('ngs_completed', JSON.stringify(STATE.completed));
  localStorage.setItem('ngs_parent_email', STATE.parentEmail);
  localStorage.setItem('ngs_notifications', JSON.stringify(STATE.notifications));
  localStorage.setItem('ngs_purchases', JSON.stringify(STATE.purchases));
  localStorage.setItem('ngs_active_days', JSON.stringify(STATE.activeDays));
  localStorage.setItem('ngs_time_spent', STATE.timeSpent);
}

// ===== STARFIELD =====
(function() {
  const c = document.getElementById('starfield'), ctx = c.getContext('2d');
  let stars = [];
  function resize() {
    c.width = window.innerWidth; c.height = window.innerHeight;
    stars = Array.from({length: 200}, () => ({
      x: Math.random() * c.width, y: Math.random() * c.height,
      r: Math.random() * 1.5 + 0.3, s: Math.random() * 0.5 + 0.1,
      o: Math.random()
    }));
  }
  resize(); window.addEventListener('resize', resize);
  function draw() {
    ctx.clearRect(0, 0, c.width, c.height);
    stars.forEach(s => {
      s.o += s.s * 0.01;
      ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255,255,255,${(Math.sin(s.o) + 1) / 3})`;
      ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  draw();
})();

// ===== ONBOARDING =====
if (!STATE.name) {
  document.getElementById('onboarding').classList.add('show');
}

function wizardNext() {
  const n = document.getElementById('wizard-name').value.trim();
  if (!n) { document.getElementById('wizard-name').style.borderColor = 'var(--red)'; return; }
  document.getElementById('wizard-step-1').style.display = 'none';
  document.getElementById('wizard-step-2').style.display = 'block';
}

function wizardBack() {
  document.getElementById('wizard-step-2').style.display = 'none';
  document.getElementById('wizard-step-1').style.display = 'block';
}

function finishOnboarding() {
  const n = document.getElementById('wizard-name').value.trim();
  if (!n) return;
  STATE.name = n;
  const email = document.getElementById('wizard-email').value.trim();
  if (email) { STATE.parentEmail = email; }
  save();
  document.getElementById('onboarding').classList.remove('show');
  // Send welcome email
  if (email) sendEmail('welcome', { parent_email: email, child_name: n });
  // Request push notification permission
  requestNotifPermission();
  // Track active day
  trackActiveDay();
}

// ===== NAVIGATION =====
function showLanding() {
  document.getElementById('landing').style.display = 'block';
  document.getElementById('course-view').style.display = 'none';
  document.getElementById('badge-gallery').style.display = 'none';
  document.getElementById('parent-dashboard').style.display = 'none';
}

function showParentDashboard() {
  document.getElementById('landing').style.display = 'none';
  document.getElementById('course-view').style.display = 'none';
  document.getElementById('badge-gallery').style.display = 'none';
  document.getElementById('parent-dashboard').style.display = 'block';
  window.scrollTo(0, 0);
  if (STATE.parentEmail) {
    document.getElementById('pd-email').value = STATE.parentEmail;
  }
}

function showCourses() {
  document.getElementById('courses').scrollIntoView({behavior: 'smooth'});
}

function showBadges() {
  document.getElementById('landing').style.display = 'none';
  document.getElementById('course-view').style.display = 'none';
  document.getElementById('badge-gallery').style.display = 'block';
  document.getElementById('badge-gallery').style.position = 'relative';
  document.getElementById('badge-gallery').style.zIndex = '1';
  renderBadges();
  window.scrollTo(0, 0);
}

// ===== POINTS =====
function addPoints(n) {
  STATE.points += n; save();
  updatePointsDisplay();
  // Popup animation
  const p = document.createElement('div');
  p.className = 'points-popup';
  p.textContent = `+${n} ‚≠ê`;
  p.style.left = (Math.random() * 200 + 100) + 'px';
  p.style.top = '80px';
  document.body.appendChild(p);
  gsap.to(p, {y: -80, opacity: 0, duration: 1.2, onComplete: () => p.remove()});
}

function updatePointsDisplay() {
  const el = document.getElementById('points-display');
  if (el) el.textContent = `‚≠ê ${STATE.points}`;
}

function getLevel() {
  if (STATE.points >= 500) return {icon: 'üëë', name: 'Creator', next: '‚àû'};
  if (STATE.points >= 250) return {icon: 'üî®', name: 'Builder', next: 500};
  return {icon: 'üîç', name: 'Explorer', next: 250};
}

// ===== COURSE DATA =====
const COURSES = {
  ai: {
    title: 'ü§ñ AI Adventures',
    color: 'var(--cyan)',
    chapters: [
      {title: 'What is AI?', emoji: 'ü§î'},
      {title: 'How AI Learns', emoji: 'üìö'},
      {title: 'Smart vs Wise', emoji: 'üß†'},
      {title: 'AI in Your World', emoji: 'üåç'},
      {title: 'Asking Better Questions', emoji: '‚ùì'},
      {title: 'When AI Gets It Wrong', emoji: '‚ùå'},
      {title: 'AI Ethics & Fairness', emoji: '‚öñÔ∏è'},
      {title: 'Be the AI Boss', emoji: 'üëë'}
    ]
  },
  space: {
    title: 'üöÄ Space Explorers',
    color: 'var(--purple)',
    chapters: [
      {title: 'Our Solar System', emoji: 'ü™ê'},
      {title: 'Life of a Star', emoji: '‚≠ê'},
      {title: 'Rockets & Launch Science', emoji: 'üöÄ'},
      {title: 'Mission to Mars', emoji: 'üî¥'},
      {title: 'Gravity & Orbits', emoji: 'üåÄ'},
      {title: 'Space AI', emoji: 'üõ∏'},
      {title: 'Astronaut Training', emoji: 'üë®‚ÄçüöÄ'},
      {title: 'Design Your Space Mission', emoji: 'üìã'}
    ]
  },
  robotics: {
    title: 'üîß Robotics Lab',
    color: 'var(--green)',
    chapters: [
      {title: 'What is a Robot?', emoji: 'ü§ñ'},
      {title: 'Robot Senses', emoji: 'üëÅÔ∏è'},
      {title: 'Robot Brain', emoji: 'üß†'},
      {title: 'Robot Movement', emoji: 'üïπÔ∏è'},
      {title: 'Types of Robots', emoji: 'ü¶æ'},
      {title: 'Robots & AI Together', emoji: 'ü§ù'},
      {title: 'Robot Ethics', emoji: '‚öñÔ∏è'},
      {title: 'Design Your Robot', emoji: 'üèóÔ∏è'}
    ]
  }
};

// ===== OPEN COURSE =====
function openCourse(id) {
  STATE.currentCourse = id;
  STATE.currentChapter = 0;
  document.getElementById('landing').style.display = 'none';
  document.getElementById('badge-gallery').style.display = 'none';
  document.getElementById('course-view').style.display = 'block';
  document.getElementById('course-title').textContent = COURSES[id].title;
  renderSidebar();
  loadChapter(0);
  updatePointsDisplay();
  window.scrollTo(0, 0);
}

function renderSidebar() {
  const sb = document.getElementById('chapter-sidebar');
  const course = COURSES[STATE.currentCourse];
  const level = getLevel();
  sb.innerHTML = `<div class="level-display"><span class="level-icon">${level.icon}</span><span class="level-name">${level.name}</span><span class="level-xp">${STATE.points} / ${level.next} XP</span></div>`;
  course.chapters.forEach((ch, i) => {
    const key = `${STATE.currentCourse}_${i}`;
    const completed = STATE.completed[key];
    const active = i === STATE.currentChapter;
    sb.innerHTML += `<div class="chapter-item ${active ? 'active' : ''} ${completed ? 'completed' : ''}" onclick="loadChapter(${i})">
      <div class="ch-num">${completed ? '‚úì' : i + 1}</div>
      <div class="ch-title">${ch.emoji} ${ch.title}</div>
    </div>`;
  });
}

function updateProgress() {
  const course = COURSES[STATE.currentCourse];
  const total = course.chapters.length;
  let done = 0;
  for (let i = 0; i < total; i++) {
    if (STATE.completed[`${STATE.currentCourse}_${i}`]) done++;
  }
  const pct = Math.round(done / total * 100);
  document.getElementById('progress-fill').style.width = pct + '%';
  document.getElementById('progress-text').textContent = pct + '%';
}

// ===== COMPLETE CHAPTER =====
function completeChapter() {
  const key = `${STATE.currentCourse}_${STATE.currentChapter}`;
  if (!STATE.completed[key]) {
    STATE.completed[key] = true;
    addPoints(25);
    save();
  }
  renderSidebar();
  updateProgress();
  const area = document.getElementById('lesson-area');
  area.innerHTML += `<div class="chapter-complete show">
    <span class="emoji">üéâ</span>
    <h3>Chapter Complete!</h3>
    <p>+25 XP earned! Great job${STATE.name ? ', ' + STATE.name : ''}!</p>
    ${STATE.currentChapter < 7 ? `<button class="btn btn-primary" onclick="loadChapter(${STATE.currentChapter + 1})">Next Chapter ‚Üí</button>` : `<button class="btn btn-gold" onclick="showBadges()">üèÜ View Badges</button>`}
  </div>`;
}

// ===== BADGES =====
const BADGE_DATA = [
  ...['ai','space','robotics'].flatMap((c, ci) =>
    COURSES[c].chapters.map((ch, i) => ({
      id: `${c}_${i}`, emoji: ch.emoji,
      name: ch.title, course: c
    }))
  )
];

function renderBadges() {
  const cont = document.getElementById('badges-container');
  cont.innerHTML = '';
  BADGE_DATA.forEach(b => {
    const earned = STATE.completed[b.id];
    cont.innerHTML += `<div class="badge ${earned ? 'earned' : 'locked'}">
      <span class="emoji">${b.emoji}</span>
      <div class="name">${b.name}</div>
    </div>`;
  });
}

// ===== TOUCH-FRIENDLY DRAG AND DROP =====
let dragState = null;
let dragClone = null;

function initDrag(el) {
  el.addEventListener('pointerdown', startDrag);
}

function startDrag(e) {
  const el = e.currentTarget;
  if (el.classList.contains('placed')) return;
  e.preventDefault();
  dragState = {el, startX: e.clientX, startY: e.clientY, id: el.dataset.id, value: el.dataset.value};
  dragClone = el.cloneNode(true);
  dragClone.style.cssText = `position:fixed;z-index:99999;pointer-events:none;opacity:0.8;left:${e.clientX - 40}px;top:${e.clientY - 20}px;`;
  document.body.appendChild(dragClone);
  el.style.opacity = '0.4';
  document.addEventListener('pointermove', moveDrag);
  document.addEventListener('pointerup', endDrag);
}

function moveDrag(e) {
  if (!dragClone) return;
  dragClone.style.left = (e.clientX - 40) + 'px';
  dragClone.style.top = (e.clientY - 20) + 'px';
  // Highlight drop zones
  document.querySelectorAll('.drag-zone, .bucket, .sequence-slot, .flowchart-area, .cargo-bay, .rocket-slot').forEach(z => {
    const r = z.getBoundingClientRect();
    if (e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom) {
      z.classList.add('over');
    } else {
      z.classList.remove('over');
    }
  });
}

function endDrag(e) {
  document.removeEventListener('pointermove', moveDrag);
  document.removeEventListener('pointerup', endDrag);
  if (dragClone) { dragClone.remove(); dragClone = null; }
  if (!dragState) return;
  dragState.el.style.opacity = '';
  // Find drop target
  const zones = document.querySelectorAll('.drag-zone, .bucket, .sequence-slot, .flowchart-area, .cargo-bay, .rocket-slot');
  zones.forEach(z => z.classList.remove('over'));
  zones.forEach(z => {
    const r = z.getBoundingClientRect();
    if (e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom) {
      if (z.dataset.onDrop) {
        window[z.dataset.onDrop](dragState, z);
      }
    }
  });
  dragState = null;
}

// ===== CHAPTER CONTENT GENERATORS =====
function loadChapter(idx) {
  STATE.currentChapter = idx;
  renderSidebar();
  updateProgress();
  const area = document.getElementById('lesson-area');
  const key = `${STATE.currentCourse}_${idx}`;

  // Call the appropriate lesson generator
  const gen = LESSONS[STATE.currentCourse]?.[idx];
  if (gen) {
    area.innerHTML = '';
    gen(area);
  } else {
    area.innerHTML = `<h2>Coming Soon!</h2><p class="lesson-desc">This chapter is being built. Check back soon!</p>`;
  }
  window.scrollTo(0, 0);
}

// Show feedback message
function showFeedback(container, type, msg) {
  let fb = container.querySelector('.feedback');
  if (!fb) {
    fb = document.createElement('div');
    fb.className = 'feedback';
    container.appendChild(fb);
  }
  fb.className = `feedback show ${type}`;
  if (type === 'error') {
    const encouragements = [
      "You're doing amazing ‚Äî every great thinker makes mistakes before getting it right! üí™",
      "Almost there! The best scientists try again and again. You're learning SO much! üåà",
      "Hey, getting it wrong means your brain is growing! That's literally how learning works! üß†‚ú®",
      "Don't give up! Einstein failed hundreds of times before his breakthroughs! You've got this! üöÄ",
      "You're braver than you believe! Every wrong answer gets you closer to the right one! ‚≠ê",
      "Mistakes are just practice for being awesome! Try one more time! üéØ",
      "The fact that you're trying makes you a REAL explorer! Keep going! üî≠",
      "Wrong answers aren't failures ‚Äî they're stepping stones! You're on the right path! üåü",
      "Even robots need a few tries to get things right! You're smarter than a robot! ü§ñüíú",
      "Your curiosity is your superpower! Let's figure this out together! üí°"
    ];
    const enc = encouragements[Math.floor(Math.random() * encouragements.length)];
    fb.innerHTML = msg + '<div class="encouragement">' + enc + '</div>';
  } else {
    fb.textContent = msg;
    if (type === 'success') {
      fb.innerHTML = msg + ' <span style="font-size:1.2rem">üéâ</span>';
    }
  }
  fb.scrollIntoView({behavior: 'smooth', block: 'center'});
}

// ===== ALL LESSONS =====
const LESSONS = {
  // ==========================================
  // AI ADVENTURES
  // ==========================================
  ai: [
    // Ch1: What is AI?
    function(area) {
      area.innerHTML = `
        <h2>ü§î What is AI?</h2>
        <p class="lesson-desc">AI stands for <strong>Artificial Intelligence</strong>. It's not magic ‚Äî it's pattern matching! AI looks at lots of examples and learns to recognize patterns, just like you learned to recognize cats and dogs when you were little.</p>
        <div class="activity">
          <h3>üéØ Activity: AI or Not AI?</h3>
          <p class="instructions">Drag each item into the correct bucket. Does it use AI or not?</p>
          <div class="drag-zone" id="ai1-items"></div>
          <div class="buckets">
            <div class="bucket" style="border-color:var(--green)" data-on-drop="ai1Drop" data-bucket="yes">
              <h4>‚úÖ Uses AI</h4>
              <div class="bucket-items" id="ai1-yes"></div>
            </div>
            <div class="bucket" style="border-color:var(--red)" data-on-drop="ai1Drop" data-bucket="no">
              <h4>‚ùå No AI</h4>
              <div class="bucket-items" id="ai1-no"></div>
            </div>
          </div>
          <div class="feedback" id="ai1-fb"></div>
          <button class="btn-check" id="ai1-check" onclick="ai1Check()">Check My Answers ‚úì</button>
        </div>
        <div class="activity">
          <h3>üí° Key Idea</h3>
          <p class="instructions">AI is a computer program that learns from examples. It finds patterns in data ‚Äî like how Netflix notices you like action movies and suggests more. AI isn't thinking or feeling ‚Äî it's matching patterns really, really fast!</p>
        </div>
      `;
      const items = [
        {name: 'üîä Alexa / Siri', ai: true}, {name: 'üì∫ Netflix Suggestions', ai: true},
        {name: 'üîç Google Search', ai: true}, {name: 'üì∑ Face Filters', ai: true},
        {name: 'üí° Light Switch', ai: false}, {name: 'üö≤ Bicycle', ai: false},
        {name: 'üìñ Paper Book', ai: false}, {name: 'üéÆ Game NPCs', ai: true},
        {name: '‚è∞ Alarm Clock', ai: false}, {name: 'üó∫Ô∏è Google Maps', ai: true}
      ];
      const container = document.getElementById('ai1-items');
      items.sort(() => Math.random() - 0.5).forEach((item, i) => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = item.name;
        el.dataset.id = i;
        el.dataset.value = item.ai ? 'yes' : 'no';
        container.appendChild(el);
        initDrag(el);
      });
      window.ai1Data = items;
      window.ai1Placed = {};
    },

    // Ch2: How AI Learns
    function(area) {
      area.innerHTML = `
        <h2>üìö How AI Learns</h2>
        <p class="lesson-desc">AI learns in steps, kind of like how you learn! Imagine teaching a friend to recognize different types of pizza. You'd show them lots of pictures, right? AI works the same way ‚Äî it needs LOTS of examples.</p>
        <div class="activity">
          <h3>üß© Activity: Put the Steps in Order</h3>
          <p class="instructions">AI learns in 5 steps. Drag them into the correct order!</p>
          <div class="drag-zone" id="ai2-items"></div>
          <div class="sequence-slots" id="ai2-slots"></div>
          <div class="feedback" id="ai2-fb"></div>
          <button class="btn-check" onclick="ai2Check()">Check Order ‚úì</button>
        </div>
        <div class="activity">
          <h3>üéØ Activity: Train the AI!</h3>
          <p class="instructions">You're training an AI to recognize animals! Drag each picture to the right category.</p>
          <div class="drag-zone" id="ai2-train-items"></div>
          <div class="buckets">
            <div class="bucket" style="border-color:var(--cyan)" data-on-drop="ai2TrainDrop" data-bucket="cat">
              <h4>üê± Cat</h4><div class="bucket-items" id="ai2-cats"></div>
            </div>
            <div class="bucket" style="border-color:var(--purple)" data-on-drop="ai2TrainDrop" data-bucket="dog">
              <h4>üê∂ Dog</h4><div class="bucket-items" id="ai2-dogs"></div>
            </div>
          </div>
          <div class="feedback" id="ai2-train-fb"></div>
          <button class="btn-check" onclick="ai2TrainCheck()">Train the AI! ‚úì</button>
        </div>
      `;
      const steps = ['üìä Collect Data', 'üßπ Clean Data', 'üèãÔ∏è Train Model', 'üß™ Test It', 'üîÑ Improve'];
      const container = document.getElementById('ai2-items');
      const slots = document.getElementById('ai2-slots');
      const shuffled = [...steps].sort(() => Math.random() - 0.5);
      shuffled.forEach((s, i) => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = s;
        el.dataset.value = steps.indexOf(s).toString();
        container.appendChild(el);
        initDrag(el);
      });
      for (let i = 0; i < 5; i++) {
        const slot = document.createElement('div');
        slot.className = 'sequence-slot';
        slot.textContent = `Step ${i + 1}`;
        slot.dataset.onDrop = 'ai2SlotDrop';
        slot.dataset.slot = i;
        slots.appendChild(slot);
      }
      window.ai2Slots = {};

      // Train items
      const animals = [
        {name: 'üò∫ Whiskers', type: 'cat'}, {name: 'üêï Buddy', type: 'dog'},
        {name: 'üêà Mittens', type: 'cat'}, {name: 'üê© Poodle', type: 'dog'},
        {name: 'üò∏ Luna', type: 'cat'}, {name: 'ü¶Æ Rex', type: 'dog'}
      ];
      const trainContainer = document.getElementById('ai2-train-items');
      animals.sort(() => Math.random() - 0.5).forEach((a, i) => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = a.name;
        el.dataset.value = a.type;
        trainContainer.appendChild(el);
        initDrag(el);
      });
      window.ai2TrainPlaced = {};
    },

    // Ch3: Smart vs Wise
    function(area) {
      area.innerHTML = `
        <h2>üß† Smart vs Wise</h2>
        <p class="lesson-desc">AI can be really <strong>smart</strong> (fast at answers) but not always <strong>wise</strong> (knowing when it's wrong). A calculator is smart ‚Äî but it doesn't know if you typed the wrong numbers! Let's practice being WISE about AI.</p>
        <div class="activity">
          <h3>üéØ Activity: What Would You Do?</h3>
          <p class="instructions">An AI gives you an answer. Pick the WISEST response!</p>
          <div id="ai3-scenarios"></div>
        </div>
      `;
      const scenarios = [
        {q: 'AI says: "The capital of France is London" ü§ñ', options: [
          {text: '‚úÖ Trust it! AI is always right', wise: false},
          {text: 'ü§î That doesn\'t sound right, let me check', wise: true},
          {text: '‚ùå AI is useless and always wrong', wise: false}
        ], explain: 'Great thinking! AI can make mistakes. The wise thing is to check ‚Äî the capital of France is Paris! üóº'},
        {q: 'You ask AI to write a birthday card for grandma ü§ñ', options: [
          {text: 'üì§ Send it without reading', wise: false},
          {text: 'üëÄ Read it first and add your own touch', wise: true},
          {text: 'üóëÔ∏è Never use AI for anything', wise: false}
        ], explain: 'Perfect! AI can help you get started, but your personal touch makes it special. Always review what AI creates!'},
        {q: 'AI suggests a "fact" for your school report ü§ñ', options: [
          {text: 'üìù Copy-paste it directly', wise: false},
          {text: 'üîç Check if it\'s true using another source', wise: true},
          {text: 'üò§ Ignore AI and don\'t do the report', wise: false}
        ], explain: 'Exactly! Always verify AI facts with trusted sources. AI can "hallucinate" ‚Äî make up things that sound real but aren\'t!'}
      ];
      const cont = document.getElementById('ai3-scenarios');
      window.ai3Done = 0;
      scenarios.forEach((s, si) => {
        const div = document.createElement('div');
        div.style.cssText = 'margin:20px 0;padding:20px;background:rgba(0,0,0,0.2);border-radius:16px;';
        div.innerHTML = `<p style="font-size:1.1rem;margin-bottom:14px;font-weight:600">${s.q}</p><div class="choice-cards" id="ai3-s${si}"></div><div class="feedback" id="ai3-fb${si}"></div>`;
        cont.appendChild(div);
        const cards = div.querySelector(`#ai3-s${si}`);
        s.options.forEach((o, oi) => {
          const card = document.createElement('div');
          card.className = 'choice-card';
          card.innerHTML = `<p>${o.text}</p>`;
          card.onclick = () => {
            cards.querySelectorAll('.choice-card').forEach(c => {
              c.classList.remove('selected','correct','wrong');
              c.style.pointerEvents = 'none';
            });
            if (o.wise) {
              card.classList.add('correct');
              showFeedback(div, 'success', s.explain);
              addPoints(10);
              window.ai3Done++;
              if (window.ai3Done >= 3) setTimeout(completeChapter, 500);
            } else {
              card.classList.add('wrong');
              showFeedback(div, 'error', 'üí° Hint: The wisest response isn\'t blindly trusting OR ignoring the AI. Think about what a scientist would do ‚Äî they\'d check the data themselves AND consider the AI\'s suggestion. Look for the answer that combines both! ü§î');
              setTimeout(() => {
                cards.querySelectorAll('.choice-card').forEach(c => {
                  c.classList.remove('wrong');
                  c.style.pointerEvents = '';
                });
              }, 1500);
            }
          };
          cards.appendChild(card);
        });
      });
    },

    // Ch4: AI in Your World
    function(area) {
      area.innerHTML = `
        <h2>üåç AI in Your World</h2>
        <p class="lesson-desc">AI is EVERYWHERE ‚Äî hiding in things you use every day! Let's explore a room and discover all the hidden AI. Tap on objects to reveal their secrets!</p>
        <div class="activity">
          <h3>üîç Activity: Find the Hidden AI!</h3>
          <p class="instructions">Tap on objects in this room to discover where AI is hiding! Find all 8!</p>
          <p style="color:var(--gold);font-size:.9rem" id="ai4-count">Found: 0 / 8</p>
          <div class="scene-container" id="ai4-scene" style="background:linear-gradient(180deg,rgba(15,15,58,0.8),rgba(5,5,16,0.9))"></div>
        </div>
      `;
      const items = [
        {emoji: 'üì±', x: 10, y: 20, name: 'Smartphone', fact: 'Your phone uses AI for face unlock, autocorrect, photo enhancement, and voice assistants!'},
        {emoji: 'üì∫', x: 70, y: 15, name: 'Smart TV', fact: 'Netflix and YouTube use AI to recommend shows you\'ll like based on what you\'ve watched!'},
        {emoji: 'üîä', x: 45, y: 60, name: 'Smart Speaker', fact: 'Alexa, Siri, and Google Home use AI to understand your voice and respond!'},
        {emoji: 'üéÆ', x: 80, y: 55, name: 'Game Console', fact: 'AI controls the enemies in your games, making them smarter and more challenging!'},
        {emoji: '‚ùÑÔ∏è', x: 25, y: 65, name: 'Smart Fridge', fact: 'Some fridges use AI to track what food you have and suggest recipes!'},
        {emoji: 'üöó', x: 55, y: 80, name: 'Car', fact: 'Modern cars use AI for self-driving features, parking assist, and collision warnings!'},
        {emoji: 'üíª', x: 35, y: 35, name: 'Laptop', fact: 'AI powers spam filters, search engines, grammar checkers, and photo editors!'},
        {emoji: 'üè†', x: 60, y: 30, name: 'Thermostat', fact: 'Smart thermostats learn your schedule and preferences to save energy!'}
      ];
      const scene = document.getElementById('ai4-scene');
      window.ai4Found = 0;
      items.forEach((item, i) => {
        const el = document.createElement('div');
        el.className = 'scene-item';
        el.textContent = item.emoji;
        el.style.left = item.x + '%'; el.style.top = item.y + '%';
        el.onclick = () => {
          if (el.classList.contains('discovered')) return;
          el.classList.add('discovered');
          window.ai4Found++;
          document.getElementById('ai4-count').textContent = `Found: ${window.ai4Found} / 8`;
          addPoints(5);
          // Show popup
          const popup = document.createElement('div');
          popup.className = 'scene-popup show';
          popup.innerHTML = `<h5>${item.name}</h5><p>${item.fact}</p>`;
          popup.style.left = Math.min(item.x, 60) + '%';
          popup.style.top = (item.y + 8) + '%';
          scene.appendChild(popup);
          setTimeout(() => popup.remove(), 4000);
          if (window.ai4Found >= 8) setTimeout(completeChapter, 1000);
        };
        scene.appendChild(el);
      });
    },

    // Ch5: Asking Better Questions
    function(area) {
      area.innerHTML = `
        <h2>‚ùì Asking Better Questions</h2>
        <p class="lesson-desc">The SECRET to getting great answers from AI? Ask great questions! Vague questions get vague answers. Specific questions get amazing answers. Let's practice making questions better!</p>
        <div class="activity">
          <h3>üéØ Activity: Question Builder</h3>
          <p class="instructions">Start with a boring question and make it AWESOME by adding word blocks!</p>
          <div id="ai5-builder"></div>
        </div>
      `;
      const challenges = [
        {start: 'Tell me about dogs', blocks: ['What are', 'the 3 best', 'dog breeds', 'for families', 'with young children?'],
          bonus: ['specific number', 'context added', 'audience defined'], answer: 'What are the 3 best dog breeds for families with young children?'},
        {start: 'Help me with homework', blocks: ['Explain', 'how volcanoes erupt', 'in simple words', 'with an example', 'a 10-year-old can understand'],
          answer: 'Explain how volcanoes erupt in simple words with an example a 10-year-old can understand'},
        {start: 'Tell me about space', blocks: ['What are', '5 fun facts about', 'Mars', 'that would surprise', 'my classmates?'],
          answer: 'What are 5 fun facts about Mars that would surprise my classmates?'}
      ];
      const cont = document.getElementById('ai5-builder');
      window.ai5Done = 0;
      challenges.forEach((ch, ci) => {
        const div = document.createElement('div');
        div.style.cssText = 'margin:20px 0;padding:24px;background:rgba(0,0,0,0.2);border-radius:16px;';
        div.innerHTML = `
          <p style="color:var(--text3);font-size:.85rem;margin-bottom:4px">Boring question:</p>
          <p style="font-size:1.1rem;margin-bottom:16px;color:var(--red);text-decoration:line-through">"${ch.start}"</p>
          <p style="color:var(--text3);font-size:.85rem;margin-bottom:8px">Build a better question ‚Äî arrange these blocks:</p>
          <div class="drag-zone" id="ai5-blocks-${ci}"></div>
          <p style="color:var(--text3);font-size:.85rem;margin:12px 0 4px">Your improved question:</p>
          <div class="drag-zone" id="ai5-target-${ci}" data-on-drop="ai5Drop" data-challenge="${ci}" style="min-height:50px;border-color:var(--cyan)">
            <span class="drag-zone-label">Drop blocks here in order</span>
          </div>
          <div class="feedback" id="ai5-fb-${ci}"></div>
          <button class="btn-check" onclick="ai5Check(${ci})">Check ‚úì</button>
        `;
        cont.appendChild(div);
        const blocksZone = document.getElementById(`ai5-blocks-${ci}`);
        const shuffled = [...ch.blocks].sort(() => Math.random() - 0.5);
        shuffled.forEach((b, bi) => {
          const el = document.createElement('div');
          el.className = 'drag-item';
          el.textContent = b;
          el.dataset.value = ch.blocks.indexOf(b).toString();
          el.dataset.challenge = ci;
          blocksZone.appendChild(el);
          initDrag(el);
        });
      });
      window.ai5Challenges = challenges;
    },

    // Ch6: When AI Gets It Wrong
    function(area) {
      area.innerHTML = `
        <h2>‚ùå When AI Gets It Wrong</h2>
        <p class="lesson-desc">AI isn't perfect! It can make mistakes, be biased, or even make things up entirely (we call these "hallucinations"). Your job? Be a fact-checker! Let's play Spot the Mistake!</p>
        <div class="activity">
          <h3>üîç Activity: Spot the Mistake!</h3>
          <p class="instructions">The AI made these statements. Drag each one to ‚úÖ (correct) or ‚ùå (wrong)!</p>
          <div class="drag-zone" id="ai6-items"></div>
          <div class="buckets">
            <div class="bucket" style="border-color:var(--green)" data-on-drop="ai6Drop" data-bucket="true">
              <h4>‚úÖ Correct</h4><div class="bucket-items" id="ai6-true"></div>
            </div>
            <div class="bucket" style="border-color:var(--red)" data-on-drop="ai6Drop" data-bucket="false">
              <h4>‚ùå Wrong</h4><div class="bucket-items" id="ai6-false"></div>
            </div>
          </div>
          <div class="feedback" id="ai6-fb"></div>
          <button class="btn-check" onclick="ai6Check()">Check Answers ‚úì</button>
        </div>
      `;
      const statements = [
        {text: 'üåç Earth is the 3rd planet from the Sun', correct: true},
        {text: 'ü¶ï Dinosaurs and humans lived together', correct: false},
        {text: 'üíß Water boils at 100¬∞C', correct: true},
        {text: 'üåô The Moon is bigger than Earth', correct: false},
        {text: '‚ù§Ô∏è The heart pumps blood through your body', correct: true},
        {text: 'üêß Penguins can fly long distances', correct: false},
        {text: '‚òÄÔ∏è The Sun is a star', correct: true},
        {text: 'üß† Humans only use 10% of their brains', correct: false}
      ];
      const container = document.getElementById('ai6-items');
      statements.sort(() => Math.random() - 0.5).forEach((s, i) => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = s.text;
        el.dataset.value = s.correct.toString();
        container.appendChild(el);
        initDrag(el);
      });
      window.ai6Placed = {};
    },

    // Ch7: AI Ethics & Fairness
    function(area) {
      area.innerHTML = `
        <h2>‚öñÔ∏è AI Ethics & Fairness</h2>
        <p class="lesson-desc">AI is only as fair as the data it learns from. If we teach AI with biased examples, it makes biased decisions. Let's explore some real scenarios and think about what's right!</p>
        <div class="activity">
          <h3>üéØ Activity: Fix the Unfair AI</h3>
          <p class="instructions">Read each scenario and pick the best solution!</p>
          <div id="ai7-scenarios"></div>
        </div>
      `;
      const scenarios = [
        {title: 'üè´ The Team Picker', problem: 'An AI picks students for the science team, but it always picks boys. It learned from old data where only boys were on the team.',
          options: [
            {text: 'üîÑ Retrain with fair data showing all students', correct: true},
            {text: 'ü§∑ It\'s fine, that\'s what the data says', correct: false},
            {text: 'üóëÔ∏è Never use AI for anything', correct: false}
          ], explain: 'Yes! The AI learned bias from old, unfair data. We need to train it with diverse, fair examples!'},
        {title: 'üì∏ The Photo App', problem: 'A photo filter app only works well on light skin tones. It makes dark skin look weird.',
          options: [
            {text: 'üìä Train it with photos of ALL skin tones equally', correct: true},
            {text: 'üìù Just add a warning label', correct: false},
            {text: 'üö´ Ban all photo filters', correct: false}
          ], explain: 'Exactly! AI needs diverse training data. If it only saw some skin tones, it won\'t work for everyone.'},
        {title: 'üè† The House Pricer', problem: 'An AI that prices houses always gives lower prices to homes in certain neighborhoods. It learned from historical data that was affected by discrimination.',
          options: [
            {text: 'üßπ Remove biased historical data and use fair criteria', correct: true},
            {text: '‚úÖ Historical data is always correct', correct: false},
            {text: 'üí∞ Just raise all prices', correct: false}
          ], explain: 'Right! Historical data can contain past discrimination. We need to clean the data and ensure AI decisions are fair!'}
      ];
      const cont = document.getElementById('ai7-scenarios');
      window.ai7Done = 0;
      scenarios.forEach((s, si) => {
        const div = document.createElement('div');
        div.style.cssText = 'margin:20px 0;padding:24px;background:rgba(0,0,0,0.2);border-radius:16px;';
        div.innerHTML = `<h4 style="margin-bottom:8px">${s.title}</h4><p style="color:var(--text2);margin-bottom:14px">${s.problem}</p><div class="choice-cards" id="ai7-s${si}"></div><div class="feedback" id="ai7-fb${si}"></div>`;
        cont.appendChild(div);
        s.options.forEach((o, oi) => {
          const card = document.createElement('div');
          card.className = 'choice-card';
          card.innerHTML = `<p>${o.text}</p>`;
          card.onclick = () => {
            div.querySelectorAll('.choice-card').forEach(c => { c.classList.remove('selected','correct','wrong'); c.style.pointerEvents = 'none'; });
            if (o.correct) {
              card.classList.add('correct');
              showFeedback(div, 'success', s.explain);
              addPoints(10);
              window.ai7Done++;
              if (window.ai7Done >= 3) setTimeout(completeChapter, 500);
            } else {
              card.classList.add('wrong');
              showFeedback(div, 'error', 'üí° Hint: Fairness means the AI should treat ALL people equally regardless of gender, race, or background. Look for the solution that fixes the BIAS in the AI\'s decision-making, not just the symptoms. Ask yourself: "Would this fix make it fair for everyone?" ü§î');
              setTimeout(() => { div.querySelectorAll('.choice-card').forEach(c => { c.classList.remove('wrong'); c.style.pointerEvents = ''; }); }, 1500);
            }
          };
          div.querySelector(`#ai7-s${si}`).appendChild(card);
        });
      });
    },

    // Ch8: Be the AI Boss
    function(area) {
      area.innerHTML = `
        <h2>üëë Be the AI Boss ‚Äî Capstone!</h2>
        <p class="lesson-desc">Time to design your very own AI assistant! You're the boss ‚Äî YOU decide what it does, what rules it follows, and what it should NEVER do.</p>
        <div class="activity">
          <h3>ü§ñ Step 1: What does your AI do?</h3>
          <p class="instructions">Pick your AI's main job:</p>
          <div class="choice-cards" id="ai8-job"></div>
        </div>
        <div class="activity" id="ai8-step2" style="display:none">
          <h3>üìã Step 2: Set the Rules</h3>
          <p class="instructions">Drag rules into your AI's rule book:</p>
          <div class="drag-zone" id="ai8-rules-source"></div>
          <div class="drag-zone" id="ai8-rules-target" data-on-drop="ai8RuleDrop" style="min-height:80px;border-color:var(--green)">
            <span class="drag-zone-label">üìã AI Rule Book</span>
          </div>
        </div>
        <div class="activity" id="ai8-step3" style="display:none">
          <h3>üö´ Step 3: Set Boundaries</h3>
          <p class="instructions">What should your AI NEVER do? Pick at least 2:</p>
          <div class="choice-cards" id="ai8-never"></div>
        </div>
        <div id="ai8-result" style="display:none;text-align:center;padding:30px">
          <h3 style="font-size:1.5rem;margin-bottom:16px">üéâ Your AI Assistant!</h3>
          <div id="ai8-card" class="glass" style="display:inline-block;padding:30px;max-width:400px;text-align:left"></div>
        </div>
      `;
      const jobs = [
        {emoji: 'üìö', name: 'Homework Helper', desc: 'Helps explain difficult topics'},
        {emoji: 'üéµ', name: 'Music DJ', desc: 'Plays and suggests music'},
        {emoji: 'üòÇ', name: 'Joke Teller', desc: 'Tells funny jokes and stories'},
        {emoji: 'üèãÔ∏è', name: 'Fitness Coach', desc: 'Helps you stay active and healthy'}
      ];
      const jobCont = document.getElementById('ai8-job');
      window.ai8State = {job: null, rules: [], nevers: []};
      jobs.forEach(j => {
        const card = document.createElement('div');
        card.className = 'choice-card';
        card.innerHTML = `<span class="emoji">${j.emoji}</span><p><strong>${j.name}</strong></p><p style="font-size:.8rem;color:var(--text2)">${j.desc}</p>`;
        card.onclick = () => {
          jobCont.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          window.ai8State.job = j;
          document.getElementById('ai8-step2').style.display = '';
          addPoints(5);
        };
        jobCont.appendChild(card);
      });
      // Rules
      const rules = ['ü§ù Always be kind', 'üìñ Be honest', 'üîí Ask before sharing info', 'üéØ Stay on topic', 'üëÇ Listen carefully', '‚è∞ Know when to stop'];
      const rulesSrc = document.getElementById('ai8-rules-source');
      rules.forEach(r => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = r;
        el.dataset.value = r;
        rulesSrc.appendChild(el);
        initDrag(el);
      });
      // Nevers
      const nevers = ['üö´ Never lie or make up facts', 'üö´ Never share personal info', 'üö´ Never be mean or bully', 'üö´ Never make decisions without asking', 'üö´ Never pretend to be human', 'üö´ Never ignore safety'];
      setTimeout(() => {
        const neverCont = document.getElementById('ai8-never');
        let neverCount = 0;
        nevers.forEach(n => {
          const card = document.createElement('div');
          card.className = 'choice-card';
          card.innerHTML = `<p>${n}</p>`;
          card.onclick = () => {
            if (card.classList.contains('selected')) {
              card.classList.remove('selected');
              window.ai8State.nevers = window.ai8State.nevers.filter(x => x !== n);
              neverCount--;
            } else {
              card.classList.add('selected');
              window.ai8State.nevers.push(n);
              neverCount++;
              addPoints(3);
            }
            if (neverCount >= 2 && window.ai8State.job && window.ai8State.rules.length >= 2) {
              showAi8Result();
            }
          };
          neverCont.appendChild(card);
        });
      }, 100);
    }
  ],

  // ==========================================
  // SPACE EXPLORERS
  // ==========================================
  space: [
    // Ch1: Our Solar System
    function(area) {
      area.innerHTML = `
        <h2>ü™ê Our Solar System</h2>
        <p class="lesson-desc">Welcome to the cosmic neighborhood! Our solar system has 8 amazing planets orbiting the Sun. Tap on each planet to discover incredible facts, then put them in the right order!</p>
        <div class="activity">
          <h3>üåü Explore the Planets!</h3>
          <p class="instructions">Tap each planet to learn about it! <span id="sp1-count" style="color:var(--gold)">Explored: 0/8</span></p>
          <div class="solar-system" id="sp1-system"></div>
        </div>
        <div class="activity">
          <h3>üß© Activity: Order the Planets!</h3>
          <p class="instructions">Drag the planets into order from closest to the Sun ‚òÄÔ∏è</p>
          <div class="drag-zone" id="sp1-items"></div>
          <div class="sequence-slots" id="sp1-slots"></div>
          <div class="feedback" id="sp1-fb"></div>
          <button class="btn-check" onclick="sp1Check()">Check Order ‚úì</button>
        </div>
      `;
      const planets = [
        {name:'Mercury',emoji:'‚ö´',color:'#8b8b8b',x:18,y:45,size:22,facts:'Closest to Sun ‚Ä¢ 167¬∞C average ‚Ä¢ No moons ‚Ä¢ Smallest planet ‚Ä¢ A year is just 88 Earth days!'},
        {name:'Venus',emoji:'üü°',color:'#e6c44d',x:25,y:30,size:28,facts:'Hottest planet at 462¬∞C! ‚Ä¢ Spins backwards ‚Ä¢ Similar size to Earth ‚Ä¢ Thick clouds of acid ‚Ä¢ A day is longer than its year!'},
        {name:'Earth',emoji:'üåç',color:'#4d94ff',x:33,y:60,size:28,facts:'Our home! ‚Ä¢ Only planet with liquid water on surface ‚Ä¢ 1 Moon ‚Ä¢ Perfect distance from Sun for life ‚Ä¢ 4.5 billion years old'},
        {name:'Mars',emoji:'üî¥',color:'#c1440e',x:42,y:35,size:24,facts:'The Red Planet ‚Ä¢ Has the biggest volcano (Olympus Mons) ‚Ä¢ 2 tiny moons ‚Ä¢ NASA\'s rovers explore it ‚Ä¢ Might have had water!'},
        {name:'Jupiter',emoji:'üü§',color:'#c88b3a',x:54,y:50,size:44,facts:'Biggest planet! ‚Ä¢ 79+ moons ‚Ä¢ Great Red Spot is a storm bigger than Earth ‚Ä¢ Made of gas ‚Ä¢ Could fit 1,300 Earths inside!'},
        {name:'Saturn',emoji:'ü™ê',color:'#e8d5a3',x:66,y:25,size:40,facts:'Famous rings made of ice and rock ‚Ä¢ 82+ moons ‚Ä¢ So light it could float in water! ‚Ä¢ Rings are 282,000 km wide but only 10 m thick!'},
        {name:'Uranus',emoji:'üîµ',color:'#4dc9f6',x:77,y:55,size:32,facts:'Ice giant! ‚Ä¢ Tilted on its side (98¬∞!) ‚Ä¢ 27 moons ‚Ä¢ -224¬∞C cold ‚Ä¢ Takes 84 Earth years to orbit the Sun'},
        {name:'Neptune',emoji:'üîµ',color:'#4444ff',x:88,y:40,size:30,facts:'Farthest planet ‚Ä¢ Strongest winds (2,100 km/h!) ‚Ä¢ 14 moons ‚Ä¢ Deep blue color ‚Ä¢ Takes 165 years to orbit the Sun'}
      ];
      // Solar system explorer
      const sys = document.getElementById('sp1-system');
      sys.innerHTML = '<div style="position:absolute;left:6%;top:50%;transform:translateY(-50%);font-size:3rem">‚òÄÔ∏è</div>';
      window.sp1Explored = 0;
      planets.forEach((p, i) => {
        const el = document.createElement('div');
        el.className = 'planet';
        el.style.cssText = `left:${p.x}%;top:${p.y}%;width:${p.size}px;height:${p.size}px;background:${p.color};font-size:${p.size*0.6}px;`;
        el.textContent = p.emoji;
        el.onclick = () => {
          if (!el.classList.contains('discovered')) {
            el.classList.add('discovered');
            window.sp1Explored++;
            document.getElementById('sp1-count').textContent = `Explored: ${window.sp1Explored}/8`;
            addPoints(3);
          }
          document.querySelectorAll('.scene-popup').forEach(x => x.remove());
          const popup = document.createElement('div');
          popup.className = 'scene-popup show';
          popup.innerHTML = `<h5>${p.name} ${p.emoji}</h5><p>${p.facts}</p>`;
          popup.style.cssText = `left:${Math.min(p.x, 60)}%;top:${Math.min(p.y + 10, 75)}%;`;
          sys.appendChild(popup);
          setTimeout(() => popup.remove(), 5000);
        };
        sys.appendChild(el);
      });
      // Order puzzle
      const order = ['Mercury','Venus','Earth','Mars','Jupiter','Saturn','Uranus','Neptune'];
      const itemsCont = document.getElementById('sp1-items');
      const slotsCont = document.getElementById('sp1-slots');
      const shuffled = [...planets].sort(() => Math.random() - 0.5);
      shuffled.forEach((p, i) => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = `${p.emoji} ${p.name}`;
        el.dataset.value = order.indexOf(p.name).toString();
        itemsCont.appendChild(el);
        initDrag(el);
      });
      for (let i = 0; i < 8; i++) {
        const slot = document.createElement('div');
        slot.className = 'sequence-slot';
        slot.textContent = i === 0 ? '‚òÄÔ∏è Closest' : i === 7 ? 'Farthest' : `#${i+1}`;
        slot.dataset.onDrop = 'sp1SlotDrop';
        slot.dataset.slot = i;
        slotsCont.appendChild(slot);
      }
      window.sp1Slots = {};
    },

    // Ch2: Life of a Star
    function(area) {
      area.innerHTML = `
        <h2>‚≠ê Life of a Star</h2>
        <p class="lesson-desc">Stars are born, live, and die ‚Äî just like living things! A star's life can last billions of years. Let's explore the amazing journey of a star!</p>
        <div class="activity">
          <h3>üéØ Activity: Star Lifecycle</h3>
          <p class="instructions">Drag the stages into the correct order to show how a star lives!</p>
          <div class="drag-zone" id="sp2-items"></div>
          <div class="sequence-slots" id="sp2-slots"></div>
          <div class="feedback" id="sp2-fb"></div>
          <button class="btn-check" onclick="sp2Check()">Check ‚úì</button>
        </div>
        <div class="activity">
          <h3>üí° Star Facts</h3>
          <div class="card-grid" id="sp2-cards"></div>
        </div>
      `;
      const stages = ['üå´Ô∏è Nebula (Gas Cloud)','‚≠ê Protostar','‚òÄÔ∏è Main Sequence','üî¥ Red Giant','üí• Supernova / White Dwarf'];
      const cont = document.getElementById('sp2-items');
      const slots = document.getElementById('sp2-slots');
      [...stages].sort(() => Math.random() - 0.5).forEach((s, i) => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = s;
        el.dataset.value = stages.indexOf(s).toString();
        cont.appendChild(el);
        initDrag(el);
      });
      for (let i = 0; i < 5; i++) {
        const slot = document.createElement('div');
        slot.className = 'sequence-slot';
        slot.textContent = `Stage ${i+1}`;
        slot.dataset.onDrop = 'sp2SlotDrop';
        slot.dataset.slot = i;
        slots.appendChild(slot);
      }
      window.sp2Slots = {};
      // Flip cards
      const facts = [
        {front:'üå´Ô∏è Nebula',back:'A giant cloud of gas and dust in space. Gravity pulls it together to start forming a star!'},
        {front:'‚òÄÔ∏è Our Sun',back:'Our Sun is a middle-aged star, about 4.6 billion years old. It will live for about 10 billion years total!'},
        {front:'üí• Supernova',back:'When a massive star dies, it EXPLODES! This explosion is called a supernova and is brighter than an entire galaxy!'},
        {front:'‚ö´ Black Hole',back:'If a really massive star explodes, what\'s left can collapse into a black hole ‚Äî where gravity is so strong nothing can escape!'}
      ];
      const cardGrid = document.getElementById('sp2-cards');
      facts.forEach(f => {
        cardGrid.innerHTML += `<div class="flip-card" onclick="this.classList.toggle('flipped')"><div class="flip-card-inner"><div class="flip-card-front"><span class="emoji">${f.front.split(' ')[0]}</span><h4>${f.front}</h4><p style="font-size:.75rem;color:var(--text3)">Tap to reveal!</p></div><div class="flip-card-back"><h5>${f.front}</h5><p>${f.back}</p></div></div></div>`;
      });
    },

    // Ch3: Rockets & Launch Science
    function(area) {
      area.innerHTML = `
        <h2>üöÄ Rockets & Launch Science</h2>
        <p class="lesson-desc">To escape Earth's gravity, we need rockets! Every part of a rocket has a crucial job. Let's build one together!</p>
        <div class="activity">
          <h3>üîß Activity: Build a Rocket!</h3>
          <p class="instructions">Drag rocket parts onto the launch pad in the right order (bottom to top)!</p>
          <div style="display:flex;gap:30px;align-items:start;flex-wrap:wrap;justify-content:center">
            <div>
              <p style="font-size:.85rem;color:var(--text3);margin-bottom:8px">Parts bin:</p>
              <div class="drag-zone" id="sp3-parts" style="flex-direction:column;max-width:250px"></div>
            </div>
            <div>
              <p style="font-size:.85rem;color:var(--text3);margin-bottom:8px">Your Rocket:</p>
              <div class="rocket-frame" id="sp3-rocket"></div>
              <button class="btn-check" id="sp3-launch" onclick="sp3Launch()" style="display:none;width:100%">üöÄ LAUNCH!</button>
            </div>
          </div>
          <div class="feedback" id="sp3-fb"></div>
        </div>
      `;
      const parts = [
        {name:'üî∫ Nose Cone', desc:'Protects the payload from heat and air resistance', slot:0},
        {name:'üì¶ Payload (Satellite)', desc:'What the rocket is carrying to space!', slot:1},
        {name:'‚õΩ Fuel Tank', desc:'Stores fuel and oxidizer for the engines', slot:2},
        {name:'üî• Engine', desc:'Burns fuel to create thrust ‚Äî pushes the rocket UP!', slot:3},
        {name:'‚ñΩ Fins', desc:'Keep the rocket stable and flying straight', slot:4}
      ];
      const partsBin = document.getElementById('sp3-parts');
      const rocketFrame = document.getElementById('sp3-rocket');
      [...parts].sort(() => Math.random() - 0.5).forEach(p => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.innerHTML = `<strong>${p.name}</strong><br><span style="font-size:.75rem;color:var(--text2)">${p.desc}</span>`;
        el.dataset.value = p.slot.toString();
        partsBin.appendChild(el);
        initDrag(el);
      });
      for (let i = 0; i < 5; i++) {
        const slot = document.createElement('div');
        slot.className = 'rocket-slot';
        slot.textContent = i === 0 ? '‚Üê Top' : i === 4 ? '‚Üê Bottom' : `Part ${i+1}`;
        slot.dataset.onDrop = 'sp3Drop';
        slot.dataset.slot = i;
        rocketFrame.appendChild(slot);
      }
      window.sp3Filled = 0;
    },

    // Ch4: Mission to Mars
    function(area) {
      area.innerHTML = `
        <h2>üî¥ Mission to Mars</h2>
        <p class="lesson-desc">You're planning a mission to Mars! But your cargo ship has a weight limit. Choose wisely ‚Äî your crew's survival depends on it!</p>
        <div class="activity">
          <h3>üì¶ Activity: Pack the Cargo!</h3>
          <p class="instructions">Drag supplies into the cargo bay. Weight limit: <strong>1000 kg</strong>. Choose wisely!</p>
          <div class="drag-zone" id="sp4-items" style="gap:8px"></div>
          <div>
            <div class="weight-label"><span>Weight:</span><span id="sp4-weight-text">0 / 1000 kg</span></div>
            <div class="weight-bar"><div class="weight-fill" id="sp4-weight-fill" style="width:0;background:var(--green)"></div></div>
          </div>
          <div class="cargo-bay" data-on-drop="sp4Drop" id="sp4-cargo">
            <span class="drag-zone-label">üöÄ Cargo Bay ‚Äî Drop supplies here!</span>
            <div id="sp4-cargo-items" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px"></div>
          </div>
          <div class="feedback" id="sp4-fb"></div>
          <button class="btn-check" onclick="sp4Check()">Ready for Launch! üöÄ</button>
        </div>
      `;
      const supplies = [
        {name:'ü•´ Food (6 months)',w:200,essential:true},{name:'üíß Water Recycler',w:150,essential:true},
        {name:'ü´Å Oxygen Generator',w:180,essential:true},{name:'üîß Repair Tools',w:80,essential:true},
        {name:'üå± Seeds & Soil',w:60,essential:false},{name:'‚òÄÔ∏è Solar Panels',w:120,essential:true},
        {name:'üì° Communication Radio',w:90,essential:true},{name:'üè• Medical Kit',w:50,essential:true},
        {name:'üéÆ Entertainment System',w:40,essential:false},{name:'üß™ Science Equipment',w:100,essential:false},
        {name:'üõèÔ∏è Sleeping Pods',w:200,essential:false},{name:'üèãÔ∏è Exercise Equipment',w:80,essential:false}
      ];
      const cont = document.getElementById('sp4-items');
      window.sp4Weight = 0;
      window.sp4Cargo = [];
      supplies.forEach((s, i) => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.innerHTML = `${s.name} <span style="font-size:.75rem;color:var(--text3)">${s.w}kg</span>`;
        el.dataset.value = JSON.stringify(s);
        el.dataset.id = i;
        cont.appendChild(el);
        initDrag(el);
      });
    },

    // Ch5: Gravity & Orbits
    function(area) {
      area.innerHTML = `
        <h2>üåÄ Gravity & Orbits</h2>
        <p class="lesson-desc">Gravity is the invisible force that holds the universe together! It's why planets orbit stars, moons orbit planets, and why you don't float away. Let's explore!</p>
        <div class="activity">
          <h3>ü™ê Activity: Orbit Simulator</h3>
          <p class="instructions">Use the sliders to change gravity and see what happens to the planet's orbit!</p>
          <div class="orbit-sim" id="sp5-sim">
            <div class="sun-center">‚òÄÔ∏è</div>
            <div class="orbiting-planet" id="sp5-planet">üåç</div>
          </div>
          <div class="slider-control">
            <label>üåÄ Gravity Strength: <span id="sp5-grav-val">Medium</span></label>
            <input type="range" min="1" max="5" value="3" id="sp5-gravity" oninput="sp5Update()">
          </div>
          <div class="slider-control">
            <label>üìè Distance from Sun: <span id="sp5-dist-val">Medium</span></label>
            <input type="range" min="1" max="5" value="3" id="sp5-distance" oninput="sp5Update()">
          </div>
          <p id="sp5-info" style="text-align:center;color:var(--cyan);margin:12px 0"></p>
        </div>
        <div class="activity">
          <h3>ü§î What Would Happen If...?</h3>
          <div id="sp5-quiz" class="choice-cards"></div>
          <div class="feedback" id="sp5-fb"></div>
        </div>
      `;
      // Orbit animation
      let angle = 0;
      window.sp5Anim = true;
      function animate() {
        if (!window.sp5Anim) return;
        const sim = document.getElementById('sp5-sim');
        if (!sim) { window.sp5Anim = false; return; }
        const grav = parseInt(document.getElementById('sp5-gravity')?.value || 3);
        const dist = parseInt(document.getElementById('sp5-distance')?.value || 3);
        const speed = 0.005 + (grav * 0.008) - (dist * 0.003);
        const radius = 40 + dist * 25;
        angle += speed;
        const planet = document.getElementById('sp5-planet');
        if (planet) {
          const cx = sim.offsetWidth / 2, cy = sim.offsetHeight / 2;
          planet.style.left = (cx + Math.cos(angle) * radius - 12) + 'px';
          planet.style.top = (cy + Math.sin(angle) * radius - 12) + 'px';
        }
        requestAnimationFrame(animate);
      }
      animate();
      window.sp5Update = function() {
        const g = parseInt(document.getElementById('sp5-gravity').value);
        const d = parseInt(document.getElementById('sp5-distance').value);
        const labels = ['Very Low','Low','Medium','High','Very High'];
        document.getElementById('sp5-grav-val').textContent = labels[g-1];
        document.getElementById('sp5-dist-val').textContent = labels[d-1];
        const info = document.getElementById('sp5-info');
        if (g >= 4 && d <= 2) info.textContent = '‚ö†Ô∏è Too close! The planet would be pulled into the Sun!';
        else if (g <= 2 && d >= 4) info.textContent = 'üöÄ The planet flies away! Not enough gravity to hold it!';
        else info.textContent = '‚úÖ Stable orbit! The planet circles the Sun perfectly.';
      };
      // Quiz
      const quiz = document.getElementById('sp5-quiz');
      [{text:'üåç Earth was closer to the Sun', correct:true, emoji:'üî•'},{text:'üåç Earth had less gravity', correct:false, emoji:'ü§î'},{text:'‚òÄÔ∏è The Sun disappeared',correct:false,emoji:'üò±'}].forEach(q => {
        const card = document.createElement('div');
        card.className = 'choice-card';
        card.innerHTML = `<span class="emoji">${q.emoji}</span><p style="font-size:.9rem">${q.text}</p>`;
        card.onclick = () => {
          quiz.querySelectorAll('.choice-card').forEach(c => c.style.pointerEvents = 'none');
          card.classList.add('selected');
          showFeedback(card.closest('.activity'), 'info', q.correct ? 'üî• Correct! Earth would be much hotter, oceans would boil, and life couldn\'t exist as we know it!' : q.emoji === 'ü§î' ? 'With less gravity, the atmosphere would thin out and you could jump super high ‚Äî but it\'d be hard to breathe!' : 'üò± Earth would fly off in a straight line into space! We need the Sun\'s gravity to keep orbiting.');
          addPoints(10);
          setTimeout(completeChapter, 2000);
        };
        quiz.appendChild(card);
      });
    },

    // Ch6: Space AI
    function(area) {
      area.innerHTML = `
        <h2>üõ∏ Space AI</h2>
        <p class="lesson-desc">AI is essential for space exploration! It drives Mars rovers, finds new planets, and helps astronauts on the space station. Let's see how!</p>
        <div class="activity">
          <h3>üéØ Activity: Match AI to Space Problem!</h3>
          <p class="instructions">Drag each AI tool to the space problem it solves!</p>
          <div class="drag-zone" id="sp6-tools"></div>
          <div id="sp6-problems" style="display:grid;gap:12px;margin:16px 0"></div>
          <div class="feedback" id="sp6-fb"></div>
        </div>
      `;
      const matches = [
        {tool:'ü§ñ Self-Driving AI',problem:'Navigate a rover on Mars with 20-minute signal delay',emoji:'üî¥'},
        {tool:'üî≠ Pattern Recognition AI',problem:'Find new planets in telescope data',emoji:'ü™ê'},
        {tool:'ü©∫ Health Monitor AI',problem:'Track astronaut health on long missions',emoji:'üë®‚ÄçüöÄ'},
        {tool:'üì° Communication AI',problem:'Compress and send data across millions of miles',emoji:'üì∂'}
      ];
      const toolsCont = document.getElementById('sp6-tools');
      const probsCont = document.getElementById('sp6-problems');
      window.sp6Matched = 0;
      [...matches].sort(() => Math.random() - 0.5).forEach((m, i) => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = m.tool;
        el.dataset.value = m.tool;
        toolsCont.appendChild(el);
        initDrag(el);
      });
      matches.forEach((m, i) => {
        const prob = document.createElement('div');
        prob.className = 'drag-zone';
        prob.dataset.onDrop = 'sp6Drop';
        prob.dataset.answer = m.tool;
        prob.innerHTML = `<span class="drag-zone-label">${m.emoji} ${m.problem}</span>`;
        probsCont.appendChild(prob);
      });
    },

    // Ch7: Astronaut Training
    function(area) {
      area.innerHTML = `
        <h2>üë®‚ÄçüöÄ Astronaut Training</h2>
        <p class="lesson-desc">Think you have what it takes to be an astronaut? Let's find out! Complete these training challenges!</p>
        <div class="activity">
          <h3>üí™ Challenge 1: Speed Test</h3>
          <p class="instructions">Astronauts need fast reflexes! Tap the circle as many times as you can in 10 seconds!</p>
          <div class="tap-counter" id="sp7-counter">0</div>
          <div class="timer-bar"><div class="timer-fill" id="sp7-timer" style="width:100%"></div></div>
          <div class="tap-area" id="sp7-tap" onclick="sp7Tap()">TAP!</div>
          <button class="btn-check" id="sp7-start" onclick="sp7Start()">Start Challenge! ‚è±Ô∏è</button>
          <div class="feedback" id="sp7-fb1"></div>
        </div>
        <div class="activity">
          <h3>üß† Challenge 2: Emergency Response</h3>
          <p class="instructions">ALARM! There's an oxygen leak on the space station! What do you do FIRST?</p>
          <div class="choice-cards" id="sp7-emergency"></div>
          <div class="feedback" id="sp7-fb2"></div>
        </div>
      `;
      window.sp7Taps = 0;
      window.sp7Running = false;
      window.sp7Tap = function() {
        if (!window.sp7Running) return;
        window.sp7Taps++;
        document.getElementById('sp7-counter').textContent = window.sp7Taps;
        gsap.to('#sp7-tap', {scale: 0.9, duration: 0.05, yoyo: true, repeat: 1});
      };
      window.sp7Start = function() {
        window.sp7Taps = 0; window.sp7Running = true;
        document.getElementById('sp7-counter').textContent = '0';
        document.getElementById('sp7-start').style.display = 'none';
        let time = 10;
        const interval = setInterval(() => {
          time -= 0.1;
          document.getElementById('sp7-timer').style.width = (time / 10 * 100) + '%';
          if (time <= 0) {
            clearInterval(interval);
            window.sp7Running = false;
            const msg = window.sp7Taps >= 50 ? 'üèÜ AMAZING! You\'d make an incredible astronaut!' : window.sp7Taps >= 30 ? 'üåü Great reflexes! You passed!' : 'üí™ Keep practicing! Astronauts train every day!';
            showFeedback(document.getElementById('sp7-fb1').parentElement, 'success', `${msg} (${window.sp7Taps} taps)`);
            addPoints(Math.min(window.sp7Taps, 30));
          }
        }, 100);
      };
      // Emergency
      const choices = [
        {text:'üò± Panic and scream', correct:false},
        {text:'üéØ Put on oxygen mask, then seal the leak', correct:true},
        {text:'üì∏ Take a photo for social media', correct:false},
        {text:'üò¥ Go back to sleep', correct:false}
      ];
      const emCont = document.getElementById('sp7-emergency');
      choices.forEach(c => {
        const card = document.createElement('div');
        card.className = 'choice-card';
        card.innerHTML = `<p>${c.text}</p>`;
        card.onclick = () => {
          emCont.querySelectorAll('.choice-card').forEach(x => x.style.pointerEvents = 'none');
          card.classList.add(c.correct ? 'correct' : 'wrong');
          showFeedback(emCont.parentElement, c.correct ? 'success' : 'error', c.correct ? '‚úÖ Perfect! In emergencies: Protect yourself first (oxygen mask), then fix the problem. Stay calm!' : '‚ùå In space emergencies, stay calm! The correct answer: Put on oxygen mask first, then seal the leak.');
          if (c.correct) { addPoints(15); setTimeout(completeChapter, 1500); }
          else setTimeout(() => { emCont.querySelectorAll('.choice-card').forEach(x => { x.classList.remove('wrong'); x.style.pointerEvents = ''; }); }, 2000);
        };
        emCont.appendChild(card);
      });
    },

    // Ch8: Design Your Space Mission
    function(area) {
      area.innerHTML = `
        <h2>üìã Design Your Space Mission ‚Äî Capstone!</h2>
        <p class="lesson-desc">Time to plan YOUR space mission! Pick a destination, assemble your crew, and choose your equipment.</p>
        <div class="activity">
          <h3>üéØ Step 1: Pick Your Destination</h3>
          <div class="choice-cards" id="sp8-dest"></div>
        </div>
        <div class="activity" id="sp8-step2" style="display:none">
          <h3>üë• Step 2: Assemble Your Crew</h3>
          <p class="instructions">Drag crew members to your ship (pick 4):</p>
          <div class="drag-zone" id="sp8-crew-src"></div>
          <div class="drag-zone" id="sp8-crew-target" data-on-drop="sp8CrewDrop" style="min-height:60px;border-color:var(--cyan)">
            <span class="drag-zone-label">üöÄ Your Crew</span>
          </div>
        </div>
        <div class="activity" id="sp8-step3" style="display:none">
          <h3>üîß Step 3: Choose Equipment</h3>
          <div class="choice-cards" id="sp8-equip"></div>
        </div>
        <div id="sp8-result" style="display:none;text-align:center;padding:30px"></div>
      `;
      const destinations = [
        {emoji:'üåô',name:'The Moon',desc:'3 days away ‚Ä¢ Low gravity ‚Ä¢ Practice base'},
        {emoji:'üî¥',name:'Mars',desc:'7 months away ‚Ä¢ Thin atmosphere ‚Ä¢ Build a colony'},
        {emoji:'üßä',name:'Europa',desc:'6 years away ‚Ä¢ Ice moon of Jupiter ‚Ä¢ Ocean beneath?'},
        {emoji:'üå´Ô∏è',name:'Titan',desc:'7 years away ‚Ä¢ Saturn\'s moon ‚Ä¢ Has lakes!'}
      ];
      const destCont = document.getElementById('sp8-dest');
      window.sp8State = {dest:null,crew:[],equip:[]};
      destinations.forEach(d => {
        const card = document.createElement('div');
        card.className = 'choice-card';
        card.innerHTML = `<span class="emoji">${d.emoji}</span><p><strong>${d.name}</strong></p><p style="font-size:.8rem;color:var(--text2)">${d.desc}</p>`;
        card.onclick = () => {
          destCont.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          window.sp8State.dest = d;
          document.getElementById('sp8-step2').style.display = '';
          addPoints(5);
        };
        destCont.appendChild(card);
      });
      // Crew
      const crew = ['üë©‚Äç‚úàÔ∏è Commander','üë®‚Äçüî¨ Scientist','üë©‚Äç‚öïÔ∏è Doctor','üßë‚Äçüîß Engineer','üë®‚Äçüç≥ Chef','üßë‚Äçüíª AI Specialist'];
      const crewSrc = document.getElementById('sp8-crew-src');
      crew.forEach(c => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = c;
        el.dataset.value = c;
        crewSrc.appendChild(el);
        initDrag(el);
      });
      // Equipment
      const equip = ['üî≠ Telescope','üõ∞Ô∏è Satellite Relay','üß™ Lab Equipment','‚õèÔ∏è Drilling Rig','üè† Habitat Module','üå± Greenhouse'];
      setTimeout(() => {
        const equipCont = document.getElementById('sp8-equip');
        let equipCount = 0;
        equip.forEach(e => {
          const card = document.createElement('div');
          card.className = 'choice-card';
          card.innerHTML = `<p>${e}</p>`;
          card.onclick = () => {
            card.classList.toggle('selected');
            if (card.classList.contains('selected')) {
              window.sp8State.equip.push(e); equipCount++;
              addPoints(3);
            } else {
              window.sp8State.equip = window.sp8State.equip.filter(x => x !== e); equipCount--;
            }
            if (equipCount >= 3 && window.sp8State.crew.length >= 3 && window.sp8State.dest) {
              const result = document.getElementById('sp8-result');
              result.style.display = '';
              result.innerHTML = `<div class="chapter-complete show"><span class="emoji">üöÄ</span><h3>Mission ${window.sp8State.dest.name} is GO!</h3><p>Destination: ${window.sp8State.dest.emoji} ${window.sp8State.dest.name}<br>Crew: ${window.sp8State.crew.join(', ')}<br>Equipment: ${window.sp8State.equip.join(', ')}</p></div>`;
              setTimeout(completeChapter, 1000);
            }
          };
          equipCont.appendChild(card);
        });
      }, 100);
    }
  ],

  // ==========================================
  // ROBOTICS LAB
  // ==========================================
  robotics: [
    // Ch1: What is a Robot?
    function(area) {
      area.innerHTML = `
        <h2>ü§ñ What is a Robot?</h2>
        <p class="lesson-desc">A robot is a machine that can <strong>Sense</strong> the world, <strong>Think</strong> about what to do, and <strong>Act</strong> on its decisions. Not everything that moves is a robot! Let's sort it out.</p>
        <div class="activity">
          <h3>üéØ Activity: Robot or Not?</h3>
          <p class="instructions">Drag each item into the correct category!</p>
          <div class="drag-zone" id="rb1-items"></div>
          <div class="buckets">
            <div class="bucket" style="border-color:var(--green)" data-on-drop="rb1Drop" data-bucket="yes">
              <h4>ü§ñ Robot</h4><div class="bucket-items" id="rb1-yes"></div>
            </div>
            <div class="bucket" style="border-color:var(--red)" data-on-drop="rb1Drop" data-bucket="no">
              <h4>‚ùå Not a Robot</h4><div class="bucket-items" id="rb1-no"></div>
            </div>
          </div>
          <div class="feedback" id="rb1-fb"></div>
          <button class="btn-check" onclick="rb1Check()">Check ‚úì</button>
        </div>
        <div class="activity">
          <h3>üí° The 3 Rules of Robots</h3>
          <div class="card-grid">
            <div class="flip-card" onclick="this.classList.toggle('flipped')"><div class="flip-card-inner"><div class="flip-card-front"><span class="emoji">üëÅÔ∏è</span><h4>1. SENSE</h4></div><div class="flip-card-back"><h5>Sense</h5><p>Robots use sensors (cameras, microphones, touch) to detect the world around them.</p></div></div></div>
            <div class="flip-card" onclick="this.classList.toggle('flipped')"><div class="flip-card-inner"><div class="flip-card-front"><span class="emoji">üß†</span><h4>2. THINK</h4></div><div class="flip-card-back"><h5>Think</h5><p>A computer brain processes sensor data and decides what to do next.</p></div></div></div>
            <div class="flip-card" onclick="this.classList.toggle('flipped')"><div class="flip-card-inner"><div class="flip-card-front"><span class="emoji">‚ö°</span><h4>3. ACT</h4></div><div class="flip-card-back"><h5>Act</h5><p>Motors, speakers, or lights carry out the robot's decisions in the real world.</p></div></div></div>
          </div>
        </div>
      `;
      const items = [
        {name:'ü§ñ Roomba Vacuum', robot:true},{name:'üöó Self-Driving Car', robot:true},
        {name:'üí° Regular Light Bulb', robot:false},{name:'ü§ñ Mars Rover', robot:true},
        {name:'üß∏ Teddy Bear', robot:false},{name:'ü¶æ Factory Arm', robot:true},
        {name:'üìñ Book', robot:false},{name:'üê∂ Robot Dog (Spot)', robot:true},
        {name:'üö≤ Bicycle', robot:false},{name:'üè• Surgery Robot', robot:true}
      ];
      const cont = document.getElementById('rb1-items');
      items.sort(() => Math.random() - 0.5).forEach((item, i) => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = item.name;
        el.dataset.value = item.robot ? 'yes' : 'no';
        cont.appendChild(el);
        initDrag(el);
      });
      window.rb1Placed = {};
    },

    // Ch2: Robot Senses (Sensors)
    function(area) {
      area.innerHTML = `
        <h2>üëÅÔ∏è Robot Senses (Sensors)</h2>
        <p class="lesson-desc">Robots "sense" the world using sensors ‚Äî special devices that detect light, sound, distance, temperature, and more. Let's match sensors to situations!</p>
        <div class="activity">
          <h3>üéØ Activity: Match the Sensor!</h3>
          <p class="instructions">Drag each sensor to the situation where it would be used!</p>
          <div class="drag-zone" id="rb2-sensors"></div>
          <div id="rb2-situations" style="display:grid;gap:12px;margin:16px 0"></div>
          <div class="feedback" id="rb2-fb"></div>
        </div>
      `;
      const matches = [
        {sensor:'üì∑ Camera',situation:'A robot needs to recognize faces',emoji:'üë§'},
        {sensor:'üé§ Microphone',situation:'A robot needs to hear voice commands',emoji:'üó£Ô∏è'},
        {sensor:'üìè Distance Sensor',situation:'A robot needs to avoid walls',emoji:'üß±'},
        {sensor:'üå°Ô∏è Temperature Sensor',situation:'A robot checks if food is cooked',emoji:'üç≥'},
        {sensor:'üëÜ Touch Sensor',situation:'A robot detects when someone presses a button',emoji:'üîò'}
      ];
      const sensorCont = document.getElementById('rb2-sensors');
      const sitCont = document.getElementById('rb2-situations');
      window.rb2Matched = 0;
      [...matches].sort(() => Math.random() - 0.5).forEach(m => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = m.sensor;
        el.dataset.value = m.sensor;
        sensorCont.appendChild(el);
        initDrag(el);
      });
      matches.forEach(m => {
        const zone = document.createElement('div');
        zone.className = 'drag-zone';
        zone.dataset.onDrop = 'rb2Drop';
        zone.dataset.answer = m.sensor;
        zone.innerHTML = `<span class="drag-zone-label">${m.emoji} ${m.situation}</span>`;
        sitCont.appendChild(zone);
      });
    },

    // Ch3: Robot Brain (How They Think)
    function(area) {
      area.innerHTML = `
        <h2>üß† Robot Brain (How They Think)</h2>
        <p class="lesson-desc">Robots think using simple rules: IF something happens, THEN do this, ELSE do that. Let's build a robot brain using visual logic blocks!</p>
        <div class="activity">
          <h3>üß© Activity: Build Robot Logic!</h3>
          <p class="instructions">Drag blocks to build the robot's decision-making rules. Make the robot navigate around obstacles!</p>
          <div class="block-palette" id="rb3-palette"></div>
          <p style="font-size:.85rem;color:var(--text3);margin:8px 0">Drop blocks here to build your logic:</p>
          <div class="flowchart-area" id="rb3-flow" data-on-drop="rb3Drop"></div>
          <div class="feedback" id="rb3-fb"></div>
          <button class="btn-check" onclick="rb3Check()">Test Logic ‚úì</button>
        </div>
      `;
      const blocks = [
        {text:'IF obstacle ahead', type:'block-if'},
        {text:'THEN turn right', type:'block-then'},
        {text:'ELSE go forward', type:'block-else'},
        {text:'IF path clear', type:'block-if'},
        {text:'THEN go forward', type:'block-then'},
        {text:'ELSE stop', type:'block-else'}
      ];
      const palette = document.getElementById('rb3-palette');
      window.rb3Blocks = [];
      blocks.forEach((b, i) => {
        const el = document.createElement('div');
        el.className = `block ${b.type}`;
        el.textContent = b.text;
        el.dataset.value = b.text;
        el.dataset.id = i;
        palette.appendChild(el);
        initDrag(el);
      });
    },

    // Ch4: Robot Movement
    function(area) {
      area.innerHTML = `
        <h2>üïπÔ∏è Robot Movement</h2>
        <p class="lesson-desc">Let's program a robot to navigate through a maze using command blocks! No typing ‚Äî just drag arrows!</p>
        <div class="activity">
          <h3>ü§ñ Activity: Navigate the Maze!</h3>
          <p class="instructions">Use the arrow buttons to build a path. Then hit RUN to watch your robot go!</p>
          <div id="rb4-maze" class="maze-grid" style="grid-template-columns:repeat(7,40px)"></div>
          <div class="command-builder">
            <div class="cmd-block" onclick="rb4Add('‚Üë')">‚¨ÜÔ∏è</div>
            <div class="cmd-block" onclick="rb4Add('‚Üì')">‚¨áÔ∏è</div>
            <div class="cmd-block" onclick="rb4Add('‚Üê')">‚¨ÖÔ∏è</div>
            <div class="cmd-block" onclick="rb4Add('‚Üí')">‚û°Ô∏è</div>
            <div class="cmd-block" style="background:rgba(239,68,68,0.2);border-color:var(--red)" onclick="rb4Clear()">üóëÔ∏è</div>
          </div>
          <div class="command-sequence" id="rb4-seq"></div>
          <button class="btn-check" onclick="rb4Run()">‚ñ∂Ô∏è Run Program!</button>
          <div class="feedback" id="rb4-fb"></div>
        </div>
      `;
      // Simple maze: 0=path, 1=wall, 2=robot start, 3=goal
      const maze = [
        [1,1,1,1,1,1,1],
        [1,2,0,0,1,0,1],
        [1,1,1,0,1,0,1],
        [1,0,0,0,0,0,1],
        [1,0,1,1,1,0,1],
        [1,0,0,0,0,3,1],
        [1,1,1,1,1,1,1]
      ];
      const mazeEl = document.getElementById('rb4-maze');
      window.rb4Maze = maze;
      window.rb4Robot = {r:1,c:1};
      window.rb4Goal = {r:5,c:5};
      window.rb4Cmds = [];
      function renderMaze() {
        mazeEl.innerHTML = '';
        maze.forEach((row,r) => row.forEach((cell,c) => {
          const el = document.createElement('div');
          el.className = `maze-cell ${cell===1?'maze-wall':window.rb4Robot.r===r&&window.rb4Robot.c===c?'maze-robot':r===5&&c===5?'maze-goal':'maze-path'}`;
          el.textContent = window.rb4Robot.r===r&&window.rb4Robot.c===c?'ü§ñ':r===5&&c===5?'üèÅ':'';
          mazeEl.appendChild(el);
        }));
      }
      renderMaze();
      window.rb4Render = renderMaze;
      window.rb4Add = function(dir) {
        if (window.rb4Cmds.length >= 20) return;
        window.rb4Cmds.push(dir);
        const seq = document.getElementById('rb4-seq');
        const el = document.createElement('div');
        el.className = 'cmd-placed';
        el.textContent = dir;
        seq.appendChild(el);
      };
      window.rb4Clear = function() {
        window.rb4Cmds = [];
        document.getElementById('rb4-seq').innerHTML = '';
        window.rb4Robot = {r:1,c:1};
        renderMaze();
      };
      window.rb4Run = async function() {
        window.rb4Robot = {r:1,c:1};
        renderMaze();
        for (let i = 0; i < window.rb4Cmds.length; i++) {
          const cmd = window.rb4Cmds[i];
          let nr = window.rb4Robot.r, nc = window.rb4Robot.c;
          if (cmd==='‚Üë') nr--; if (cmd==='‚Üì') nr++; if (cmd==='‚Üê') nc--; if (cmd==='‚Üí') nc++;
          if (maze[nr]?.[nc] !== 1 && maze[nr]?.[nc] !== undefined) {
            window.rb4Robot = {r:nr, c:nc};
          }
          renderMaze();
          await new Promise(r => setTimeout(r, 300));
          if (window.rb4Robot.r===5 && window.rb4Robot.c===5) {
            showFeedback(document.getElementById('rb4-fb').parentElement, 'success', 'üéâ The robot reached the goal! Amazing programming!');
            addPoints(20);
            setTimeout(completeChapter, 1000);
            return;
          }
        }
        showFeedback(document.getElementById('rb4-fb').parentElement, 'error', 'üí° Hint: Look at where the goal üéØ is on the grid! Count the squares: how many steps RIGHT and how many steps DOWN does the robot need? Avoid walls (dark squares)! Try breaking it into small moves ‚Äî first go right, then go down. Use REPEAT blocks if you need to go the same direction multiple times. You got this! ü§ñ');
      };
    },

    // Ch5: Types of Robots
    function(area) {
      area.innerHTML = `
        <h2>ü¶æ Types of Robots</h2>
        <p class="lesson-desc">Robots come in all shapes and sizes! Each type is designed for a specific job. Let's explore!</p>
        <div class="activity">
          <h3>üîç Explore Robot Types!</h3>
          <p class="instructions">Tap each card to learn about different robots!</p>
          <div class="card-grid" id="rb5-cards"></div>
        </div>
        <div class="activity">
          <h3>üéØ Activity: Match Robot to Job!</h3>
          <div class="drag-zone" id="rb5-robots"></div>
          <div id="rb5-jobs" style="display:grid;gap:12px;margin:16px 0"></div>
          <div class="feedback" id="rb5-fb"></div>
        </div>
      `;
      const types = [
        {emoji:'ü¶æ',name:'Industrial Arm',desc:'Builds cars, welds metal, paints ‚Äî does repetitive factory work 24/7!'},
        {emoji:'üöÅ',name:'Drone',desc:'Flies and takes photos, delivers packages, helps farmers check crops!'},
        {emoji:'ü§ñ',name:'Humanoid',desc:'Walks on two legs, can interact with humans. Used in research and entertainment!'},
        {emoji:'üê†',name:'Underwater ROV',desc:'Explores deep oceans, fixes undersea cables, studies marine life!'},
        {emoji:'üè•',name:'Medical Robot',desc:'Helps surgeons with super-precise operations. Can work through tiny incisions!'}
      ];
      const cardGrid = document.getElementById('rb5-cards');
      types.forEach(t => {
        cardGrid.innerHTML += `<div class="flip-card" onclick="this.classList.toggle('flipped')"><div class="flip-card-inner"><div class="flip-card-front"><span class="emoji">${t.emoji}</span><h4>${t.name}</h4></div><div class="flip-card-back"><h5>${t.name}</h5><p>${t.desc}</p></div></div></div>`;
      });
      // Match game
      const matches = [
        {robot:'ü¶æ Industrial Arm',job:'Welding car parts in a factory',emoji:'üè≠'},
        {robot:'üöÅ Drone',job:'Delivering a package to your door',emoji:'üì¶'},
        {robot:'üè• Medical Robot',job:'Helping a surgeon with a delicate operation',emoji:'‚öïÔ∏è'},
        {robot:'üê† Underwater ROV',job:'Exploring the bottom of the ocean',emoji:'üåä'}
      ];
      const robotCont = document.getElementById('rb5-robots');
      const jobsCont = document.getElementById('rb5-jobs');
      window.rb5Matched = 0;
      [...matches].sort(() => Math.random() - 0.5).forEach(m => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = m.robot;
        el.dataset.value = m.robot;
        robotCont.appendChild(el);
        initDrag(el);
      });
      matches.forEach(m => {
        const zone = document.createElement('div');
        zone.className = 'drag-zone';
        zone.dataset.onDrop = 'rb5Drop';
        zone.dataset.answer = m.robot;
        zone.innerHTML = `<span class="drag-zone-label">${m.emoji} ${m.job}</span>`;
        jobsCont.appendChild(zone);
      });
    },

    // Ch6: Robots & AI Together
    function(area) {
      area.innerHTML = `
        <h2>ü§ù Robots & AI Together</h2>
        <p class="lesson-desc">When you give a robot AI, it becomes SMART! Instead of just following rules, it can learn, recognize things, and make better decisions. Let's see how!</p>
        <div class="activity">
          <h3>üéØ Activity: Teach the Robot to See!</h3>
          <p class="instructions">Drag training images to teach the robot what each object is. The more examples, the smarter it gets!</p>
          <div class="drag-zone" id="rb6-images"></div>
          <div class="buckets">
            <div class="bucket" style="border-color:var(--cyan)" data-on-drop="rb6Drop" data-bucket="apple">
              <h4>üçé Apple</h4><div class="bucket-items" id="rb6-apple"></div>
            </div>
            <div class="bucket" style="border-color:var(--purple)" data-on-drop="rb6Drop" data-bucket="banana">
              <h4>üçå Banana</h4><div class="bucket-items" id="rb6-banana"></div>
            </div>
          </div>
          <div id="rb6-robot-view" style="text-align:center;margin:20px 0">
            <p>ü§ñ Robot's AI accuracy: <strong id="rb6-accuracy">0%</strong></p>
            <div class="weight-bar"><div class="weight-fill" id="rb6-acc-fill" style="width:0;background:var(--cyan)"></div></div>
          </div>
          <div class="feedback" id="rb6-fb"></div>
        </div>
      `;
      const images = [
        {name:'üçé Red Apple',type:'apple'},{name:'üçè Green Apple',type:'apple'},
        {name:'üçå Yellow Banana',type:'banana'},{name:'üçé Big Apple',type:'apple'},
        {name:'üçå Small Banana',type:'banana'},{name:'üçå Ripe Banana',type:'banana'}
      ];
      const cont = document.getElementById('rb6-images');
      window.rb6Correct = 0;
      window.rb6Total = 0;
      images.sort(() => Math.random() - 0.5).forEach((img, i) => {
        const el = document.createElement('div');
        el.className = 'drag-item';
        el.textContent = img.name;
        el.dataset.value = img.type;
        cont.appendChild(el);
        initDrag(el);
      });
    },

    // Ch7: Robot Ethics
    function(area) {
      area.innerHTML = `
        <h2>‚öñÔ∏è Robot Ethics</h2>
        <p class="lesson-desc">As robots become smarter, they face tough decisions. Should a delivery robot stop to help someone who fell? Let's think about these important questions!</p>
        <div class="activity">
          <h3>ü§î Activity: What Should the Robot Do?</h3>
          <div id="rb7-scenarios"></div>
        </div>
      `;
      const scenarios = [
        {title:'üè• The Medicine Delivery', situation:'A robot is delivering urgent medicine to a hospital. On the way, it sees an elderly person who has fallen. What should the robot do?',
          options:[
            {text:'üèÉ Keep delivering ‚Äî the medicine is urgent!',feedback:'The medicine could save a life, but the fallen person needs help too. There\'s no perfect answer, but the robot should alert emergency services while continuing.', points:8},
            {text:'ü§ù Stop and help the person, alert emergency services',feedback:'Great compassion! But what about the urgent medicine? Best answer: alert emergency services AND continue the delivery.', points:8},
            {text:'üì° Alert emergency services AND continue delivery',feedback:'Excellent thinking! This balances both needs. The robot helps by calling for help while completing its important mission!', points:15}
          ]},
        {title:'üè† The Privacy Question', situation:'A home robot with cameras sees a teenager sneaking cookies at midnight. Should it tell the parents?',
          options:[
            {text:'üì∏ Yes, report everything it sees',feedback:'But what about privacy? Should robots monitor everything? This could feel like spying.', points:5},
            {text:'ü§´ No, some things should stay private',feedback:'Privacy matters! Robots shouldn\'t be surveillance tools. But what if it was something dangerous?', points:8},
            {text:'‚öñÔ∏è Only report safety concerns, not harmless things',feedback:'Perfect balance! Robots should protect privacy but still watch for real dangers. Eating cookies at midnight? Not a safety issue! üòÑ', points:15}
          ]},
        {title:'üé® The Creative Robot', situation:'An art robot can paint pictures that look exactly like famous artists. A gallery wants to sell them as "original AI art." Is this okay?',
          options:[
            {text:'‚úÖ Sure, AI made them so they\'re original',feedback:'But the AI learned by copying human artists. Is it fair to the original artists whose style is being copied?', points:5},
            {text:'‚öñÔ∏è Only if they credit the artists who inspired the AI',feedback:'Excellent! Giving credit is important. AI art builds on human creativity ‚Äî we should acknowledge that.', points:15},
            {text:'‚ùå No, only humans can make real art',feedback:'Many people feel this way! But AI tools are changing how we think about creativity. The key is being honest about how art is made.', points:8}
          ]}
      ];
      const cont = document.getElementById('rb7-scenarios');
      window.rb7Done = 0;
      scenarios.forEach((s, si) => {
        const div = document.createElement('div');
        div.style.cssText = 'margin:20px 0;padding:24px;background:rgba(0,0,0,0.2);border-radius:16px;';
        div.innerHTML = `<h4 style="margin-bottom:8px">${s.title}</h4><p style="color:var(--text2);margin-bottom:14px">${s.situation}</p><div class="choice-cards" id="rb7-s${si}"></div><div class="feedback" id="rb7-fb${si}"></div>`;
        cont.appendChild(div);
        s.options.forEach(o => {
          const card = document.createElement('div');
          card.className = 'choice-card';
          card.innerHTML = `<p>${o.text}</p>`;
          card.onclick = () => {
            div.querySelectorAll('.choice-card').forEach(c => c.style.pointerEvents = 'none');
            card.classList.add('selected');
            showFeedback(div, 'info', o.feedback);
            addPoints(o.points);
            window.rb7Done++;
            if (window.rb7Done >= 3) setTimeout(completeChapter, 1500);
          };
          div.querySelector(`#rb7-s${si}`).appendChild(card);
        });
      });
    },

    // Ch8: Design Your Robot
    function(area) {
      area.innerHTML = `
        <h2>üèóÔ∏è Design Your Robot ‚Äî Capstone!</h2>
        <p class="lesson-desc">Time to design YOUR dream robot! Pick a body, add sensors, give it rules, and name it!</p>
        <div class="activity">
          <h3>ü§ñ Step 1: Choose a Body</h3>
          <div class="choice-cards" id="rb8-body"></div>
        </div>
        <div class="activity" id="rb8-step2" style="display:none">
          <h3>üëÅÔ∏è Step 2: Add Sensors</h3>
          <p class="instructions">Pick at least 2 sensors for your robot:</p>
          <div class="choice-cards" id="rb8-sensors"></div>
        </div>
        <div class="activity" id="rb8-step3" style="display:none">
          <h3>üß† Step 3: Set the Rules</h3>
          <p class="instructions">What should your robot do? Pick its mission:</p>
          <div class="choice-cards" id="rb8-mission"></div>
        </div>
        <div class="activity" id="rb8-step4" style="display:none">
          <h3>‚úèÔ∏è Step 4: Name Your Robot!</h3>
          <input class="wizard-input" id="rb8-name" placeholder="Give your robot a name!" maxlength="20">
          <button class="btn-check" onclick="rb8Finish()">Create Robot! ü§ñ</button>
        </div>
        <div id="rb8-result" style="display:none"></div>
      `;
      window.rb8State = {body:null,sensors:[],mission:null};
      // Bodies
      const bodies = [
        {emoji:'ü§ñ',name:'Humanoid',desc:'Walks on 2 legs'},
        {emoji:'üöó',name:'Wheeled',desc:'Rolls on wheels'},
        {emoji:'üöÅ',name:'Flying Drone',desc:'Flies with propellers'},
        {emoji:'üê∂',name:'Animal-shaped',desc:'4 legs like a dog'}
      ];
      const bodyCont = document.getElementById('rb8-body');
      bodies.forEach(b => {
        const card = document.createElement('div');
        card.className = 'choice-card';
        card.innerHTML = `<span class="emoji">${b.emoji}</span><p><strong>${b.name}</strong></p><p style="font-size:.8rem;color:var(--text2)">${b.desc}</p>`;
        card.onclick = () => {
          bodyCont.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          window.rb8State.body = b;
          document.getElementById('rb8-step2').style.display = '';
          addPoints(5);
        };
        bodyCont.appendChild(card);
      });
      // Sensors
      const sensors = ['üì∑ Camera','üé§ Microphone','üìè Distance','üå°Ô∏è Temperature','üëÜ Touch','üß≠ GPS'];
      setTimeout(() => {
        const sensCont = document.getElementById('rb8-sensors');
        let sensCount = 0;
        sensors.forEach(s => {
          const card = document.createElement('div');
          card.className = 'choice-card';
          card.innerHTML = `<p>${s}</p>`;
          card.onclick = () => {
            card.classList.toggle('selected');
            if (card.classList.contains('selected')) { window.rb8State.sensors.push(s); sensCount++; addPoints(3); }
            else { window.rb8State.sensors = window.rb8State.sensors.filter(x=>x!==s); sensCount--; }
            if (sensCount >= 2) document.getElementById('rb8-step3').style.display = '';
          };
          sensCont.appendChild(card);
        });
        // Missions
        const missions = [
          {emoji:'üè†',name:'Home Helper',desc:'Cleans, cooks, organizes'},
          {emoji:'üåä',name:'Ocean Explorer',desc:'Discovers underwater life'},
          {emoji:'üè•',name:'Medical Assistant',desc:'Helps doctors and patients'},
          {emoji:'üå±',name:'Garden Farmer',desc:'Grows and harvests plants'}
        ];
        const missCont = document.getElementById('rb8-mission');
        missions.forEach(m => {
          const card = document.createElement('div');
          card.className = 'choice-card';
          card.innerHTML = `<span class="emoji">${m.emoji}</span><p><strong>${m.name}</strong></p><p style="font-size:.8rem;color:var(--text2)">${m.desc}</p>`;
          card.onclick = () => {
            missCont.querySelectorAll('.choice-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            window.rb8State.mission = m;
            document.getElementById('rb8-step4').style.display = '';
            addPoints(5);
          };
          missCont.appendChild(card);
        });
      }, 100);
      window.rb8Finish = function() {
        const name = document.getElementById('rb8-name').value.trim() || 'RoboFriend';
        const s = window.rb8State;
        const result = document.getElementById('rb8-result');
        result.style.display = '';
        result.innerHTML = `<div class="chapter-complete show">
          <span class="emoji" style="font-size:5rem">${s.body.emoji}</span>
          <h3 style="font-size:1.8rem;color:var(--cyan)">${name}</h3>
          <div class="glass" style="display:inline-block;padding:24px;text-align:left;max-width:400px;margin:16px 0">
            <p><strong>Body:</strong> ${s.body.name} ${s.body.emoji}</p>
            <p><strong>Sensors:</strong> ${s.sensors.join(', ')}</p>
            <p><strong>Mission:</strong> ${s.mission.emoji} ${s.mission.name}</p>
            <p style="margin-top:12px;color:var(--gold);font-style:italic">"${name} is ready to change the world!"</p>
          </div>
        </div>`;
        addPoints(20);
        setTimeout(completeChapter, 1000);
      };
    }
  ]
};

// ===== DROP HANDLERS =====

// Generic bucket drop handler
function handleBucketDrop(drag, zone, placedMap, containerPrefix) {
  const bucket = zone.dataset?.bucket || zone.closest('.bucket')?.dataset?.bucket;
  if (!bucket) return;
  const clone = drag.el.cloneNode(true);
  clone.style.opacity = '1';
  clone.classList.remove('drag-item');
  clone.style.cssText = 'padding:6px 12px;border-radius:8px;background:rgba(255,255,255,0.08);font-size:.8rem;margin:2px;';
  const itemsDiv = zone.querySelector('.bucket-items') || document.getElementById(`${containerPrefix}-${bucket}`);
  if (itemsDiv) itemsDiv.appendChild(clone);
  drag.el.classList.add('placed');
  if (placedMap) placedMap[drag.el.dataset.id || drag.el.textContent] = bucket;
}

// AI Ch1 drops
window.ai1Drop = function(drag, zone) { handleBucketDrop(drag, zone, window.ai1Placed, 'ai1'); };
window.ai1Check = function() {
  const items = document.querySelectorAll('#ai1-items .drag-item, #ai1-yes .drag-item, #ai1-no .drag-item, .bucket-items *');
  let allPlaced = document.querySelectorAll('#ai1-items .drag-item:not(.placed)').length === 0;
  if (!allPlaced) { showFeedback(document.querySelector('.activity'), 'error', 'Drag all items first!'); return; }
  addPoints(15);
  showFeedback(document.querySelector('.activity'), 'success', 'üéâ Great job sorting! AI is in more things than you think ‚Äî from voice assistants to game characters to search engines!');
  setTimeout(completeChapter, 1500);
};

// AI Ch2 drops
window.ai2SlotDrop = function(drag, zone) {
  const slot = zone.dataset.slot;
  zone.textContent = drag.el.textContent;
  zone.classList.add('filled');
  drag.el.classList.add('placed');
  window.ai2Slots[slot] = drag.el.dataset.value;
};
window.ai2Check = function() {
  const correct = Object.keys(window.ai2Slots).length === 5 &&
    Object.entries(window.ai2Slots).every(([k, v]) => k === v);
  if (Object.keys(window.ai2Slots).length < 5) { showFeedback(document.querySelector('.activity'), 'error', 'Fill all 5 slots!'); return; }
  if (correct) {
    showFeedback(document.querySelector('.activity'), 'success', 'üéâ Perfect! AI learns step by step: Collect ‚Üí Clean ‚Üí Train ‚Üí Test ‚Üí Improve!');
    addPoints(15);
  } else {
    showFeedback(document.querySelector('.activity'), 'error', 'üí° Hint: Think of teaching a pet! 1Ô∏è‚É£ Collect Data = gather examples (photos of cats & dogs) ‚Üí 2Ô∏è‚É£ Clean Data = remove bad examples (blurry photos) ‚Üí 3Ô∏è‚É£ Train Model = show examples repeatedly (this is a cat, this is a dog) ‚Üí 4Ô∏è‚É£ Test = quiz time! (show new photos) ‚Üí 5Ô∏è‚É£ Improve = fix mistakes and try again. The order matters! üß†');
  }
};
window.ai2TrainDrop = function(drag, zone) { handleBucketDrop(drag, zone, window.ai2TrainPlaced, 'ai2'); };
window.ai2TrainCheck = function() {
  addPoints(10);
  showFeedback(document.querySelectorAll('.activity')[1], 'success', 'üéâ You just trained an AI! The more examples you give, the better it gets. This is called "machine learning"!');
  setTimeout(completeChapter, 1500);
};

// AI Ch5 drops
window.ai5Drop = function(drag, zone) {
  const ci = zone.dataset.challenge;
  const label = zone.querySelector('.drag-zone-label');
  if (label) label.remove();
  const clone = drag.el.cloneNode(true);
  clone.style.cssText = 'padding:6px 12px;border-radius:8px;background:rgba(6,182,212,0.15);font-size:.85rem;margin:2px;display:inline-block;';
  zone.appendChild(clone);
  drag.el.classList.add('placed');
};
window.ai5Check = function(ci) {
  addPoints(10);
  showFeedback(document.getElementById(`ai5-fb-${ci}`).parentElement, 'success', `üéâ Great question building! "${window.ai5Challenges[ci].answer}" is SO much better than the boring version!`);
  window.ai5Done = (window.ai5Done || 0) + 1;
  if (window.ai5Done >= 3) setTimeout(completeChapter, 1000);
};

// AI Ch6 drops
window.ai6Drop = function(drag, zone) { handleBucketDrop(drag, zone, window.ai6Placed, 'ai6'); };
window.ai6Check = function() {
  addPoints(15);
  showFeedback(document.querySelector('.activity'), 'success', 'üéâ Excellent fact-checking! Remember: AI can make mistakes. Always verify important information with trusted sources!');
  setTimeout(completeChapter, 1500);
};

// AI Ch8 drops
window.ai8RuleDrop = function(drag, zone) {
  const clone = drag.el.cloneNode(true);
  clone.style.cssText = 'padding:6px 12px;border-radius:8px;background:rgba(34,197,94,0.15);font-size:.85rem;margin:2px;display:inline-block;';
  zone.appendChild(clone);
  drag.el.classList.add('placed');
  window.ai8State.rules.push(drag.el.dataset.value);
  if (window.ai8State.rules.length >= 2) {
    document.getElementById('ai8-step3').style.display = '';
    addPoints(5);
  }
};
window.showAi8Result = function() {
  const s = window.ai8State;
  const result = document.getElementById('ai8-result');
  result.style.display = '';
  document.getElementById('ai8-card').innerHTML = `
    <h4 style="text-align:center;margin-bottom:12px">${s.job.emoji} ${s.job.name}</h4>
    <p><strong>Job:</strong> ${s.job.desc}</p>
    <p><strong>Rules:</strong></p><ul style="margin:4px 0 8px 16px">${s.rules.map(r => `<li style="font-size:.85rem">${r}</li>`).join('')}</ul>
    <p><strong>Never:</strong></p><ul style="margin:4px 0 8px 16px">${s.nevers.map(n => `<li style="font-size:.85rem">${n}</li>`).join('')}</ul>
    <p style="color:var(--gold);text-align:center;margin-top:12px">Designed by ${STATE.name || 'You'}! üåü</p>
  `;
  setTimeout(completeChapter, 1000);
};

// Space Ch1 drops
window.sp1SlotDrop = function(drag, zone) {
  zone.textContent = drag.el.textContent;
  zone.classList.add('filled');
  drag.el.classList.add('placed');
  window.sp1Slots[zone.dataset.slot] = drag.el.dataset.value;
};
window.sp1Check = function() {
  if (Object.keys(window.sp1Slots).length < 8) { showFeedback(document.querySelectorAll('.activity')[1], 'error', 'Place all 8 planets!'); return; }
  const correct = Object.entries(window.sp1Slots).every(([k, v]) => k === v);
  if (correct) {
    showFeedback(document.querySelectorAll('.activity')[1], 'success', 'üéâ Perfect! Mercury, Venus, Earth, Mars, Jupiter, Saturn, Uranus, Neptune! "My Very Excited Mother Just Served Us Nachos" üåÆ');
    addPoints(20);
    setTimeout(completeChapter, 1500);
  } else {
    showFeedback(document.querySelectorAll('.activity')[1], 'error', 'üí° Hint: Use this memory trick ‚Äî "My Very Excited Mother Just Served Us Nachos"! Each first letter = a planet: Mercury (closest to Sun, tiny & hot), Venus (brightest, super hot), Earth (us!), Mars (red planet), Jupiter (HUGE gas giant), Saturn (rings!), Uranus (tilted sideways), Neptune (farthest, blue & cold). Try again! ü™ê');
  }
};

// Space Ch2 drops
window.sp2SlotDrop = function(drag, zone) {
  zone.textContent = drag.el.textContent;
  zone.classList.add('filled');
  drag.el.classList.add('placed');
  window.sp2Slots[zone.dataset.slot] = drag.el.dataset.value;
};
window.sp2Check = function() {
  if (Object.keys(window.sp2Slots).length < 5) { showFeedback(document.querySelector('.activity'), 'error', 'Place all stages!'); return; }
  const correct = Object.entries(window.sp2Slots).every(([k, v]) => k === v);
  if (correct) {
    showFeedback(document.querySelector('.activity'), 'success', 'üéâ Perfect! Nebula ‚Üí Protostar ‚Üí Main Sequence ‚Üí Red Giant ‚Üí Supernova! Stars are amazing!');
    addPoints(15);
    setTimeout(completeChapter, 1500);
  } else {
    showFeedback(document.querySelector('.activity'), 'error', 'üí° Hint: Think of a star\'s life like growing up! 1Ô∏è‚É£ Nebula = baby (cloud of gas & dust) ‚Üí 2Ô∏è‚É£ Protostar = toddler (gravity pulls gas together, gets warm) ‚Üí 3Ô∏è‚É£ Main Sequence = adult (shining bright, fusing hydrogen) ‚Üí 4Ô∏è‚É£ Red Giant = old age (expands huge, turns red) ‚Üí 5Ô∏è‚É£ Supernova = dramatic ending (BOOM! Explodes brilliantly). Try again! ‚≠ê');
  }
};

// Space Ch3 drops
window.sp3Drop = function(drag, zone) {
  zone.innerHTML = drag.el.innerHTML;
  zone.classList.add('filled');
  drag.el.classList.add('placed');
  window.sp3Filled++;
  if (window.sp3Filled >= 5) document.getElementById('sp3-launch').style.display = '';
};
window.sp3Launch = function() {
  const rocket = document.querySelector('.rocket-frame');
  addPoints(20);
  gsap.to(rocket, {y: -500, opacity: 0, duration: 2, ease: 'power2.in'});
  showFeedback(document.querySelector('.activity'), 'success', 'üöÄ LAUNCH SUCCESSFUL! 3... 2... 1... LIFTOFF! Your rocket is heading to space!');
  setTimeout(completeChapter, 2500);
};

// Space Ch4 drops
window.sp4Drop = function(drag, zone) {
  try {
    const item = JSON.parse(drag.el.dataset.value);
    if (window.sp4Weight + item.w > 1000) {
      showFeedback(zone.parentElement, 'error', `üí° Too heavy! ${item.name} weighs ${item.w}kg and would exceed the 1000kg limit! Current cargo: ${window.sp4Weight}kg. You have ${1000 - window.sp4Weight}kg left. Tip: Prioritize essentials first (food, water, oxygen, tools, solar panels), then add extras if you have room! Real Mars missions face this exact challenge! üöÄ`);
      return;
    }
    window.sp4Weight += item.w;
    window.sp4Cargo.push(item);
    const clone = document.createElement('div');
    clone.style.cssText = 'padding:6px 10px;border-radius:8px;background:rgba(6,182,212,0.15);font-size:.8rem;display:inline-block;margin:2px;';
    clone.textContent = `${item.name} (${item.w}kg)`;
    document.getElementById('sp4-cargo-items').appendChild(clone);
    drag.el.classList.add('placed');
    const pct = (window.sp4Weight / 1000 * 100);
    document.getElementById('sp4-weight-fill').style.width = pct + '%';
    document.getElementById('sp4-weight-fill').style.background = pct > 90 ? 'var(--red)' : pct > 70 ? 'var(--gold)' : 'var(--green)';
    document.getElementById('sp4-weight-text').textContent = `${window.sp4Weight} / 1000 kg`;
  } catch(e) {}
};
window.sp4Check = function() {
  const essentials = window.sp4Cargo.filter(c => c.essential).length;
  const totalEssential = 7;
  if (essentials >= 5) {
    showFeedback(document.querySelector('.activity'), 'success', `üöÄ Mission approved! You packed ${window.sp4Cargo.length} items (${window.sp4Weight}kg). ${essentials >= totalEssential ? 'ALL essentials included ‚Äî perfect planning!' : 'Most essentials covered ‚Äî your crew will survive!'}`);
    addPoints(20);
    setTimeout(completeChapter, 1500);
  } else {
    showFeedback(document.querySelector('.activity'), 'error', `üí° Your crew needs more essentials! For a Mars mission, you MUST pack: üçû Food (astronauts need ~2kg/day), üíß Water (most critical!), ü´Å Oxygen (can't breathe Mars air!), üîß Tools (for repairs), ‚òÄÔ∏è Solar Panels (power source). These are non-negotiable ‚Äî without ANY of these, the mission fails. Remove some fun items and add the essentials! üöÄ`);
  }
};

// Space Ch6 drops
window.sp6Drop = function(drag, zone) {
  if (drag.el.dataset.value === zone.dataset.answer) {
    zone.innerHTML = `<span class="drag-zone-label" style="color:var(--green)">‚úÖ ${drag.el.textContent}</span>`;
    zone.style.borderColor = 'var(--green)';
    zone.style.borderStyle = 'solid';
    drag.el.classList.add('placed');
    window.sp6Matched++;
    addPoints(8);
    if (window.sp6Matched >= 4) {
      showFeedback(document.querySelector('.activity'), 'success', 'üéâ All matched! AI is essential for space exploration ‚Äî from driving rovers to finding new planets!');
      setTimeout(completeChapter, 1000);
    }
  } else {
    zone.classList.add('wrong');
    setTimeout(() => zone.classList.remove('wrong'), 500);
  }
};

// Space Ch8 crew drop
window.sp8CrewDrop = function(drag, zone) {
  if (window.sp8State.crew.length >= 4) return;
  const clone = drag.el.cloneNode(true);
  clone.style.cssText = 'padding:6px 12px;border-radius:8px;background:rgba(6,182,212,0.15);font-size:.85rem;margin:2px;display:inline-block;';
  zone.appendChild(clone);
  drag.el.classList.add('placed');
  window.sp8State.crew.push(drag.el.dataset.value);
  addPoints(3);
  if (window.sp8State.crew.length >= 3) document.getElementById('sp8-step3').style.display = '';
};

// Robotics Ch1 drops
window.rb1Drop = function(drag, zone) { handleBucketDrop(drag, zone, window.rb1Placed, 'rb1'); };
window.rb1Check = function() {
  addPoints(15);
  showFeedback(document.querySelector('.activity'), 'success', 'üéâ Great sorting! Remember: a robot must be able to SENSE, THINK, and ACT. A bicycle can\'t think or sense!');
  setTimeout(completeChapter, 1500);
};

// Robotics Ch2 drops
window.rb2Drop = function(drag, zone) {
  if (drag.el.dataset.value === zone.dataset.answer) {
    zone.innerHTML = `<span class="drag-zone-label" style="color:var(--green)">‚úÖ ${drag.el.textContent}</span>`;
    zone.style.borderColor = 'var(--green)';
    zone.style.borderStyle = 'solid';
    drag.el.classList.add('placed');
    window.rb2Matched++;
    addPoints(8);
    if (window.rb2Matched >= 5) {
      showFeedback(document.querySelector('.activity'), 'success', 'üéâ Perfect matching! Robots use many different sensors to understand the world around them!');
      setTimeout(completeChapter, 1000);
    }
  }
};

// Robotics Ch3 drops
window.rb3Drop = function(drag, zone) {
  const clone = drag.el.cloneNode(true);
  clone.style.cssText = drag.el.style.cssText;
  clone.className = drag.el.className;
  zone.appendChild(clone);
  window.rb3Blocks.push(drag.el.dataset.value);
  drag.el.classList.add('placed');
  if (window.rb3Blocks.length >= 2) {
    const arrow = document.createElement('span');
    arrow.className = 'arrow';
    arrow.textContent = '‚Üí';
  }
};
window.rb3Check = function() {
  if (window.rb3Blocks.length >= 3) {
    addPoints(15);
    showFeedback(document.querySelector('.activity'), 'success', 'üéâ Great logic building! IF-THEN-ELSE is how robots make decisions. You just programmed a robot brain!');
    setTimeout(completeChapter, 1500);
  } else {
    showFeedback(document.querySelector('.activity'), 'error', 'üí° Hint: Robot brains use IF-THEN-ELSE logic! Think of it like this: IF (something happens) ‚Üí THEN (do this) ‚Üí ELSE (do that instead). Example: IF the robot sees a wall ‚Üí THEN turn right ‚Üí ELSE keep going forward. Drag at least 3 blocks: one IF condition, one THEN action, and one ELSE action. That\'s how ALL robots make decisions! ü§ñ');
  }
};

// Robotics Ch5 drops
window.rb5Drop = function(drag, zone) {
  if (drag.el.dataset.value === zone.dataset.answer) {
    zone.innerHTML = `<span class="drag-zone-label" style="color:var(--green)">‚úÖ ${drag.el.textContent}</span>`;
    zone.style.borderColor = 'var(--green)';
    zone.style.borderStyle = 'solid';
    drag.el.classList.add('placed');
    window.rb5Matched++;
    addPoints(8);
    if (window.rb5Matched >= 4) {
      showFeedback(document.querySelectorAll('.activity')[1], 'success', 'üéâ All matched! Each type of robot is specially designed for its job!');
      setTimeout(completeChapter, 1000);
    }
  }
};

// Robotics Ch6 drops
window.rb6Drop = function(drag, zone) {
  const bucket = zone.dataset?.bucket || zone.closest('.bucket')?.dataset?.bucket;
  if (!bucket) return;
  const correct = drag.el.dataset.value === bucket;
  window.rb6Total++;
  if (correct) window.rb6Correct++;
  handleBucketDrop(drag, zone, null, 'rb6');
  const acc = Math.round(window.rb6Correct / window.rb6Total * 100);
  document.getElementById('rb6-accuracy').textContent = acc + '%';
  document.getElementById('rb6-acc-fill').style.width = acc + '%';
  if (correct) addPoints(5);
  if (window.rb6Total >= 6) {
    showFeedback(document.querySelector('.activity'), 'success', `üéâ Your robot's AI is ${acc}% accurate! With more training data, AI gets even smarter. This is machine learning in action!`);
    setTimeout(completeChapter, 1500);
  }
};

// ===== NOTIFICATION SYSTEM =====
function addNotification(icon, text) {
  const notif = { icon, text, time: Date.now() };
  STATE.notifications.unshift(notif);
  if (STATE.notifications.length > 50) STATE.notifications.pop();
  save();
  renderNotifications();
  // Browser push
  if (Notification.permission === 'granted') {
    try { new Notification('NextGen School', { body: text, icon: 'üéì' }); } catch(e) {}
  }
}

function renderNotifications() {
  const list = document.getElementById('notif-list');
  const count = document.getElementById('notif-count');
  if (!list) return;
  const unread = STATE.notifications.filter(n => Date.now() - n.time < 86400000).length;
  if (unread > 0) { count.textContent = unread; count.style.display = 'flex'; }
  else { count.style.display = 'none'; }
  if (STATE.notifications.length === 0) {
    list.innerHTML = '<div class="notif-empty">No notifications yet!</div>';
    return;
  }
  list.innerHTML = STATE.notifications.slice(0, 20).map(n => {
    const ago = formatTimeAgo(n.time);
    return `<div class="notif-item"><span class="notif-icon">${n.icon}</span><span class="notif-text">${n.text}</span><span class="notif-time">${ago}</span></div>`;
  }).join('');
}

function formatTimeAgo(ts) {
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 60) return 'now';
  if (s < 3600) return Math.floor(s/60) + 'm';
  if (s < 86400) return Math.floor(s/3600) + 'h';
  return Math.floor(s/86400) + 'd';
}

function toggleNotifPanel() {
  document.getElementById('notif-panel').classList.toggle('show');
}

function requestNotifPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

// ===== STREAK TRACKING =====
function trackActiveDay() {
  const today = new Date().toISOString().split('T')[0];
  if (!STATE.activeDays.includes(today)) {
    STATE.activeDays.push(today);
    save();
    // Check streak
    const streak = getStreak();
    if (streak >= 3) addNotification('üî•', `${streak}-day learning streak! Keep it up!`);
  }
}

function getStreak() {
  const sorted = [...STATE.activeDays].sort().reverse();
  let streak = 0;
  const today = new Date();
  for (let i = 0; i < 365; i++) {
    const d = new Date(today); d.setDate(d.getDate() - i);
    const ds = d.toISOString().split('T')[0];
    if (sorted.includes(ds)) streak++;
    else break;
  }
  return streak;
}

// ===== EMAIL SYSTEM =====
function sendEmail(type, data) {
  if (EMAIL_CONFIG.serviceId.startsWith('YOUR_')) return; // Not configured
  try {
    const templateMap = {
      welcome: EMAIL_CONFIG.templateWelcome,
      progress: EMAIL_CONFIG.templateProgress,
      certificate: EMAIL_CONFIG.templateCertificate
    };
    emailjs.send(EMAIL_CONFIG.serviceId, templateMap[type], data, EMAIL_CONFIG.publicKey);
  } catch(e) { console.log('EmailJS not configured:', e); }
}

function sendProgressReport() {
  if (!STATE.parentEmail) return;
  const completedCount = Object.keys(STATE.completed).length;
  const badgesCount = completedCount;
  const hours = Math.round(STATE.timeSpent / 3600000 * 10) / 10;
  sendEmail('progress', {
    parent_email: STATE.parentEmail,
    child_name: STATE.name,
    chapters_completed: completedCount,
    badges_earned: badgesCount,
    hours_learning: hours
  });
}

// ===== CERTIFICATE GENERATION =====
function generateCertificate(courseName) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

  // Background
  doc.setFillColor(10, 10, 46);
  doc.rect(0, 0, 297, 210, 'F');

  // Border gradient effect
  doc.setDrawColor(6, 182, 212);
  doc.setLineWidth(2);
  doc.roundedRect(8, 8, 281, 194, 5, 5);
  doc.setDrawColor(139, 92, 246);
  doc.setLineWidth(1);
  doc.roundedRect(12, 12, 273, 186, 4, 4);

  // Header
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(16);
  doc.setTextColor(6, 182, 212);
  doc.text('üéì NEXTGEN SCHOOL', 148.5, 30, { align: 'center' });

  // Certificate title
  doc.setFontSize(28);
  doc.setTextColor(251, 191, 36);
  doc.text('Certificate of Completion', 148.5, 50, { align: 'center' });

  // Decorative line
  doc.setDrawColor(251, 191, 36);
  doc.setLineWidth(0.5);
  doc.line(80, 55, 217, 55);

  // "This certifies that"
  doc.setFontSize(12);
  doc.setTextColor(148, 163, 184);
  doc.text('This certifies that', 148.5, 68, { align: 'center' });

  // Child name
  doc.setFontSize(32);
  doc.setTextColor(251, 191, 36);
  doc.text(STATE.name || 'Explorer', 148.5, 84, { align: 'center' });

  // Course name
  doc.setFontSize(14);
  doc.setTextColor(226, 232, 240);
  doc.text(`Has successfully completed ${courseName}`, 148.5, 98, { align: 'center' });

  // Description
  doc.setFontSize(10);
  doc.setTextColor(148, 163, 184);
  doc.text('Demonstrating critical thinking, creativity, and responsible AI awareness', 148.5, 110, { align: 'center' });

  // Level & Badges
  const level = getLevel();
  doc.setFontSize(12);
  doc.setTextColor(139, 92, 246);
  doc.text(`Level: ${level.icon} ${level.name} | XP: ${STATE.points}`, 148.5, 125, { align: 'center' });

  // Date
  doc.setFontSize(10);
  doc.setTextColor(148, 163, 184);
  doc.text(`Date: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`, 148.5, 140, { align: 'center' });

  // Certificate ID
  const certId = 'NGS-' + Date.now().toString(36).toUpperCase() + '-' + (STATE.name || 'X').charCodeAt(0).toString(36).toUpperCase();
  doc.setFontSize(8);
  doc.setTextColor(100, 116, 139);
  doc.text(`Certificate ID: ${certId}`, 148.5, 150, { align: 'center' });

  // Founders
  doc.setFontSize(11);
  doc.setTextColor(226, 232, 240);
  doc.text('Founders: Rathish & Sathish', 148.5, 168, { align: 'center' });

  // Website
  doc.setFontSize(9);
  doc.setTextColor(6, 182, 212);
  doc.text('nextgenschool.aiupskills.com', 148.5, 178, { align: 'center' });

  doc.save(`NextGen_Certificate_${courseName.replace(/[^a-zA-Z]/g, '_')}.pdf`);

  // Email certificate to parent
  if (STATE.parentEmail) {
    sendEmail('certificate', {
      parent_email: STATE.parentEmail,
      child_name: STATE.name,
      course_name: courseName,
      certificate_id: certId
    });
  }
}

// ===== PAYMENT SYSTEM =====
function isChapterUnlocked(courseId, chapterIdx) {
  return true; // ALL CHAPTERS UNLOCKED ‚Äî full access for now!
}

function handlePayment(plan) {
  if (!PAYMENT_CONFIG.stripePublicKey.startsWith('YOUR_')) {
    // Stripe configured ‚Äî redirect
    try {
      const stripe = Stripe(PAYMENT_CONFIG.stripePublicKey);
      const priceId = PAYMENT_CONFIG.prices[plan];
      if (priceId && !priceId.startsWith('YOUR_')) {
        stripe.redirectToCheckout({ lineItems: [{ price: priceId, quantity: 1 }], mode: 'payment', successUrl: window.location.href + '?payment=success&plan=' + plan, cancelUrl: window.location.href });
        return;
      }
    } catch(e) { console.log('Stripe error:', e); }
  }
  // Demo mode ‚Äî show contact
  const msg = `Hi! I'd like to purchase the ${plan === 'singleCourse' ? 'Single Course ($19)' : plan === 'fullAccess' ? 'Full Access Bundle ($39)' : 'Family Plan ($59)'} for NextGen School.`;
  window.open(`mailto:hello@nextgenschool.aiupskills.com?subject=NextGen School Purchase&body=${encodeURIComponent(msg)}`);
}

// Check for payment success URL param
(function checkPaymentReturn() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('payment') === 'success') {
    const plan = params.get('plan');
    if (plan === 'fullAccess' || plan === 'familyPlan') {
      STATE.purchases.fullAccess = true;
    } else if (plan === 'singleCourse') {
      // Unlock current course (default to ai)
      STATE.purchases.ai = true;
    }
    save();
    addNotification('üéâ', 'Payment successful! All chapters unlocked!');
    window.history.replaceState({}, '', window.location.pathname);
  }
})();

// ===== LOCK SYSTEM (patch renderSidebar & loadChapter) =====
const _origRenderSidebar = renderSidebar;
renderSidebar = function() {
  _origRenderSidebar();
  if (!STATE.currentCourse) return;
  const items = document.querySelectorAll('.chapter-item');
  items.forEach((item, i) => {
    if (!isChapterUnlocked(STATE.currentCourse, i) && i > 0) {
      item.classList.add('locked');
      const title = item.querySelector('.ch-title');
      if (title && !title.querySelector('.chapter-lock')) {
        title.innerHTML += ' <span class="chapter-lock">üîí</span>';
      }
    }
  });
};

const _origLoadChapter = loadChapter;
loadChapter = function(idx) {
  if (!isChapterUnlocked(STATE.currentCourse, idx)) {
    const area = document.getElementById('lesson-area');
    const course = COURSES[STATE.currentCourse];
    area.innerHTML = `<div class="unlock-banner">
      <span style="font-size:3rem;display:block;margin-bottom:12px">üîí</span>
      <h3>Chapter Locked</h3>
      <p>Unlock all chapters of ${course.title} to continue your learning adventure!</p>
      <button class="btn btn-gold" onclick="handlePayment('singleCourse')">Unlock for $19 ‚Üí</button>
      <button class="btn btn-primary" onclick="handlePayment('fullAccess')" style="margin-left:8px">All Courses $39 ‚Üí</button>
    </div>`;
    return;
  }
  trackActiveDay();
  _origLoadChapter(idx);
};

// ===== PATCH completeChapter for notifications & certificates =====
const _origCompleteChapter = completeChapter;
completeChapter = function() {
  const key = `${STATE.currentCourse}_${STATE.currentChapter}`;
  const wasNew = !STATE.completed[key];
  _origCompleteChapter();
  if (wasNew) {
    const ch = COURSES[STATE.currentCourse].chapters[STATE.currentChapter];
    addNotification('üìö', `Chapter completed: ${ch.title}`);
    // Check badges
    const totalCompleted = Object.keys(STATE.completed).length;
    if (totalCompleted === 5) addNotification('üèÖ', 'You earned the "Fast Learner" badge!');
    if (totalCompleted === 10) addNotification('üß†', 'You earned the "Critical Thinker" badge!');
    if (totalCompleted === 20) addNotification('üåü', 'You earned the "Knowledge Master" badge!');
    // Check course completion
    const course = COURSES[STATE.currentCourse];
    let allDone = true;
    for (let i = 0; i < course.chapters.length; i++) {
      if (!STATE.completed[`${STATE.currentCourse}_${i}`]) { allDone = false; break; }
    }
    if (allDone) {
      addNotification('üéì', `${course.title} completed! Download your certificate!`);
      // Add certificate download to lesson area
      const area = document.getElementById('lesson-area');
      const certDiv = document.createElement('div');
      certDiv.style.textAlign = 'center';
      certDiv.style.marginTop = '16px';
      certDiv.innerHTML = `<button class="cert-btn" onclick="generateCertificate('${course.title.replace(/'/g, "\\'")}')">üìú Download Certificate</button>`;
      area.appendChild(certDiv);
    }
  }
};

// ===== PARENT DASHBOARD =====
function parentLogin() {
  const email = document.getElementById('pd-email').value.trim();
  if (!email) return;
  // Simple check ‚Äî match stored email
  if (email === STATE.parentEmail || STATE.parentEmail === '') {
    STATE.parentEmail = email; save();
    document.getElementById('pd-login').style.display = 'none';
    document.getElementById('pd-content').style.display = 'block';
    renderParentDashboard();
  } else {
    alert('Email does not match. Please use the email from signup.');
  }
}

function renderParentDashboard() {
  const completedCount = Object.keys(STATE.completed).length;
  const totalChapters = 24;
  const hours = Math.round((STATE.timeSpent + (Date.now() - STATE.sessionStart)) / 3600000 * 10) / 10;
  const streak = getStreak();

  // Stats
  document.getElementById('pd-stats').innerHTML = `
    <div class="pd-stat"><div class="stat-value">${STATE.name || 'Explorer'}</div><div class="stat-label">Student</div></div>
    <div class="pd-stat"><div class="stat-value">${completedCount}/${totalChapters}</div><div class="stat-label">Chapters Done</div></div>
    <div class="pd-stat"><div class="stat-value">${completedCount}</div><div class="stat-label">Badges Earned</div></div>
    <div class="pd-stat"><div class="stat-value">${hours}h</div><div class="stat-label">Time Learning</div></div>
    <div class="pd-stat"><div class="stat-value">${streak}üî•</div><div class="stat-label">Day Streak</div></div>
    <div class="pd-stat"><div class="stat-value">${STATE.points}‚≠ê</div><div class="stat-label">Total XP</div></div>
  `;

  // Per-course progress
  let coursesHtml = '';
  ['ai', 'space', 'robotics'].forEach(c => {
    const course = COURSES[c];
    let done = 0;
    for (let i = 0; i < 8; i++) { if (STATE.completed[`${c}_${i}`]) done++; }
    const pct = Math.round(done / 8 * 100);
    coursesHtml += `<div class="pd-course-card">
      <h4>${course.title}</h4>
      <div class="progress-bar" style="max-width:100%;margin:8px 0"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:.85rem;color:var(--text2)"><span>${done}/8 chapters</span><span>${pct}%</span></div>
      ${done === 8 ? `<button class="cert-btn" style="margin-top:12px" onclick="generateCertificate('${course.title.replace(/'/g, "\\'")}')">üìú Download Certificate</button>` : ''}
    </div>`;
  });
  document.getElementById('pd-courses').innerHTML = coursesHtml;

  // Streak calendar (last 28 days)
  let calHtml = '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;font-size:.6rem;color:var(--text3);margin-bottom:4px"><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span><span>S</span></div>';
  const today = new Date();
  for (let i = 27; i >= 0; i--) {
    const d = new Date(today); d.setDate(d.getDate() - i);
    const ds = d.toISOString().split('T')[0];
    const active = STATE.activeDays.includes(ds);
    const isToday = i === 0;
    calHtml += `<div class="pd-streak-day ${active ? 'active' : ''} ${isToday ? 'today' : ''}" title="${ds}"></div>`;
  }
  document.getElementById('pd-streak-cal').innerHTML = calHtml;

  // Conversation prompts
  const lastCompleted = Object.keys(STATE.completed).pop();
  let prompt = 'Ask your child what they learned today!';
  if (lastCompleted) {
    const [c, idx] = lastCompleted.split('_');
    const ch = COURSES[c]?.chapters[parseInt(idx)];
    if (ch) {
      const prompts = {
        'What is AI?': 'Ask: "Can you explain what AI is to me? Where do we use AI at home?"',
        'How AI Learns': 'Ask: "How does AI learn new things? Is it like how you learn?"',
        'Smart vs Wise': 'Ask: "What\'s the difference between being smart and being wise?"',
        'Our Solar System': 'Ask: "Which planet is your favorite and why?"',
        'Rockets & Launch Science': 'Ask: "What does it take to launch a rocket into space?"',
        'What is a Robot?': 'Ask: "What makes something a robot vs just a machine?"',
        'Robot Ethics': 'Ask: "Should robots make important decisions for us? Why or why not?"'
      };
      prompt = prompts[ch.title] || `Ask your child about "${ch.title}" ‚Äî what did they learn?`;
    }
  }
  document.getElementById('pd-conversation-section').innerHTML = `<div class="pd-conversation"><h4>üí¨ Talk to Your Child About...</h4><p>${prompt}</p></div>`;

  // Certificates section
  let certHtml = '<h3 style="margin-bottom:12px">üìú Certificates</h3>';
  ['ai', 'space', 'robotics'].forEach(c => {
    let done = 0;
    for (let i = 0; i < 8; i++) { if (STATE.completed[`${c}_${i}`]) done++; }
    if (done === 8) {
      certHtml += `<button class="cert-btn" onclick="generateCertificate('${COURSES[c].title.replace(/'/g, "\\'")}')">üìú ${COURSES[c].title}</button>`;
    }
  });
  document.getElementById('pd-certificates').innerHTML = certHtml;
}

// ===== ENGAGEMENT METRICS =====
function animateMetrics() {
  const completedCount = Object.keys(STATE.completed).length;
  const baseStudents = 152, baseChapters = 847, baseBadges = 523;
  const targets = {
    students: baseStudents + (STATE.name ? 1 : 0),
    chapters: baseChapters + completedCount,
    badges: baseBadges + completedCount
  };
  animateCounter('metric-students', targets.students);
  animateCounter('metric-chapters', targets.chapters);
  animateCounter('metric-badges', targets.badges);
}

function animateCounter(id, target) {
  const el = document.getElementById(id);
  if (!el) return;
  let current = 0;
  const step = Math.ceil(target / 40);
  const interval = setInterval(() => {
    current += step;
    if (current >= target) { current = target; clearInterval(interval); }
    el.textContent = current.toLocaleString();
  }, 30);
}

// ===== ENGAGEMENT SUMMARY POPUP =====
function showEngagementSummary() {
  const completedCount = Object.keys(STATE.completed).length;
  const streak = getStreak();
  const hours = Math.round((STATE.timeSpent + (Date.now() - STATE.sessionStart)) / 3600000 * 10) / 10;
  const level = getLevel();
  document.getElementById('engagement-stats').innerHTML = `
    <div class="engagement-stat"><div class="es-value">${completedCount}</div><div class="es-label">Chapters Done</div></div>
    <div class="engagement-stat"><div class="es-value">${streak}üî•</div><div class="es-label">Day Streak</div></div>
    <div class="engagement-stat"><div class="es-value">${hours}h</div><div class="es-label">Time Learning</div></div>
    <div class="engagement-stat"><div class="es-value">${level.icon} ${level.name}</div><div class="es-label">Current Level</div></div>
  `;
  document.getElementById('engagement-popup').classList.add('show');
}

function closeEngagementPopup() {
  document.getElementById('engagement-popup').classList.remove('show');
  localStorage.setItem('ngs_last_summary', Date.now());
}

// Show weekly summary if 7+ days since last
(function checkWeeklySummary() {
  const last = parseInt(localStorage.getItem('ngs_last_summary') || '0');
  if (STATE.name && Date.now() - last > 604800000 && Object.keys(STATE.completed).length > 0) {
    setTimeout(showEngagementSummary, 3000);
  }
})();

// ===== TIME TRACKING =====
window.addEventListener('beforeunload', () => {
  STATE.timeSpent += Date.now() - STATE.sessionStart;
  localStorage.setItem('ngs_time_spent', STATE.timeSpent);
});

// ===== INIT NEW FEATURES =====
// Animate metrics on landing
const metricsObserver = new IntersectionObserver((entries) => {
  entries.forEach(e => { if (e.isIntersecting) { animateMetrics(); metricsObserver.disconnect(); } });
});
const metricsSection = document.getElementById('metrics');
if (metricsSection) metricsObserver.observe(metricsSection);

// Track today
if (STATE.name) trackActiveDay();

// Render notifications
renderNotifications();

// Close notif panel on outside click
document.addEventListener('click', (e) => {
  if (!e.target.closest('.notif-bell') && !e.target.closest('.notif-panel')) {
    document.getElementById('notif-panel')?.classList.remove('show');
  }
});

// Initialize
updateProgress();

// ======================================================================
// STAGE 1: AUTH SYSTEM + DATABASE LAYER
// ======================================================================

const DB = {
  _get(key) { try { return JSON.parse(localStorage.getItem('ngs_db_' + key) || 'null'); } catch { return null; } },
  _set(key, val) { localStorage.setItem('ngs_db_' + key, JSON.stringify(val)); },
  
  // Users (parents)
  getUsers() { return this._get('users') || []; },
  saveUsers(u) { this._set('users', u); },
  addUser(user) { const u = this.getUsers(); user.id = 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); user.createdAt = new Date().toISOString(); u.push(user); this.saveUsers(u); return user; },
  getUserByEmail(email) { return this.getUsers().find(u => u.email === email); },
  
  // Children
  getChildren() { return this._get('children') || []; },
  saveChildren(c) { this._set('children', c); },
  addChild(child) { const c = this.getChildren(); child.id = 'ch_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); child.createdAt = new Date().toISOString(); c.push(child); this.saveChildren(c); return child; },
  getChildrenByParent(parentId) { return this.getChildren().filter(c => c.parentId === parentId); },
  getChildByPin(pin) { return this.getChildren().find(c => c.pin === pin); },
  
  // Purchases
  getPurchases() { return this._get('purchases') || []; },
  savePurchases(p) { this._set('purchases', p); },
  addPurchase(purchase) { const p = this.getPurchases(); purchase.id = 'pay_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); purchase.date = new Date().toISOString(); p.push(purchase); this.savePurchases(p); this.logEvent('purchase', purchase); return purchase; },
  getPurchasesByUser(userId) { return this.getPurchases().filter(p => p.userId === userId); },
  hasCourseAccess(userId, courseId) {
    const purchases = this.getPurchasesByUser(userId);
    return purchases.some(p => p.status === 'success' && (p.plan === 'fullAccess' || p.plan === 'familyPlan' || (p.plan === 'singleCourse' && p.courseId === courseId)));
  },
  
  // Progress (per-child)
  getProgress() { return this._get('progress') || {}; },
  saveProgress(p) { this._set('progress', p); },
  setChapterComplete(childId, courseId, chapterIdx) {
    const p = this.getProgress();
    if (!p[childId]) p[childId] = {};
    p[childId][`${courseId}_${chapterIdx}`] = { completedAt: new Date().toISOString() };
    this.saveProgress(p);
  },
  getChildProgress(childId) { return this.getProgress()[childId] || {}; },
  
  // Admin events log
  getEvents() { return this._get('events') || []; },
  logEvent(type, data) { const e = this.getEvents(); e.push({ type, data, ts: new Date().toISOString() }); if (e.length > 500) e.splice(0, e.length - 500); this._set('events', e); },
  
  // Settings
  getSettings() { return this._get('settings') || { demoMode: true, pricing: { singleCourse: 19, fullAccess: 39, familyPlan: 59 }, stripeKey: 'YOUR_STRIPE_KEY', razorpayKey: 'YOUR_RAZORPAY_KEY' }; },
  saveSettings(s) { this._set('settings', s); },
  
  // Seed data
  seed() {
    if (this._get('seeded')) return;
    const families = [
      { name: 'Sarah Johnson', email: 'sarah@demo.com', password: 'demo123', children: [{ name: 'Emma', age: 10, pin: '1234' }, { name: 'Liam', age: 12, pin: '5678' }] },
      { name: 'Priya Sharma', email: 'priya@demo.com', password: 'demo123', children: [{ name: 'Arjun', age: 11, pin: '1111' }, { name: 'Ananya', age: 9, pin: '2222' }] },
      { name: 'Mike Chen', email: 'mike@demo.com', password: 'demo123', children: [{ name: 'Lucas', age: 13, pin: '3333' }, { name: 'Mia', age: 10, pin: '4444' }] }
    ];
    families.forEach(f => {
      const parent = this.addUser({ name: f.name, email: f.email, password: f.password, role: 'parent' });
      f.children.forEach(ch => {
        const child = this.addChild({ name: ch.name, age: ch.age, pin: ch.pin, parentId: parent.id });
        // Add sample progress
        const courses = ['ai', 'space', 'robotics'];
        const rc = courses[Math.floor(Math.random() * 3)];
        const chapters = Math.floor(Math.random() * 4) + 1;
        for (let i = 0; i < chapters; i++) this.setChapterComplete(child.id, rc, i);
      });
      // Add sample purchase for first family
      if (f.email === 'sarah@demo.com') {
        this.addPurchase({ userId: parent.id, plan: 'fullAccess', amount: 39, currency: 'USD', status: 'success', method: 'stripe' });
      }
      if (f.email === 'priya@demo.com') {
        this.addPurchase({ userId: parent.id, plan: 'singleCourse', courseId: 'ai', amount: 19, currency: 'USD', status: 'success', method: 'razorpay' });
        this.addPurchase({ userId: parent.id, plan: 'singleCourse', courseId: 'space', amount: 19, currency: 'USD', status: 'failed', method: 'razorpay' });
      }
    });
    this._set('seeded', true);
  }
};

// Seed on first load
DB.seed();

// Session management
const Session = {
  get() { try { return JSON.parse(sessionStorage.getItem('ngs_session') || 'null'); } catch { return null; } },
  set(data) { sessionStorage.setItem('ngs_session', JSON.stringify(data)); },
  clear() { sessionStorage.removeItem('ngs_session'); },
  isLoggedIn() { return !!this.get(); },
  isParent() { const s = this.get(); return s && s.role === 'parent'; },
  isChild() { const s = this.get(); return s && s.role === 'child'; },
  userId() { const s = this.get(); return s ? s.id : null; },
  parentId() { const s = this.get(); if (!s) return null; return s.role === 'parent' ? s.id : s.parentId; }
};

// Auth functions
function openAuthModal(type) {
  closeAuthModal('signup'); closeAuthModal('login');
  document.getElementById(`auth-${type}-modal`).classList.add('show');
}
function closeAuthModal(type) {
  document.getElementById(`auth-${type}-modal`)?.classList.remove('show');
}

function doSignup() {
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value;
  const childName = document.getElementById('signup-child-name').value.trim();
  const childAge = parseInt(document.getElementById('signup-child-age').value);
  const childPin = document.getElementById('signup-child-pin').value;
  const errEl = document.getElementById('signup-error');
  
  errEl.style.display = 'none';
  if (!name || !email || !password) { errEl.textContent = 'Please fill in name, email, and password'; errEl.style.display = 'block'; return; }
  if (password.length < 6) { errEl.textContent = 'Password must be at least 6 characters'; errEl.style.display = 'block'; return; }
  if (DB.getUserByEmail(email)) { errEl.textContent = 'Email already registered. Try logging in.'; errEl.style.display = 'block'; return; }
  
  const parent = DB.addUser({ name, email, password, role: 'parent' });
  
  if (childName && childPin && childPin.length === 4) {
    DB.addChild({ name: childName, age: childAge || 10, pin: childPin, parentId: parent.id });
  }
  
  Session.set({ id: parent.id, name: parent.name, email: parent.email, role: 'parent' });
  DB.logEvent('signup', { userId: parent.id, email });
  closeAuthModal('signup');
  updateAuthUI();
  STATE.name = childName || name;
  STATE.parentEmail = email;
  save();
}

function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';
  
  const user = DB.getUserByEmail(email);
  if (!user || user.password !== password) { errEl.textContent = 'Invalid email or password'; errEl.style.display = 'block'; return; }
  
  Session.set({ id: user.id, name: user.name, email: user.email, role: 'parent' });
  DB.logEvent('login', { userId: user.id });
  closeAuthModal('login');
  updateAuthUI();
  STATE.parentEmail = email;
  save();
}

let currentPin = '';
function enterPin(n) {
  if (currentPin.length >= 4) return;
  currentPin += n;
  updatePinDots();
}
function clearPin() {
  currentPin = currentPin.slice(0, -1);
  updatePinDots();
}
function updatePinDots() {
  const dots = document.querySelectorAll('#pin-dots .pin-dot');
  dots.forEach((d, i) => d.classList.toggle('filled', i < currentPin.length));
}
function submitPin() {
  if (currentPin.length !== 4) return;
  const child = DB.getChildByPin(currentPin);
  const errEl = document.getElementById('login-error');
  if (!child) { errEl.textContent = 'Invalid PIN. Try again.'; errEl.style.display = 'block'; currentPin = ''; updatePinDots(); return; }
  
  Session.set({ id: child.id, name: child.name, role: 'child', parentId: child.parentId });
  DB.logEvent('child_login', { childId: child.id });
  closeAuthModal('login');
  updateAuthUI();
  STATE.name = child.name;
  save();
  currentPin = '';
  updatePinDots();
}

function switchLoginTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t, i) => t.classList.toggle('active', (tab === 'parent' ? i === 0 : i === 1)));
  document.getElementById('login-parent-form').style.display = tab === 'parent' ? 'block' : 'none';
  document.getElementById('login-child-form').style.display = tab === 'child' ? 'block' : 'none';
  document.getElementById('login-error').style.display = 'none';
}

function doLogout() {
  Session.clear();
  updateAuthUI();
}

function updateAuthUI() {
  // Add auth buttons to hero if not present
  const hero = document.querySelector('.hero-content');
  let authBar = document.getElementById('auth-bar');
  if (!authBar) {
    authBar = document.createElement('div');
    authBar.id = 'auth-bar';
    authBar.style.cssText = 'position:fixed;top:16px;right:20px;z-index:1000;display:flex;gap:8px;align-items:center';
    document.body.appendChild(authBar);
  }
  
  const session = Session.get();
  const settings = DB.getSettings();
  
  if (session) {
    const initial = session.name ? session.name[0].toUpperCase() : '?';
    authBar.innerHTML = `
      ${settings.demoMode ? '<span class="demo-badge">DEMO MODE</span>' : ''}
      <div class="user-menu" onclick="this.querySelector(\'.user-dropdown\').classList.toggle(\'show\')">
        <div class="user-avatar">${initial}</div>
        <span style="color:var(--text);font-size:.9rem">${session.name}</span>
        <div class="user-dropdown">
          <a onclick="event.stopPropagation()">üë§ ${session.role === 'parent' ? 'Parent' : 'Child'} Account</a>
          ${session.role === 'parent' ? '<a onclick="showParentDashboard();event.stopPropagation()">üìä Dashboard</a>' : ''}
          <a onclick="doLogout();event.stopPropagation()">üö™ Log Out</a>
        </div>
      </div>`;
  } else {
    authBar.innerHTML = `
      ${settings.demoMode ? '<span class="demo-badge">DEMO MODE</span>' : ''}
      <button class="btn btn-back" onclick="openAuthModal('login')" style="padding:8px 16px;font-size:.85rem">Log In</button>
      <button class="btn btn-primary" onclick="openAuthModal('signup')" style="padding:8px 16px;font-size:.85rem">Sign Up</button>`;
  }
}

// Close dropdowns on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('.user-menu')) document.querySelectorAll('.user-dropdown').forEach(d => d.classList.remove('show'));
});

// ======================================================================
// STAGE 2: PAYMENT FLOW (Enhanced)
// ======================================================================

// Override handlePayment with auth-aware version
handlePayment = function(plan, courseId) {
  const settings = DB.getSettings();
  
  // Demo mode: instant access
  if (settings.demoMode) {
    const userId = Session.parentId() || 'demo_user';
    DB.addPurchase({ userId, plan, courseId: courseId || STATE.currentCourse, amount: settings.pricing[plan] || 0, currency: 'USD', status: 'success', method: 'demo' });
    // Update legacy STATE.purchases too
    if (plan === 'fullAccess' || plan === 'familyPlan') { STATE.purchases.fullAccess = true; }
    else if (plan === 'singleCourse') { STATE.purchases[courseId || STATE.currentCourse] = true; }
    save();
    addNotification('üéâ', 'Access granted (Demo Mode)! All chapters unlocked.');
    if (STATE.currentCourse) { renderSidebar(); loadChapter(STATE.currentChapter); }
    return;
  }
  
  // Stripe
  if (settings.stripeKey && !settings.stripeKey.startsWith('YOUR_')) {
    try {
      const stripe = Stripe(settings.stripeKey);
      stripe.redirectToCheckout({
        lineItems: [{ price: PAYMENT_CONFIG.prices[plan], quantity: 1 }],
        mode: 'payment',
        successUrl: window.location.href.split('?')[0] + '?payment=success&plan=' + plan + '&course=' + (courseId || ''),
        cancelUrl: window.location.href.split('?')[0]
      });
      return;
    } catch(e) { console.log('Stripe error:', e); }
  }
  
  // Razorpay
  if (settings.razorpayKey && !settings.razorpayKey.startsWith('YOUR_') && typeof Razorpay !== 'undefined') {
    const amount = (settings.pricing[plan] || 19) * 100;
    const rzp = new Razorpay({
      key: settings.razorpayKey,
      amount,
      currency: 'INR',
      name: 'NextGen School',
      description: plan === 'singleCourse' ? 'Single Course' : plan === 'fullAccess' ? 'Full Access' : 'Family Plan',
      handler: function(response) {
        const userId = Session.parentId() || 'demo_user';
        DB.addPurchase({ userId, plan, courseId: courseId || STATE.currentCourse, amount: amount/100, currency: 'INR', status: 'success', method: 'razorpay', txnId: response.razorpay_payment_id });
        if (plan === 'fullAccess' || plan === 'familyPlan') STATE.purchases.fullAccess = true;
        else STATE.purchases[courseId || STATE.currentCourse] = true;
        save();
        addNotification('üéâ', 'Payment successful!');
        if (STATE.currentCourse) { renderSidebar(); loadChapter(STATE.currentChapter); }
      }
    });
    rzp.open();
    return;
  }
  
  // Fallback: email
  const msg = `Hi! I'd like to purchase the ${plan === 'singleCourse' ? 'Single Course ($19)' : plan === 'fullAccess' ? 'Full Access Bundle ($39)' : 'Family Plan ($59)'} for NextGen School.`;
  window.open(`mailto:hello@nextgenschool.aiupskills.com?subject=NextGen School Purchase&body=${encodeURIComponent(msg)}`);
};

// ======================================================================
// STAGE 3: ACCESS CONTROL (Enhanced with DB)
// ======================================================================

// Enhance isChapterUnlocked to check DB purchases
if (typeof isChapterUnlocked === 'undefined') {
  // Define if not already present
  window.isChapterUnlocked = function(courseId, chapterIdx) {
    if (chapterIdx === 0) return true; // Ch1 always free
    const settings = DB.getSettings();
    if (settings.demoMode) {
      // In demo mode, check if user has a purchase or legacy STATE
      const userId = Session.parentId();
      if (userId && DB.hasCourseAccess(userId, courseId)) return true;
    }
    // Check legacy STATE
    if (STATE.purchases.fullAccess || STATE.purchases[courseId]) return true;
    // Check DB
    const userId = Session.parentId();
    if (userId && DB.hasCourseAccess(userId, courseId)) return true;
    return false;
  };
} else {
  const _origIsUnlocked = isChapterUnlocked;
  isChapterUnlocked = function(courseId, chapterIdx) {
    if (_origIsUnlocked(courseId, chapterIdx)) return true;
    const userId = Session.parentId();
    if (userId && DB.hasCourseAccess(userId, courseId)) return true;
    return false;
  };
}

// Certificate generation with jsPDF
function generateCertificate(courseTitle) {
  const name = STATE.name || Session.get()?.name || 'Student';
  const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  
  if (typeof jspdf !== 'undefined' && jspdf.jsPDF) {
    const doc = new jspdf.jsPDF('landscape');
    doc.setFillColor(10, 10, 46);
    doc.rect(0, 0, 297, 210, 'F');
    
    // Border
    doc.setDrawColor(6, 182, 212);
    doc.setLineWidth(3);
    doc.rect(10, 10, 277, 190, 'S');
    doc.setDrawColor(139, 92, 246);
    doc.setLineWidth(1);
    doc.rect(15, 15, 267, 180, 'S');
    
    doc.setTextColor(251, 191, 36);
    doc.setFontSize(36);
    doc.text('Certificate of Completion', 148.5, 50, { align: 'center' });
    
    doc.setTextColor(226, 232, 240);
    doc.setFontSize(16);
    doc.text('This certifies that', 148.5, 75, { align: 'center' });
    
    doc.setTextColor(6, 182, 212);
    doc.setFontSize(28);
    doc.text(name, 148.5, 95, { align: 'center' });
    
    doc.setTextColor(226, 232, 240);
    doc.setFontSize(16);
    doc.text('has successfully completed', 148.5, 115, { align: 'center' });
    
    doc.setTextColor(139, 92, 246);
    doc.setFontSize(22);
    doc.text(courseTitle, 148.5, 135, { align: 'center' });
    
    doc.setTextColor(226, 232, 240);
    doc.setFontSize(14);
    doc.text('at NextGen School ‚Äî Mind Over Machines', 148.5, 155, { align: 'center' });
    
    doc.setTextColor(148, 163, 184);
    doc.setFontSize(12);
    doc.text(date, 148.5, 175, { align: 'center' });
    
    doc.save(`NextGenSchool_Certificate_${name.replace(/\s/g,'_')}.pdf`);
  } else {
    // HTML fallback
    const w = window.open('', '_blank');
    w.document.write(`<!DOCTYPE html><html><head><title>Certificate</title><style>
      body{margin:0;display:flex;align-items:center;justify-content:center;min-height:100vh;background:#0a0a2e;font-family:Georgia,serif}
      .cert{background:#050510;border:3px solid #06b6d4;padding:60px;text-align:center;max-width:800px;position:relative}
      .cert::after{content:'';position:absolute;inset:8px;border:1px solid #8b5cf6;pointer-events:none}
      h1{color:#fbbf24;font-size:2.5rem;margin-bottom:20px}
      h2{color:#06b6d4;font-size:2rem;margin:10px 0}
      p{color:#e2e8f0;font-size:1.1rem;margin:8px 0}
      .course{color:#8b5cf6;font-size:1.5rem;margin:10px 0}
      .date{color:#94a3b8;margin-top:30px}
      button{margin-top:20px;padding:12px 30px;background:#06b6d4;color:#000;border:none;border-radius:8px;font-size:1rem;cursor:pointer}
    </style></head><body><div class="cert">
      <h1>üèÜ Certificate of Completion</h1>
      <p>This certifies that</p><h2>${name}</h2>
      <p>has successfully completed</p><div class="course">${courseTitle}</div>
      <p>at NextGen School ‚Äî Mind Over Machines</p>
      <div class="date">${date}</div>
      <button onclick="window.print()">üñ®Ô∏è Print Certificate</button>
    </div></body></html>`);
  }
}

// ======================================================================
// STAGE 4: ADMIN PANEL
// ======================================================================

let logoClickCount = 0;
let logoClickTimer = null;
document.addEventListener('click', e => {
  if (e.target.closest('.hero-content h1') || e.target.closest('#course-title')) {
    logoClickCount++;
    clearTimeout(logoClickTimer);
    logoClickTimer = setTimeout(() => logoClickCount = 0, 2000);
    if (logoClickCount >= 5) { logoClickCount = 0; showAdmin(); }
  }
});

// Hash routing for admin
window.addEventListener('hashchange', () => {
  if (location.hash === '#admin') showAdmin();
});
// Check on load AND after DOMContentLoaded
if (location.hash === '#admin') setTimeout(showAdmin, 500);
document.addEventListener('DOMContentLoaded', () => {
  if (location.hash === '#admin') setTimeout(showAdmin, 800);
});
// Direct URL: add ?admin=true support
if (location.search.includes('admin=true')) setTimeout(showAdmin, 500);

function showAdmin() {
  document.getElementById('landing').style.display = 'none';
  document.getElementById('course-view').style.display = 'none';
  document.getElementById('badge-gallery').style.display = 'none';
  document.getElementById('parent-dashboard').style.display = 'none';
  document.getElementById('admin-panel').style.display = 'block';
  window.scrollTo(0, 0);
}

function adminPasswordCheck() {
  const pw = document.getElementById('admin-pw-input').value;
  if (pw === 'admin123') {
    document.getElementById('admin-password-gate').style.display = 'none';
    document.getElementById('admin-content').style.display = 'block';
    showAdminTab('dashboard');
  } else {
    alert('Invalid password');
  }
}

function showAdminTab(tab) {
  try {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    if(event?.target) event.target.classList.add('active');
    else document.querySelector('.admin-tab[onclick*="' + tab + '"]')?.classList.add('active');
    const content = document.getElementById('admin-tab-content');
    
    const users = DB.getUsers() || [];
    const children = DB.getChildren() || [];
    const purchases = DB.getPurchases() || [];
    const progress = DB.getProgress() || {};
    const settings = DB.getSettings() || {};
    
    switch(tab) {
      case 'dashboard': renderAdminDashboard(content, users, children, purchases, progress); break;
      case 'enrollments': renderAdminEnrollments(content, users, children); break;
      case 'payments': renderAdminPayments(content, purchases); break;
      case 'analytics': renderAdminAnalytics(content, progress, purchases); break;
      case 'students': renderAdminStudents(content, children, progress); break;
      case 'settings': renderAdminSettings(content, settings); break;
    }
  } catch(e) { 
    console.error('Admin tab error:', e);
    document.getElementById('admin-tab-content').innerHTML = '<div style="padding:40px;text-align:center"><h3>‚ö†Ô∏è Error loading tab</h3><p style="color:var(--text2)">' + e.message + '</p><button class="btn btn-primary" onclick="showAdminTab('' + tab + '')">Retry</button></div>';
  }
}

function renderAdminDashboard(el, users, children, purchases, progress) {
  const revenue = purchases.filter(p => p.status === 'success').reduce((s, p) => s + (p.amount || 0), 0);
  const failed = purchases.filter(p => p.status === 'failed').length;
  let totalChaptersDone = 0; try { totalChaptersDone = Object.values(progress).reduce((s, p) => s + Object.keys(p).length, 0); } catch(e) { totalChaptersDone = 0; }
  
  el.innerHTML = `
    <div class="admin-grid">
      <div class="admin-stat"><div class="as-value" style="color:var(--cyan)">${users.length}</div><div class="as-label">Families</div></div>
      <div class="admin-stat"><div class="as-value" style="color:var(--purple)">${children.length}</div><div class="as-label">Children</div></div>
      <div class="admin-stat"><div class="as-value" style="color:var(--green)">$${revenue}</div><div class="as-label">Revenue</div></div>
      <div class="admin-stat"><div class="as-value" style="color:var(--gold)">${purchases.length}</div><div class="as-label">Transactions</div></div>
      <div class="admin-stat"><div class="as-value" style="color:var(--pink)">${totalChaptersDone}</div><div class="as-label">Chapters Done</div></div>
      <div class="admin-stat"><div class="as-value" style="color:var(--red)">${failed}</div><div class="as-label">Failed Payments</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="admin-chart-wrap"><canvas id="chart-revenue"></canvas></div>
      <div class="admin-chart-wrap"><canvas id="chart-enrollments"></canvas></div>
    </div>
    <div class="admin-chart-wrap"><canvas id="chart-courses"></canvas></div>`;
  
  // Revenue chart
  if (typeof Chart !== 'undefined') {
    const last7 = Array.from({length: 7}, (_, i) => {
      const d = new Date(); d.setDate(d.getDate() - (6 - i));
      return d.toISOString().split('T')[0];
    });
    const revenueByDay = last7.map(day => purchases.filter(p => p.status === 'success' && p.date?.startsWith(day)).reduce((s, p) => s + (p.amount || 0), 0));
    
    new Chart(document.getElementById('chart-revenue'), {
      type: 'bar',
      data: { labels: last7.map(d => d.slice(5)), datasets: [{ label: 'Revenue ($)', data: revenueByDay, backgroundColor: 'rgba(6,182,212,0.5)', borderColor: '#06b6d4', borderWidth: 1 }] },
      options: { responsive: true, plugins: { title: { display: true, text: 'Revenue (Last 7 Days)', color: '#e2e8f0' }, legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } } } }
    });
    
    // Enrollments chart
    const enrollByDay = last7.map(day => users.filter(u => u.createdAt?.startsWith(day)).length);
    new Chart(document.getElementById('chart-enrollments'), {
      type: 'line',
      data: { labels: last7.map(d => d.slice(5)), datasets: [{ label: 'New Families', data: enrollByDay, borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', fill: true, tension: 0.3 }] },
      options: { responsive: true, plugins: { title: { display: true, text: 'Enrollments (Last 7 Days)', color: '#e2e8f0' }, legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#94a3b8', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } } } }
    });
    
    // Course completion chart
    const courseNames = ['AI Adventures', 'Space Explorers', 'Robotics Lab'];
    const courseIds = ['ai', 'space', 'robotics'];
    const completionRates = courseIds.map(cid => {
      let total = 0, done = 0;
      Object.values(progress).forEach(p => {
        for (let i = 0; i < 8; i++) { total++; if (p[`${cid}_${i}`]) done++; }
      });
      return total > 0 ? Math.round(done / total * 100) : 0;
    });
    new Chart(document.getElementById('chart-courses'), {
      type: 'doughnut',
      data: { labels: courseNames, datasets: [{ data: completionRates, backgroundColor: ['#06b6d4', '#8b5cf6', '#ec4899'] }] },
      options: { responsive: true, plugins: { title: { display: true, text: 'Course Completion %', color: '#e2e8f0' } } }
    });
  }
}

function renderAdminEnrollments(el, users, children) {
  el.innerHTML = `
    <input class="admin-search" id="enroll-search" placeholder="Search families..." oninput="filterEnrollTable()">
    <div style="overflow-x:auto">
    <table class="admin-table" id="enroll-table">
      <thead><tr><th>Parent</th><th>Email</th><th>Children</th><th>Joined</th></tr></thead>
      <tbody>${users.map(u => {
        const kids = children.filter(c => c.parentId === u.id);
        return `<tr><td>${u.name}</td><td>${u.email}</td><td>${kids.map(k => `${k.name} (${k.age})`).join(', ') || '‚Äî'}</td><td>${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '‚Äî'}</td></tr>`;
      }).join('')}</tbody>
    </table></div>`;
}

window.filterEnrollTable = function() {
  const q = document.getElementById('enroll-search').value.toLowerCase();
  document.querySelectorAll('#enroll-table tbody tr').forEach(r => {
    r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
};

function renderAdminPayments(el, purchases) {
  const failed = purchases.filter(p => p.status === 'failed');
  el.innerHTML = `
    ${failed.length ? `<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:16px;margin-bottom:16px;color:var(--red)">‚ö†Ô∏è ${failed.length} failed payment(s) require attention</div>` : ''}
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
      <button class="admin-tab active" onclick="filterPayments('all',this)">All (${purchases.length})</button>
      <button class="admin-tab" onclick="filterPayments('success',this)">‚úÖ Success (${purchases.filter(p=>p.status==='success').length})</button>
      <button class="admin-tab" onclick="filterPayments('failed',this)">‚ùå Failed (${failed.length})</button>
      <button class="admin-tab" onclick="filterPayments('demo',this)">üéÆ Demo (${purchases.filter(p=>p.method==='demo').length})</button>
    </div>
    <div style="overflow-x:auto">
    <table class="admin-table" id="payments-table">
      <thead><tr><th>ID</th><th>Plan</th><th>Amount</th><th>Method</th><th>Status</th><th>Date</th></tr></thead>
      <tbody>${purchases.map(p => `<tr data-status="${p.status}" data-method="${p.method}">
        <td style="font-size:.8rem;color:var(--text3)">${p.id?.slice(0,12) || '‚Äî'}</td>
        <td>${p.plan}</td>
        <td>$${p.amount || 0}</td>
        <td>${p.method || '‚Äî'}</td>
        <td><span class="status-badge ${p.status === 'success' ? 'status-success' : p.status === 'failed' ? 'status-failed' : 'status-demo'}">${p.status}</span></td>
        <td>${p.date ? new Date(p.date).toLocaleDateString() : '‚Äî'}</td>
      </tr>`).join('')}</tbody>
    </table></div>`;
}

window.filterPayments = function(status, btn) {
  btn?.parentElement.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  btn?.classList.add('active');
  document.querySelectorAll('#payments-table tbody tr').forEach(r => {
    if (status === 'all') { r.style.display = ''; return; }
    if (status === 'demo') { r.style.display = r.dataset.method === 'demo' ? '' : 'none'; return; }
    r.style.display = r.dataset.status === status ? '' : 'none';
  });
};

function renderAdminAnalytics(el, progress, purchases) {
  const courseIds = ['ai', 'space', 'robotics'];
  const courseNames = { ai: 'ü§ñ AI Adventures', space: 'üöÄ Space Explorers', robotics: 'üîß Robotics Lab' };
  
  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px">';
  courseIds.forEach(cid => {
    let chapterCounts = Array(8).fill(0);
    let totalStudents = 0;
    Object.values(progress).forEach(p => {
      let touched = false;
      for (let i = 0; i < 8; i++) { if (p[`${cid}_${i}`]) { chapterCounts[i]++; touched = true; } }
      if (touched) totalStudents++;
    });
    
    html += `<div class="admin-chart-wrap">
      <h4 style="margin-bottom:12px">${courseNames[cid]}</h4>
      <p style="font-size:.85rem;color:var(--text2)">${totalStudents} students enrolled</p>
      <canvas id="chart-${cid}"></canvas>
    </div>`;
  });
  html += '</div>';
  el.innerHTML = html;
  
  if (typeof Chart !== 'undefined') {
    courseIds.forEach(cid => {
      let chapterCounts = Array(8).fill(0);
      Object.values(progress).forEach(p => {
        for (let i = 0; i < 8; i++) { if (p[`${cid}_${i}`]) chapterCounts[i]++; }
      });
      new Chart(document.getElementById(`chart-${cid}`), {
        type: 'bar',
        data: { labels: Array.from({length:8},(_,i)=>`Ch ${i+1}`), datasets: [{ label: 'Completions', data: chapterCounts, backgroundColor: cid === 'ai' ? '#06b6d4' : cid === 'space' ? '#8b5cf6' : '#ec4899' }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#94a3b8', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } } } }
      });
    });
  }
}

function renderAdminStudents(el, children, progress) {
  if (!children.length) { el.innerHTML = '<p style="text-align:center;color:var(--text2);padding:40px">No students yet</p>'; return; }
  
  let html = '<div style="display:grid;gap:16px">';
  children.forEach(child => {
    const cp = progress[child.id] || {};
    const completedKeys = Object.keys(cp);
    const totalDone = completedKeys.length;
    const parent = DB.getUsers().find(u => u.id === child.parentId);
    
    let courseProgress = '';
    ['ai', 'space', 'robotics'].forEach(cid => {
      let done = 0;
      for (let i = 0; i < 8; i++) { if (cp[`${cid}_${i}`]) done++; }
      if (done > 0) {
        const pct = Math.round(done / 8 * 100);
        courseProgress += `<div style="margin:4px 0"><span style="font-size:.85rem">${COURSES[cid].title}</span> <span style="color:var(--text3);font-size:.8rem">${done}/8 (${pct}%)</span><div class="progress-bar" style="max-width:100%;height:6px;margin-top:2px"><div class="progress-fill" style="width:${pct}%"></div></div></div>`;
      }
    });
    
    html += `<div class="glass" style="padding:20px;border-radius:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div><h4>${child.name}</h4><span style="font-size:.85rem;color:var(--text2)">Age ${child.age} ‚Ä¢ Parent: ${parent?.name || 'Unknown'}</span></div>
        <div style="text-align:right"><div style="font-size:1.5rem;font-weight:700;color:var(--cyan)">${totalDone}</div><div style="font-size:.75rem;color:var(--text3)">chapters done</div></div>
      </div>
      ${courseProgress || '<p style="color:var(--text3);font-size:.85rem">No progress yet</p>'}
    </div>`;
  });
  html += '</div>';
  el.innerHTML = html;
}

function renderAdminSettings(el, settings) {
  el.innerHTML = `<div class="admin-settings" style="max-width:500px">
    <h3 style="margin-bottom:20px">‚öôÔ∏è Platform Settings</h3>
    
    <div class="glass" style="padding:20px;border-radius:16px;margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><h4>üéÆ Demo Mode</h4><p style="font-size:.85rem;color:var(--text2)">Bypass payment ‚Äî grant instant access</p></div>
        <label style="cursor:pointer"><input type="checkbox" id="setting-demo" ${settings.demoMode ? 'checked' : ''} onchange="toggleDemoMode(this.checked)" style="width:20px;height:20px"></label>
      </div>
    </div>
    
    <h4 style="margin:16px 0 8px">üí∞ Pricing</h4>
    <label>Single Course ($)</label>
    <input class="auth-input" id="setting-price-single" type="number" value="${settings.pricing.singleCourse}">
    <label>Full Access ($)</label>
    <input class="auth-input" id="setting-price-full" type="number" value="${settings.pricing.fullAccess}">
    <label>Family Plan ($)</label>
    <input class="auth-input" id="setting-price-family" type="number" value="${settings.pricing.familyPlan}">
    
    <h4 style="margin:16px 0 8px">üîë Payment Keys</h4>
    <label>Stripe Public Key</label>
    <input class="auth-input" id="setting-stripe" value="${settings.stripeKey}">
    <label>Razorpay Key ID</label>
    <input class="auth-input" id="setting-razorpay" value="${settings.razorpayKey}">
    
    <button class="btn btn-primary" onclick="saveAdminSettings()" style="width:100%;margin-top:8px">Save Settings</button>
    
    <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--glass-border)">
      <h4 style="color:var(--red);margin-bottom:8px">‚ö†Ô∏è Danger Zone</h4>
      <button class="btn btn-back" onclick="if(confirm('Reset all demo data?')){localStorage.removeItem('ngs_db_seeded');DB.seed();showAdminTab('dashboard');}" style="border-color:var(--red);color:var(--red)">Reset Seed Data</button>
    </div>
  </div>`;
}

window.toggleDemoMode = function(on) {
  const s = DB.getSettings(); s.demoMode = on; DB.saveSettings(s);
  updateAuthUI();
};

window.saveAdminSettings = function() {
  const s = DB.getSettings();
  s.pricing.singleCourse = parseInt(document.getElementById('setting-price-single').value) || 19;
  s.pricing.fullAccess = parseInt(document.getElementById('setting-price-full').value) || 39;
  s.pricing.familyPlan = parseInt(document.getElementById('setting-price-family').value) || 59;
  s.stripeKey = document.getElementById('setting-stripe').value || 'YOUR_STRIPE_KEY';
  s.razorpayKey = document.getElementById('setting-razorpay').value || 'YOUR_RAZORPAY_KEY';
  DB.saveSettings(s);
  alert('Settings saved!');
};

function adminExportCSV() {
  const users = DB.getUsers();
  const children = DB.getChildren();
  const purchases = DB.getPurchases();
  
  let csv = 'Type,Name,Email,Children,Plan,Amount,Status,Date\n';
  users.forEach(u => {
    const kids = children.filter(c => c.parentId === u.id).map(k => k.name).join('; ');
    const userPurchases = purchases.filter(p => p.userId === u.id);
    if (userPurchases.length) {
      userPurchases.forEach(p => {
        csv += `Parent,"${u.name}","${u.email}","${kids}",${p.plan},$${p.amount},${p.status},${p.date?.split('T')[0] || ''}\n`;
      });
    } else {
      csv += `Parent,"${u.name}","${u.email}","${kids}",‚Äî,‚Äî,‚Äî,${u.createdAt?.split('T')[0] || ''}\n`;
    }
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `nextgen-school-export-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
}

// ======================================================================
// STAGE 5: WIRE IT TOGETHER
// ======================================================================

// Sync chapter completion with DB progress
const _origComplete2 = completeChapter;
completeChapter = function() {
  _origComplete2();
  const childId = Session.isChild() ? Session.userId() : null;
  if (childId && STATE.currentCourse !== null) {
    DB.setChapterComplete(childId, STATE.currentCourse, STATE.currentChapter);
  }
};

// Initialize auth UI
updateAuthUI();

// Restore session
(function restoreSession() {
  const session = Session.get();
  if (session) {
    if (session.name && !STATE.name) { STATE.name = session.name; save(); }
  }
})();

</script>
</body>
</html>